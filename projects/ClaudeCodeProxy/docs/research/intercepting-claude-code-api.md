**ChatGPT:**

# Intercepting Claude Code API Calls – Version, MITM Solutions, Legalities, and Usage

## Claude Code 2.0.14+ – Proxy Support and Behavior

The **Claude Code CLI** (Anthropic’s official terminal-based assistant) is currently at version **2.0.14** (with newer minor releases in the 2.x series). This latest stable release fully supports routing network requests through HTTP/HTTPS proxies via standard environment variables[docs.claude.com](https://docs.claude.com/en/docs/claude-code/network-config#:~:text=Claude%20Code%20respects%20standard%20proxy,environment%20variables). In particular, you can set `HTTPS_PROXY` (or `HTTP_PROXY`) to direct the CLI’s API calls through a proxy server[docs.claude.com](https://docs.claude.com/en/docs/claude-code/network-config#:~:text=Claude%20Code%20respects%20standard%20proxy,environment%20variables). (Note that SOCKS proxies are **not** supported by Claude Code[docs.claude.com](https://docs.claude.com/en/docs/claude-code/network-config#:~:text=Claude%20Code%20does%20not%20support,SOCKS%20proxies).)

Earlier versions had some hiccups with proxy handling – for example, version 1.0.93 introduced an issue where the new Node HTTP client (Undici) didn’t respect the proxy env vars, whereas 1.0.92 worked fine. This was identified as a bug and subsequently fixed in the 2.x updates. As of v2.0.14+, those issues are resolved. In fact, Anthropic’s changelogs show continued improvements: even internal telemetry (OTEL) data now honors the `HTTP_PROXY`/`HTTPS_PROXY` settings[releasebot.io](https://releasebot.io/updates/anthropic#:~:text=,source%20%20Report%20a%20problem). In short, **Claude Code 2.0.14+ reliably respects your proxy configuration** for outbound API calls. No special downgrades or old-version tweaks are needed – stick to the latest release for best results.

## MITM Proxy Solutions – _mitmproxy_ vs. Custom Node Proxy

To capture the Claude Code CLI’s API traffic (including auth headers and JSON payloads), we evaluated two man-in-the-middle approaches:

* **Using mitmproxy (standard intercepting proxy):** This is a proven industry tool for HTTP(S) traffic. Claude Code can be pointed at mitmproxy by setting the `HTTPS_PROXY` env var to your local proxy address. Because Claude’s API calls are over HTTPS, you’ll also need to trust the mitmproxy CA certificate (Claude Code supports custom CAs via Node’s `NODE_EXTRA_CA_CERTS` env variable if needed[docs.claude.com](https://docs.claude.com/en/docs/claude-code/network-config#:~:text=Custom%20CA%20certificates)). In practice, **mitmproxy works effectively** – community users have successfully intercepted Claude Code’s requests using it. For example, one user reported they “managed to proxy Claude-Code requests (using mitmproxy)” and could inspect the traffic[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1lnuxbj/i_created_a_proxy_that_captures_and_visualizes/#:~:text=I%27ve%20also%20managed%20to%20get,but%20oh%20well). Once the TLS is handled, **all request details are visible in plaintext**. This includes the JSON request/response bodies (e.g. prompts, system messages) and the authorization header. In fact, another user confirmed _“you can see the entire interaction”_ via the proxy – nothing is additionally encrypted beyond normal TLS[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1lnuxbj/i_created_a_proxy_that_captures_and_visualizes/#:~:text=Whoa%20so%20the%20texts%20is,get%20the%20system%20prompt%20then). Crucially, the **auth token** is captured in the HTTP headers. The Claude CLI sends its API key or OAuth token in an HTTP header on each request, and the MITM proxy will log this. As one developer noted, _“the intercepted Claude Code request… includes the auth key in its header”_, so the proxy itself didn’t need any special credentials[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1lnuxbj/i_created_a_proxy_that_captures_and_visualizes/#:~:text=%E2%80%A2%20%203mo%20ago). In summary, mitmproxy can **reliably capture both the auth headers and JSON bodies** of Claude’s API calls, with only a few edge-case hiccups reported (e.g. some “context overload” error calls might not proxy perfectly[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1lnuxbj/i_created_a_proxy_that_captures_and_visualizes/#:~:text=I%27ve%20also%20managed%20to%20get,but%20oh%20well), but ordinary interactions proxy smoothly).
    
* **Using a custom Node.js proxy:** Building a lightweight Node proxy is also a viable route – and it’s essentially what we’d do for a tailored solution. In this approach, you could either run a local HTTP(S) proxy or override Claude’s API base URL to point at your Node service. The Claude Code CLI is configurable via `ANTHROPIC_BASE_URL` (as seen in the Z.ai integration)[docs.z.ai](https://docs.z.ai/devpack/tool/claude#:~:text=,%7D), meaning you can direct it to send requests to `http://localhost:<port>` where your Node proxy listens, and then have the proxy forward to the real API. This proxy would accept Claude’s incoming HTTP requests, log/inspect the headers and body, then perform the actual call to Anthropic (or Z.ai) and relay back the response. **Capturing auth headers and JSON payloads in a Node proxy is straightforward** – since the CLI already attaches the credentials and JSON content, our proxy just needs to read them from the incoming request object. In fact, several open-source projects demonstrate this: e.g. _Claude Code Proxy_ tools that translate Claude’s API calls to other providers rely on intercepting the full request details (including auth)[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1lnuxbj/i_created_a_proxy_that_captures_and_visualizes/#:~:text=%E2%80%A2%20%203mo%20ago). One developer built a proxy to use Claude Code with custom models and noted it only took an env var change to have Claude Code send requests to the proxy[news.ycombinator.com](https://news.ycombinator.com/item?id=44647985#:~:text=What%20it%20does). This confirms that a Node proxy can seamlessly sit in the middle. The key considerations are similar to mitmproxy – handling TLS (either by having the CLI talk HTTP to the proxy or installing a certificate) and parsing streaming responses if any. But overall, **a Node.js custom proxy can just as reliably capture the Authorization header and JSON body**. It essentially replicates what mitmproxy does, but gives us full control to modify or log data as needed. Community feedback supports this: for instance, users have extended a Claude Code Node proxy to handle different auth header formats (Claude’s “Max” subscription uses slightly different headers) via simple code changes[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1lnuxbj/i_created_a_proxy_that_captures_and_visualizes/#:~:text=%E2%80%A2%20%203mo%20ago). This shows the flexibility of a custom proxy in adapting to vendor-specific auth schemes.
    

**Reliability:** Both approaches are feasible and have been tested. Mitmproxy is quick to deploy and already handles low-level details (certs, CONNECT tunneling, etc.), making it easy to inspect requests out-of-the-box. A custom Node proxy requires a bit more setup but can be integrated into our codebase and tailored (e.g. filtering or transforming requests). Given that Claude Code honors system proxy settings and uses standard HTTP over TLS, **neither method is blocked by Claude** – there’s no certificate pinning or extra encryption to worry about. The choice comes down to convenience vs. customization. For initial testing, mitmproxy offers a simple way to confirm we can grab the `Authorization` header and JSON content. For a long-term solution, implementing our own Node proxy would allow integrating any logic we need while still capturing the same data.

## Legal/Policy Considerations – Token Capture & Routing

We must examine whether intercepting and reusing the Claude auth tokens (from Anthropic or Z.ai) could violate any terms of service or usage policies of the vendors:

* **Anthropic (Claude) Policies:** If you are using Claude via the **consumer subscription/OAuth login**, be aware that Anthropic’s **Consumer Terms of Service** forbid certain misuse of credentials and unofficial automation. Specifically, _“You may not share your Account login information, Anthropic API key, or Account credentials with anyone else”_[anthropic.com](https://www.anthropic.com/legal/consumer-terms#:~:text=requirements%20for%20legal%20notices). Capturing your own token for personal use isn’t “sharing” per se, but you must keep it secret and not give it to others. More importantly, the terms state that **unless you’re using an official API key**, you should not access the services through automated means (bots, scripts) without explicit permission[anthropic.com](https://www.anthropic.com/legal/consumer-terms#:~:text=6,any%20type%2C%20including%20reputational%20harms). In other words, a user-level Claude account (Pro/Max) is meant for interactive use (Claude’s web, apps, or CLI), and Anthropic discourages “replay” of that token in custom code or bypassing their client. Using the Claude Code CLI itself is within allowed usage, but if one were to take the captured OAuth token and directly call the API with a separate script, that likely violates the “no non-human access outside of API keys” clause[anthropic.com](https://www.anthropic.com/legal/consumer-terms#:~:text=6,any%20type%2C%20including%20reputational%20harms). For those with **Anthropic API keys** (the developer/commercial API), the **Commercial Terms** would apply instead – typically, they also require keeping keys confidential and not exposing them publicly. Best practice (and likely Anthropic’s expectation) is _not_ to expose or hardcode your API key, and not to circumvent any security measures. In summary, **capturing the token for debugging your own requests is not explicitly prohibited**, but using it in unintended ways or distributing it would be. We’re staying within the spirit of the rules by intercepting calls made by an authorized client (the CLI) on our own account. We should just ensure the token remains secure and that our usage of it still abides by Anthropic’s usage policies (e.g. content rules, rate limits, etc.).
    
* **Z.AI (Third-Party API) Policies:** **Z.ai** appears to be a service that provides API access (possibly proxying Anthropic models and others) via its own API key system. Their terms of use similarly emphasize **keeping API keys confidential**: _“Keep your created key(s) securely, prevent any form of leakage, do not share or publicly disclose your key(s) with others”_[chat.z.ai](https://chat.z.ai/legal-agreement/terms-of-service#:~:text=log%20into%20our%20Services%20using,your%20account). If we configure Claude Code with a Z.ai API key, that key should only be used by us and through authorized means. Capturing it via a proxy for our internal use (e.g. measuring or debugging) is fine, but again we must not leak it or give others a way to use it. Z.ai’s terms also prohibit **circumventing security measures or engaging in unauthorized access**[chat.z.ai](https://chat.z.ai/legal-agreement/terms-of-service#:~:text=e,actions%20prohibited%20under%20these%20Terms). Using a proxy to route requests is not explicitly forbidden (in fact, enterprise setups commonly route through proxies), but doing anything that might be seen as exploiting the service (like replaying requests in a way to avoid billing or using one key for multiple users) would be problematic. As long as our proxy is simply passively capturing and forwarding our own requests (without altering the intended usage or trying to deceive the system), we remain on safe ground. We should **not attempt to use the captured token to call Z.ai beyond the scope of Claude Code’s normal operation**, as that could violate their acceptable use (and they could detect abnormal patterns).
    

**Summary:** Both Anthropic and Z.ai require users to **protect their credentials** and use the services as intended. Our plan to intercept the CLI’s calls does not inherently break these rules – we are not sharing keys with third parties, and we’re still using the official client (Claude Code) to initiate requests. However, we should be cautious about **“token replay”** outside of the client. For example, using an Anthropic session token in a custom script continuously would likely violate the no-bot rule for consumer accounts[anthropic.com](https://www.anthropic.com/legal/consumer-terms#:~:text=6,any%20type%2C%20including%20reputational%20harms). The safer approach, if one needs programmatic access, is to use an official API key (Anthropic offers developer API keys) or stick within the CLI environment. In our case, since we are only intercepting calls to observe or log them (not to modify Anthropic’s responses or circumvent billing), this falls under reasonable use. It’s analogous to using a corporate proxy or network monitor – which Anthropic explicitly supports for enterprise users[docs.claude.com](https://docs.claude.com/en/docs/claude-code/network-config#:~:text=Environment%20variables)[docs.claude.com](https://docs.claude.com/en/docs/claude-code/network-config#:~:text=Network%20access%20requirements). We are simply inspecting our own traffic. **Bottom line:** Keep the captured tokens secure, and don’t use them in ways the provider didn’t intend, and we should remain compliant with both Anthropic’s and Z.ai’s policies.

## Usage Pattern – Claude Code CLI vs Direct API Calls

It’s important to clarify that **our integration uses the Claude Code CLI as the driver**, rather than making raw API calls ourselves. The CLI handles all communication with Anthropic’s (or Z.ai’s) servers – including forming the requests, setting the proper headers, streaming outputs, etc. Our role is only to intercept those calls in transit. This means a few things:

* **Authentication Workflow:** When using Claude Code, you typically either log in via your Anthropic account (for consumer plans) or provide an API key. In the case of an Anthropic account login (`claude /login` command), the CLI obtains an OAuth token behind the scenes for your session. If you have an API key (from an Anthropic developer account or from Z.ai), you can set it in the environment or config so that the CLI uses it directly[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1klr5ys/employer_provided_us_with_an_anthropic_api_key_to/#:~:text=I%27ve%20never%20used%20claude%20%2Flogin,just%20setting%20your%20env%20variable). **Either way, the CLI will include the necessary auth credentials in each API request** – usually as an `Authorization: Bearer ...` header (Anthropic’s API expects a Bearer API key[nightfall.ai](https://www.nightfall.ai/ai-security-101/anthropic-claude-api-key#:~:text=To%20use%20an%20Anthropic%20Claude,followed%20by%20your%20API%20key)). In Z.ai’s case, their environment setup suggests using `ANTHROPIC_AUTH_TOKEN` for the key[docs.z.ai](https://docs.z.ai/devpack/tool/claude#:~:text=%7B%20,%7D), which the CLI likely sends similarly (possibly as a bearer token or key header to the Z.ai endpoint). We do **not** supply any auth details ourselves in the proxy; we simply capture what the CLI is already using. For example, a community-made proxy for Claude Code noted that it doesn’t need to handle keys at all, since _“the intercepted request… includes the auth key in its header”_ automatically[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1lnuxbj/i_created_a_proxy_that_captures_and_visualizes/#:~:text=%E2%80%A2%20%203mo%20ago).
    
* **API Endpoints:** By default, Claude Code communicates with Anthropic’s cloud (`api.anthropic.com` for API calls, and some ancillary domains like `claude.ai` for certain features[docs.claude.com](https://docs.claude.com/en/docs/claude-code/network-config#:~:text=Network%20access%20requirements)). In our setup, we have the option to reroute this. For instance, if using Z.ai as the backend, the CLI’s `ANTHROPIC_BASE_URL` is pointed to `https://api.z.ai/api/anthropic` [docs.z.ai](https://docs.z.ai/devpack/tool/claude#:~:text=,%7D). We could similarly point it to our local proxy server. The CLI doesn’t directly expose low-level API call details to the user, but under the hood it’s making HTTPS requests to these endpoints with JSON payloads (containing our prompts, code, etc.). Our intercepting proxy will see requests to the relevant host (Anthropic or Z.ai) on each Claude action (chat completion, tool invocation, etc.).
    
* **No Direct Calls from Our Code:** We are **not calling Anthropic’s API ourselves in a separate script**. This means we rely entirely on the CLI’s normal operation. Why is this beneficial? It ensures we remain aligned with the supported usage pattern. The CLI manages rate limits, request formats, and any necessary context handling. Our proxy just eavesdrops. If we attempted to use the API directly, we’d have to implement all those details and could risk deviating from Anthropic’s expected use (and, as noted, using the consumer token directly would break the ToS). By sticking to the CLI, we essentially let Claude Code be the “client”, and we are a passive man-in-the-middle observer. This results in less engineering effort on our side and less risk of violating usage policies.
    
* **Maintaining CLI Functionality:** Because we intercept at the network level, **Claude Code’s features (like Tools, Plugins, etc.) all continue to work** as normal. We are not modifying the CLI or injecting anything into its runtime – it doesn’t “know” it’s talking to a proxy. For instance, if Claude Code decides to call the `/read` tool (which causes it to fetch a file’s content via the API), that request goes out and our proxy will log it, then forward it. From Claude’s perspective, nothing has changed in the environment except the network route. This is ideal since it means we don’t interfere with its operation. All analysis (like detecting when a file changed and auto-reading it, etc.) still happens within Claude Code – we just get a copy of those requests/responses for our auditing or development insights.
    

In summary, our usage pattern is to **use Claude Code CLI normally, but with a proxy in place**. We’re not replacing Claude’s API calls with our own logic, just capturing them. This approach keeps us within the supported client usage and ensures that the rich CLI functionality (which is more than just simple API calls) remains intact. It also simplifies compliance: we continue to consume the service as a normal client would, meaning our billing, quotas, and data handling remain the same – we’re merely observing the data in transit for debugging or analysis purposes.

**Sources:**

* Anthropic Claude Code Enterprise Network Config (proxy and CA settings)[docs.claude.com](https://docs.claude.com/en/docs/claude-code/network-config#:~:text=Claude%20Code%20respects%20standard%20proxy,environment%20variables)[docs.claude.com](https://docs.claude.com/en/docs/claude-code/network-config#:~:text=Claude%20Code%20does%20not%20support,SOCKS%20proxies)[docs.claude.com](https://docs.claude.com/en/docs/claude-code/network-config#:~:text=Custom%20CA%20certificates)
    
* Reddit – _Claude Code proxy via mitmproxy experience_[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1lnuxbj/i_created_a_proxy_that_captures_and_visualizes/#:~:text=I%27ve%20also%20managed%20to%20get,but%20oh%20well)[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1lnuxbj/i_created_a_proxy_that_captures_and_visualizes/#:~:text=Whoa%20so%20the%20texts%20is,get%20the%20system%20prompt%20then)[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1lnuxbj/i_created_a_proxy_that_captures_and_visualizes/#:~:text=%E2%80%A2%20%203mo%20ago)
    
* Anthropic Consumer Terms (account/API key sharing and automation clauses)[anthropic.com](https://www.anthropic.com/legal/consumer-terms#:~:text=requirements%20for%20legal%20notices)[anthropic.com](https://www.anthropic.com/legal/consumer-terms#:~:text=6,any%20type%2C%20including%20reputational%20harms)
    
* Z.ai Terms of Use (API key confidentiality and no-circumvention clauses)[chat.z.ai](https://chat.z.ai/legal-agreement/terms-of-service#:~:text=log%20into%20our%20Services%20using,your%20account)[chat.z.ai](https://chat.z.ai/legal-agreement/terms-of-service#:~:text=e,actions%20prohibited%20under%20these%20Terms)
    
* Reddit – _Using Claude Code with API key vs login_[reddit.com](https://www.reddit.com/r/ClaudeAI/comments/1klr5ys/employer_provided_us_with_an_anthropic_api_key_to/#:~:text=I%27ve%20never%20used%20claude%20%2Flogin,just%20setting%20your%20env%20variable) and Z.ai Claude integration docs[docs.z.ai](https://docs.z.ai/devpack/tool/claude#:~:text=,%7D).