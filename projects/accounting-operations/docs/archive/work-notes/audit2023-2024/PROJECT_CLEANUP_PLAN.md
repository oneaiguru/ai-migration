# Project Cleanup & Organization Plan
## Systematic TOML-based Approach (Share with Local Agent)

**Status:** Planning phase  
**Goal:** One clean project structure using accounts.toml as source of truth  
**Files to organize:** 19 XLSX statements (2023-2024)

---

## PART 1: Project Structure (What Goes Where)

```
/mnt/project/
├── accounts.toml                 ← SOURCE OF TRUTH (config file)
├── metadata/
│   ├── build_statements.py       ← NEW: script to generate inventory
│   └── statements.toml           ← AUTO-GENERATED: machine-readable inventory
├── renamed-statements/           ← All organized files go here
│   └── ALIAS_START_END.xlsx     ← Standard naming
├── generate_reports.py           ← Core: generates coverage reports
├── verify_statement.py           ← Core: verifies downloaded files
├── copy_rename_statements.py     ← Core: organizes files
└── *.md                          ← Generated reports
```

---

## PART 2: What's in accounts.toml (Source of Truth)

```toml
# This file defines all accounts
# Edit here = everything regenerates automatically

[[account]]
id = "1280026055073967"
alias = "KGS-BIZ-3967"
currency = "KGS"
type = "business"
status = ""

[[account]]
id = "1280026055074068"
alias = "USD-BIZ-4068"
currency = "USD"
type = "business"
status = ""

[[account]]
id = "1280026055074169"
alias = "EUR-BIZ-4169"
currency = "EUR"
type = "business"
status = ""

[[account]]
id = "1280026055074270"
alias = "RUB-BIZ-4270"
currency = "RUB"
type = "business"
status = ""

[[account]]
id = "1280166055398178"
alias = "KGS-PER-8178"
currency = "KGS"
type = "personal"
status = ""

[[account]]
id = "1280166055398279"
alias = "USD-PER-8279"
currency = "USD"
type = "personal"
status = ""

[[account]]
id = "1280166055397976"
alias = "RUB-PER-7976"
currency = "RUB"
type = "personal"
status = ""

[[account]]
id = "1280166055398077"
alias = "EUR-PER-8077"
currency = "EUR"
type = "personal"
status = "archived"
```

---

## PART 3: What Gets Generated (metadata/statements.toml)

This file is AUTO-GENERATED by `metadata/build_statements.py`

**Format:**
```toml
# Auto-generated inventory of statements

[[statement]]
src = "Выписка_сче_та__2_.xlsx"
account_id = "1280026055074169"
alias = "EUR-BIZ-4169"
start = "2024-07-01"
end = "2024-09-30"
dest = "renamed-statements/EUR-BIZ-4169_2024-07-01_2024-09-30.xlsx"

[[statement]]
src = "Выписка_сче_та__3_.xlsx"
account_id = "1280026055074169"
alias = "EUR-BIZ-4169"
start = "2024-10-01"
end = "2024-12-31"
dest = "renamed-statements/EUR-BIZ-4169_2024-10-01_2024-12-31.xlsx"

# ... one entry per XLSX file
```

---

## PART 4: Execution Steps (For Local Agent)

### Step 1: Copy accounts.toml to project (if not already there)
```bash
# Verify it exists with all 8 accounts
cat /mnt/project/accounts.toml | grep "alias ="
# Should show: KGS-BIZ-3967, USD-BIZ-4068, EUR-BIZ-4169, RUB-BIZ-4270, 
#             KGS-PER-8178, USD-PER-8279, RUB-PER-7976, EUR-PER-8077
```

### Step 2: Add functions to generate_reports.py
**Add at top (after imports):**
```python
# Global maps (populated by load_accounts_data)
ALIAS_MAP = {}
TYPE_MAP = {}
CURRENCY_MAP = {}
STATUS_MAP = {}

def display_name(acc_id: str, label: str) -> str:
    """Return alias from map or fallback to label."""
    alias = ALIAS_MAP.get(acc_id)
    return alias if alias else label

def load_accounts_data(path: Path) -> List[dict]:
    """Load accounts from TOML, populate global maps."""
    if not path.exists():
        return []
    
    text = path.read_text(encoding="utf-8")
    data = None
    
    try:
        import tomllib  # Python 3.11+
        data = tomllib.loads(text)
    except Exception:
        try:
            import tomli  # Fallback
            data = tomli.loads(text)
        except Exception:
            # Manual parser
            accounts = []
            current = {}
            for line in text.splitlines():
                line = line.strip()
                if not line or line.startswith("#"):
                    continue
                if line.startswith("[[account]]"):
                    if current:
                        accounts.append(current)
                    current = {}
                    continue
                if "=" in line:
                    k, v = line.split("=", 1)
                    k = k.strip()
                    v = v.strip().strip('"')
                    current[k] = v
            if current:
                accounts.append(current)
            data = {"account": accounts}
    
    accounts = data.get("account", []) if isinstance(data, dict) else []
    
    # Populate maps
    ALIAS_MAP.clear()
    TYPE_MAP.clear()
    CURRENCY_MAP.clear()
    STATUS_MAP.clear()
    
    for acc in accounts:
        acc_id = acc.get("id")
        if not acc_id:
            continue
        ALIAS_MAP[acc_id] = acc.get("alias", acc_id)
        TYPE_MAP[acc_id] = acc.get("type", "")
        CURRENCY_MAP[acc_id] = acc.get("currency", "")
        STATUS_MAP[acc_id] = acc.get("status", "")
    
    return accounts
```

**Update main():**
```python
def main():
    root = Path(".")
    load_accounts_data(root / "accounts.toml")  # ADD THIS LINE
    periods = iter_periods(root)
    # ... rest unchanged
```

### Step 3: Create metadata/ directory and add build_statements.py
```bash
mkdir -p /mnt/project/metadata
```

**Create `/mnt/project/metadata/build_statements.py`:**
```python
#!/usr/bin/env python3
from pathlib import Path
import sys

ROOT = Path(__file__).resolve().parents[1]
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))

from generate_reports import (
    display_name,
    iter_periods,
    load_accounts_data,
)

def main():
    load_accounts_data(ROOT / "accounts.toml")
    periods = iter_periods(ROOT)
    out_path = ROOT / "metadata" / "statements.toml"

    lines = ["# Auto-generated inventory of statements", ""]
    for p in sorted(periods, key=lambda x: x.path.as_posix()):
        alias = display_name(p.account_id, p.account_label)
        src = p.path.relative_to(ROOT).as_posix()
        start = p.start.isoformat()
        end = p.end.isoformat()
        dest = f"renamed-statements/{alias}_{start}_{end}.xlsx"
        lines.append("[[statement]]")
        lines.append(f'src = "{src}"')
        lines.append(f'account_id = "{p.account_id}"')
        lines.append(f'alias = "{alias}"')
        lines.append(f'start = "{start}"')
        lines.append(f'end = "{end}"')
        lines.append(f'dest = "{dest}"')
        lines.append("")

    out_path.write_text("\n".join(lines), encoding="utf-8")
    print(f"Wrote {out_path}")

if __name__ == "__main__":
    main()
```

### Step 4: Copy 19 files to project root
```bash
cp /mnt/user-data/uploads/Выписка_сче_та__*.xlsx /mnt/project/
```

### Step 5: Run verification on all 19 files
```bash
cd /mnt/project
for f in Выписка_сче_та__*.xlsx; do
  echo "=== $f ==="
  python3 verify_statement.py "$f"
done
```

**Expected output:** All 19 files should verify with correct account IDs and date ranges

### Step 6: Organize all files
```bash
cd /mnt/project
python3 copy_rename_statements.py
```

**Expected output:** 19 files copied to `renamed-statements/` with standardized names

### Step 7: Generate metadata inventory
```bash
cd /mnt/project
python3 metadata/build_statements.py
```

**Expected output:** Creates `metadata/statements.toml` with all 19 statements

### Step 8: Generate coverage reports
```bash
cd /mnt/project
python3 generate_reports.py
```

**Expected outputs:**
- `period-ranges.md` — All detected periods
- `coverage-2024-table.md` — Monthly heatmap 
- `tasks-2024-gaps.md` — Any remaining gaps
- `tasks-2023-halfyear.md` — 2023 request list

---

## PART 5: Verification Checklist

After all steps, verify:

- [ ] accounts.toml has 8 accounts
- [ ] metadata/build_statements.py exists
- [ ] metadata/statements.toml was created
- [ ] renamed-statements/ has 19 files
- [ ] All files named: ALIAS_START_END.xlsx
- [ ] coverage-2024-table.md shows data
- [ ] tasks-2024-gaps.md is up to date
- [ ] No error messages

**Quick test:**
```bash
cd /mnt/project
test -f accounts.toml && \
test -f metadata/statements.toml && \
test -d renamed-statements && \
ls -1 renamed-statements | wc -l  # Should be 19 \
&& echo "✓ ALL VERIFIED"
```

---

## PART 6: Benefits of This Approach

| Benefit | How |
|---------|-----|
| Single source of truth | Edit accounts.toml only, everything regenerates |
| Machine-readable inventory | statements.toml for auditing/integration |
| No hardcoding | All aliases in config, not in code |
| Scalable | Easy to add new accounts |
| Traceable | Every file tracked in metadata |
| Repeatable | Same process for future uploads |

---

## PART 7: Expected Final Structure

```
/mnt/project/
├── accounts.toml
├── metadata/
│   ├── build_statements.py
│   └── statements.toml (19 entries)
├── renamed-statements/
│   ├── EUR-BIZ-4169_2024-07-01_2024-09-30.xlsx
│   ├── EUR-BIZ-4169_2024-10-01_2024-12-31.xlsx
│   ├── EUR-BIZ-4169_2023-01-01_2023-03-31.xlsx
│   ├── EUR-BIZ-4169_2023-04-01_2023-06-30.xlsx
│   ├── EUR-BIZ-4169_2023-07-01_2023-09-30.xlsx
│   ├── EUR-BIZ-4169_2023-10-01_2023-12-31.xlsx
│   ├── KGS-BIZ-3967_2023-01-01_2023-03-31.xlsx
│   ├── KGS-BIZ-3967_2023-04-01_2023-06-30.xlsx
│   ├── KGS-BIZ-3967_2023-07-01_2023-09-30.xlsx
│   ├── KGS-BIZ-3967_2023-10-01_2023-12-31.xlsx
│   ├── USD-BIZ-4068_2024-12-26_2024-12-31.xlsx
│   ├── USD-BIZ-4068_2023-01-01_2023-03-31.xlsx
│   ├── USD-BIZ-4068_2023-04-01_2023-06-30.xlsx
│   ├── USD-BIZ-4068_2023-07-01_2023-09-30.xlsx
│   ├── USD-BIZ-4068_2023-10-01_2023-12-31.xlsx
│   ├── RUB-BIZ-4270_2023-01-01_2023-03-31.xlsx
│   ├── RUB-BIZ-4270_2023-04-01_2023-06-30.xlsx
│   ├── RUB-BIZ-4270_2023-07-01_2023-09-30.xlsx
│   └── RUB-BIZ-4270_2023-10-01_2023-12-31.xlsx
├── coverage-2024-table.md (updated)
├── tasks-2024-gaps.md (updated)
├── period-ranges.md (updated)
├── generate_reports.py (updated with functions)
├── verify_statement.py (unchanged)
└── copy_rename_statements.py (unchanged)
```

**Total: 19 organized files + metadata + reports = ONE CLEAN PROJECT**

---

## Questions for Verification?

✓ Plan clear?  
✓ Steps executable?  
✓ Expected outputs realistic?  
✓ Ready to execute?

