# PRD v1.6-финал — Полная спецификация

**Трекер и оптимизатор использования подписок**

Версия: v1.6-финал · Режим: Только подписки · Дата: Октябрь 2025

---

## 0) Исходные данные и область применения (Октябрь 2025)

**Авторитетные факты (без исправлений):**

* **OpenAI Codex CLI:** Модели `gpt-5-codex` (оптимизирован для кодинга) и `gpt-5` (общие рассуждения); **Уровни рассуждений** (Minimal/Low/Medium/High) влияют на расход квоты; 5-часовое окно сессии + еженедельный лимит показываются через `/status`.

* **Anthropic Claude Code:** Тарифы включают **Pro** и **Max (×5 / ×20)**; сессии сбрасываются каждые 5 часов; еженедельные лимиты применяются. **Claude Sonnet 4.5** — текущая версия (редактирование контекста/функции памяти). **Уровни мышления** ("think", "think hard", "ultrathink") — триггеры бюджета токенов только в Claude Code.

* **Z.AI GLM (Coding Plans):** **GLM-4.6** (по умолчанию) + **GLM-4.5-Air** (облегченная) с **Lite/Pro/Max ≈ 120/600/2400 промптов за 5ч**. Через интеграцию с Claude Code; использование отслеживается в промптах, а не токенах.

* **Только режим подписки.** Цены API приведены только для сравнения. Подтверждайте лимиты в runtime (планы меняются).

---

## 1) Цель и ключевые показатели

**Цель:** Максимизировать успешные фичи на единицу мощности при соблюдении гейтов качества и лимитов 5ч/неделя.

**Основная единица:** **Фича** считается готовой, когда её BDD-сценарии зеленые.

**Основные метрики:**

* **Эффективность (E):** `успешные_фичи / единица_мощности`
  * Codex/Claude: единица мощности = Δшкалы процентные пункты (**пп**) за окно
  * GLM: единица мощности = использованные промпты
  * Примечание: "пп" = процентные пункты (абсолютный %, не относительное изменение)

* **Эффективность с учетом качества (E_q):** `Σ(успешные_фичи × оценка_качества) / единица_мощности`
  * `оценка_качества = 1 – normalized_churn_14d` (ограничено [0.5, 1.0])

* **IMPF:** Минуты взаимодействия на фичу (человеческое время)
* **CLS:** Оценка когнитивной нагрузки на фичу

**Награда для роутинга (при включении):**
* На основе шкалы: `r = оценка_качества / (ε + Δпп)` (ε≈0.5пп)
* GLM: `r = оценка_качества / (ε + промпты)`

---

## 2) Источники данных и прием

**Первичные (канонические):**
* **claude-monitor** — сессии/дневные/месячные виды, математика 5ч
* **ccusage** — парсинг Claude+Codex; выдает JSON/JSONL; блоки 5ч

**Резервные (текстовые парсеры):**
* **Codex `/status`** — шкалы 5ч + недельные, уровень рассуждений, контекст %
* **Claude `/usage`** — сессионные/недельные шкалы (все модели, Opus); уровень мышления
  * Крайний случай: "Failed to load usage data" → сначала отправить "hi"

**Хранение (JSONL только добавление):**
* `snapshots.jsonl` — сырые снимки ДО/ПОСЛЕ + вставленный блок
* `glm_counts.jsonl` — счетчики промптов GLM (источник=ccusage/monitor/trace)
* `windows.jsonl` — агрегаты окон (дельты/единицы провайдеров, pass/fail/score, заметки)

**Гарантии парсера:**
* Regex: устойчив к переносам, без ANSI, DOTALL
* Ошибки: `insufficient-data` (Codex узкий), `usage-not-loaded` (Claude)

---

## 3) Профили провайдеров (Факты подписок)

| Провайдер                   | Тариф/План             | Сброс          | Лимиты                   | Модели               | Заметки                                                      |
| --------------------------- | ---------------------- | -------------- | ------------------------ | -------------------- | ------------------------------------------------------------ |
| **Codex (OpenAI)**          | Pro-200                | 5ч + недельный | Через шкалы `/status`    | gpt-5-codex, gpt-5   | Уровни рассуждений: Min/Low/Med/High                         |
| **Claude Code (Anthropic)** | Pro / Max ×5 / Max ×20 | 5ч + недельный | Через шкалы `/usage`     | Sonnet 4.5, Opus 4.1 | Уровни мышления: think/ultrathink                            |
| **GLM (Z.AI)**              | Lite/Pro/Max           | Пулы 5ч        | 120/600/2400 промптов/5ч | GLM-4.6, GLM-4.5-Air | Недельный пул не документирован; 4.6 ≈ 2× стоимость мощности Air (ориентир; измерить в Неделю-0) |

**Политика:** Показывать баннер "Лимиты могут измениться — проверьте здесь: [URL провайдера]"; логировать дату последней проверки.

---

## 4) Качество: Гейты спецификаций, Churn, CLS, IMPF

### Гейт проверки спецификаций

**Панель (по умолчанию):**
* **gpt-5** — Рассуждения: High (широкие знания, граничные случаи)
* **Claude Sonnet 4.5** — Мышление: ultrathink (глубокий анализ)
* **GLM-4.6** — Стандартный бюджет (tie-breaker)

**Правило решения:**
* **По умолчанию:** ОДОБРИТЬ когда ≥2 из 3 моделей подписывают ("2-из-3")
* **Ограничитель мощности:** Если любая недельная шкала < 10пп остаток ИЛИ блок GLM < 15% остаток, использовать **"1-из-2"** (gpt-5 High + Sonnet 4.5) чтобы избежать тупика квоты
* **Разделенное голосование:** Если 1-1-1, эскалировать к Opus 4.1 (ultrathink) как tie-breaker

**Эскалация (Tier-2):**
* Только если CLS > 1.2σ ИЛИ Tier-1 отмечает блокирующий риск
* Добавить: Opus 4.1 + GPT-5 (оба максимальное усилие)

**Логирование:** Сохранять голоса панели + обоснования с тегом `xfeat::` фичи

### Рубрика спецификаций v1 (10 проверок)
1. Однозначные входы/выходы
2. Ограниченные диапазоны и пути ошибок
3. Примечания по безопасности/разрешениям
4. Контракты данных (OpenAPI/AsyncAPI/Proto)
5. Примеры граничных случаев
6. Отслеживаемость к BDD
7. Критерии приемки
8. Хуки отката/наблюдаемости
9. Нефункциональные границы
10. Правила состояния/сброса

### Отслеживаемость
Спецификация → BDD-сценарии → код → тесты → покрытие; связывать ID в коммитах

### Churn (Изменчивость кода)
* Отслеживать **нормализованный churn 7/14/28д** на фичу/модуль
* **Исключать** churn прототипов через тег `xproto::` (см. §8)
* Использовать churn для штрафа quality_score и выявления рискованных модулей

### CLS v1 (Оценка когнитивной нагрузки)
```
CLS = 0.25·z(files_touched) + 0.20·z(module_spread) + 0.15·z(dep_depth)
    + 0.15·z(Δcyclomatic) + 0.10·z(plan_size_kb) + 0.10·z(interface_delta)
    + 0.05·z(cross_refs)
```
* **Гейт:** CLS > 1.2σ → требуется подпись Tier-2
* **Роутинг:** High-CLS → более сильные модели; low-CLS → более дешевые модели

### IMPF (Минуты взаимодействия на фичу)
Автологирование человеческого времени: наведение, вмешательство, валидация. KPI: нисходящий тренд.

---

## 5) Оценка и размер выборки

**Оценщик (малый-n, гетероскедастичный):**
* **По умолчанию:** Дельта-метод с HC3 robust SE для E и E_q
* **Перекрестные проверки:** Fieller + BCa bootstrap когда n<10 или сильный скос

**Единица мощности:**
* Δ5ч шкала % где доступно
* prompts_delta для GLM
* Хранить и сырые, и нормализованные

**Гейты уверенности:**
* Начать перераспределение ≥75% уверенность
* Вывести ≥95% уверенность

**Рекомендации по размеру выборки:**
* Обнаружить Δ=0.10 E-единиц с 80% мощностью → ~15-20 окон/провайдер
* Δ=0.05 → ~60-70 окон (использовать последовательные гейты 75/95 на практике)

---

## 6) Роутер (Ограничения подписок, Дрифт, Переделка)

**Алгоритм:** Bandits-with-Knapsacks (BwK)
* Фактор дисконта γ≈0.95 для дрифтящих наград
* Теневая цена для оставшейся недельной мощности
* Обрабатывает отложенную передел