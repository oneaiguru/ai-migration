Feature: Tracker alias workflow
  Operators should be able to record snapshots with shorthand aliases.
  Background:  

  Scenario: Record Codex start and end panes 
    Given a fresh tracker data directory
    When I run the alias command "start codex" with fixture "codex/alt_reset_64_0.txt"
    And I run the alias command "end codex" with fixture "codex/wide_status_82_1.txt"
    Then tracker should have a "codex" "before" snapshot for window "W0-01"
    And tracker should have a "codex" "after" snapshot for window "W0-01"

  Scenario: Cross closes the current window and seeds the next 
    Given a fresh tracker data directory
    When I run the alias command "start codex" with fixture "codex/alt_reset_64_0.txt"
    And I run the alias command "cross codex" with fixture "codex/wide_status_82_1.txt"
    Then tracker should have a "codex" "after" snapshot for window "W0-01"
    And tracker should have a "codex" "before" snapshot for window "W0-02"
    And the last alias stdout should contain "seeded before snapshot for W0-02"

  Scenario: Delete the latest Codex after snapshot 
    Given a fresh tracker data directory
    When I run the alias command "start codex" with fixture "codex/alt_reset_64_0.txt"
    And I run the alias command "end codex" with fixture "codex/wide_status_82_1.txt"
    And I run the alias delete command "codex" with options
      | option | value |
      | phase  | after |
    Then tracker should have no "codex" "after" snapshot for window "W0-01"
    And the last alias stdout should contain "removed codex after snapshot"

  Scenario: Delete the second-latest Codex before snapshot 
    Given a fresh tracker data directory
    When I run the alias command "start codex" with fixture "codex/alt_reset_64_0.txt"
    And I run the alias command "cross codex" with fixture "codex/wide_status_82_1.txt"
    And I run the alias delete command "codex" with options
      | option | value  |
      | phase  | before |
      | index  | 2      |
    Then tracker should have no "codex" "before" snapshot for window "W0-01"
    And tracker should have a "codex" "before" snapshot for window "W0-02"

  Scenario: Undo erroneous Codex window recording 
    Given a fresh tracker data directory
    When I run the alias command "start codex" with window "W0-19" using fixture "codex/live_cases/W0-19_before_correct.txt"
    And I run the alias command "end codex" with window "W0-19" using fixture "codex/live_cases/W0-19_after_12pct.txt"
    And I run the alias command "start codex" with window "W0-20" using fixture "codex/live_cases/W0-20_start_0pct.txt"
    And I run the alias delete command "codex" with options
      | option | value  |
      | phase  | before |
      | window | W0-20  |
    Then the last alias stdout should contain "removed codex before snapshot"
    And I run the alias command "start codex" with window "W0-20" using fixture "codex/live_cases/W0-20_start_0pct.txt"
    Then tracker should have a "codex" "before" snapshot for window "W0-19"
    And tracker should have a "codex" "after" snapshot for window "W0-19"
    And tracker should have a "codex" "before" snapshot for window "W0-20"
    And tracker should have no "codex" "after" snapshot for window "W0-20"

  Scenario: GLM baseline and delta capture 
    Given a fresh tracker data directory
    When I run the alias command "start glm" with inline json
      """
      {
        "account": "glm",
        "generated_at": "2025-11-05T10:00:00Z",
        "blocks": [
          {"window_id": "W0-01", "provider": "glm-4.6", "prompts_used": 12}
        ]
      }
      """
    And I run the alias command "end glm" with inline json
      """
      {
        "account": "glm",
        "generated_at": "2025-11-05T15:00:00Z",
        "blocks": [
          {"window_id": "W0-01", "provider": "glm-4.6", "prompts_used": 30}
        ]
      }
      """
    Then tracker should record glm prompts "18" for window "W0-01"
    And the last alias stdout should contain "stored glm delta"

  Scenario: Codex multi-pane status keeps the latest block 
    Given a fresh tracker data directory
    When I run the alias command "start codex" with fixture "codex/alt_reset_64_0.txt"
    And I run the alias command "end codex" with fixture "codex/live_cases/W0-20_after_multi_status.txt"
    Then tracker should have a "codex" "after" snapshot for window "W0-01"
    And tracker should record codex metrics for window "W0-01" phase "after" with 5h "0" and weekly "10"
    And tracker should note codex errors for window "W0-01" phase "after" containing "multi-pane-trimmed"

Feature: Codex status automation workflow
  Automate Codex /status capture via shell script and tracker aliases.
  Background:  

  @automation
  Scenario: Capture Codex before snapshot through automation script 
    Given a fresh tracker data directory
    When I run codex status automation with fixture "automation/codex_status_before.txt" for window "W0-AUTO" phase "before"
    Then tracker should have a "codex" "before" snapshot for window "W0-AUTO"
    And tracker snapshot source for "codex" phase "before" window "W0-AUTO" should be "automation"
    And the last alias stdout should contain "5h limit"

  @automation
  Scenario: Capture Codex after snapshot through automation script 
    Given a fresh tracker data directory
    When I run codex status automation with fixture "automation/codex_status_before.txt" for window "W0-AUTO" phase "before"
    And I run codex status automation with fixture "automation/codex_status_after.txt" for window "W0-AUTO" phase "after"
    Then tracker should have a "codex" "after" snapshot for window "W0-AUTO"
    And tracker snapshot source for "codex" phase "after" window "W0-AUTO" should be "automation"
    And tracker should record codex metrics for window "W0-AUTO" phase "after" with 5h "11" and weekly "9"

  @automation
  Scenario: Capture Claude monitor snapshot through automation script 
    Given a fresh tracker data directory
    When I run claude monitor automation with fixture "claude_monitor/realtime_sample.txt" for window "W0-AUTO-C" notes "automation:claude-monitor"
    Then tracker claude monitor record for window "W0-AUTO-C" should have token usage "0.0"
    And tracker claude monitor token limit for window "W0-AUTO-C" should be "153378"

Feature: ccusage Codex coverage
  Validate ccusage daily, weekly, and session ingestion workflows for Codex usage tracking.
  Background:  

  @session
  Scenario: Ingest Codex ccusage session summary 
    Given a fresh tracker data directory
    When I ingest tracker codex ccusage scope "session" for window "W0-CC-SESSION" using fixture "ccusage/codex_sessions_sample.json"
    Then tracker codex ccusage record for window "W0-CC-SESSION" should have scope "session"
    And tracker codex ccusage total tokens for window "W0-CC-SESSION" should be "7372723263"
    And tracker codex ccusage latest session id for window "W0-CC-SESSION" should be "2025/10/19/rollout-2025-10-19T01-57-49-0199f878-7b4c-7423-9b83-c2bd6e6749d6"

  @daily
  Scenario: Ingest Codex ccusage daily summary 
    Given a fresh tracker data directory
    When I ingest tracker codex ccusage scope "daily" for window "W0-CC-DAILY" using fixture "ccusage/codex_daily_sample.json"
    Then tracker codex ccusage record for window "W0-CC-DAILY" should have scope "daily"
    And tracker codex ccusage daily total tokens for window "W0-CC-DAILY" date "2025-10-19" should be "123456"
    And tracker codex ccusage daily percent used for window "W0-CC-DAILY" date "2025-10-19" should be "12.5"
    And tracker codex ccusage reset at for window "W0-CC-DAILY" should be "2025-10-20T21:11:00Z"

  @weekly
  Scenario: Ingest Codex ccusage weekly summary 
    Given a fresh tracker data directory
    When I ingest tracker codex ccusage scope "weekly" for window "W0-CC-WEEKLY" using fixture "ccusage/codex_weekly_sample.json"
    Then tracker codex ccusage record for window "W0-CC-WEEKLY" should have scope "weekly"
    And tracker codex ccusage weekly percent used for window "W0-CC-WEEKLY" should be "9.2"
    And tracker codex ccusage weekly total tokens for window "W0-CC-WEEKLY" should be "987654321"

  @errors
  Scenario: Handle invalid ccusage payload 
    Given a fresh tracker data directory
    When I ingest tracker codex ccusage scope "session" for window "W0-CC-ERROR" using fixture "ccusage/codex_invalid_sample.json"
    Then tracker codex ccusage record for window "W0-CC-ERROR" should list error "invalid-json"

Feature: Tracker CLI coverage
  Core tracker commands should follow the BDD workflow and remain covered end-to-end.
  Background:  

  Scenario: Ingest snapshots and preview window summary 
    Given a fresh tracker data directory
    When I ingest tracker snapshot for "codex" phase "before" window "W0-CLI" using fixture "codex/alt_reset_64_0.txt"
    And I ingest tracker snapshot for "codex" phase "after" window "W0-CLI" using fixture "codex/wide_status_82_1.txt"
    And I ingest tracker snapshot for "claude" phase "before" window "W0-CLI" using fixture "claude/usage_wide_90_1_0.txt"
    And I ingest tracker snapshot for "claude" phase "after" window "W0-CLI" using fixture "claude/usage_narrow_90_1_0.txt"
    And I run tracker complete for window "W0-CLI" with codex "3" claude "3" quality "1.0" outcome "pass" notes "bdd"
    And I run tracker preview for window "W0-CLI"
    Then the last tracker stdout should contain "Windows: W0-CLI"
    And the last tracker stdout should contain "codex: features=3"
    And the last tracker stdout should contain "claude: features=3"
    And the last tracker stdout should contain "power=n/a"
    And the last tracker stdout should contain "Outcome: quality=1.0, outcome=pass"
    And tracker should record window "W0-CLI" codex delta weekly "18" fiveh "1"

  Scenario: Compute churn and surface preview summary 
    Given a fresh tracker data directory
    When I ingest tracker snapshot for "codex" phase "before" window "W0-CHN" using fixture "codex/alt_reset_64_0.txt"
    And I ingest tracker snapshot for "codex" phase "after" window "W0-CHN" using fixture "codex/wide_status_82_1.txt"
    And I run tracker complete with commits for window "W0-CHN" codex "2" claude "0" quality "1.0" outcome "pass" notes "churn-bdd" commit-start "HEAD" commit-end "HEAD"
    And I run tracker churn for window "W0-CHN" with provider "codex"
    And I run tracker preview for window "W0-CHN"
    Then the last tracker stdout should contain "Churn:"
    And the last tracker stdout should contain "window=W0-CHN"
    And the last tracker stdout should contain "+0/-0 (net=0)"
    And the last tracker stdout should contain "per-feature=0.00"

  Scenario: Override codex snapshot via CLI 
    Given a fresh tracker data directory
    When I run tracker override for "codex" phase "after" window "W0-OVR" with weekly "82" fiveh "1" notes "manual"
    Then tracker should have a "codex" "after" snapshot for window "W0-OVR"
    And tracker snapshot source for "codex" phase "after" window "W0-OVR" should be "override"
    And tracker snapshot errors for "codex" phase "after" window "W0-OVR" should contain "manual-override"

  Scenario: Ingest GLM counts via CLI 
    Given a fresh tracker data directory
    When I ingest tracker glm counts for window "W0-GLM" using fixture "glm/ccusage_sample.json"
    Then tracker should record glm prompts "118" for window "W0-GLM"
    And tracker glm entry for window "W0-GLM" should include provider "glm-4.6"

  Scenario: Ingest Codex ccusage JSON via CLI 
    Given a fresh tracker data directory
    When I ingest tracker codex ccusage for window "W0-CCD" using fixture "ccusage/codex_sessions_sample.json"
    Then tracker codex ccusage record for window "W0-CCD" should have session count "51"
    And tracker codex ccusage total tokens for window "W0-CCD" should be "7372723263"

  Scenario: Ingest Claude monitor snapshot via CLI 
    Given a fresh tracker data directory
    When I ingest tracker claude monitor for window "W0-CM" using fixture "claude_monitor/realtime_sample.txt"
    Then tracker claude monitor record for window "W0-CM" should have token usage "0.0"
    And tracker claude monitor token limit for window "W0-CM" should be "153378"

4 features passed, 0 failed, 0 skipped
20 scenarios passed, 0 failed, 0 skipped
119 steps passed, 0 failed, 0 skipped, 0 undefined
Took 0m0.542s
