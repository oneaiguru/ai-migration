# Plan — AgentOS R4 Adapter (D+1/D+2) with R3.6 Context

## Required Reading
- CCP: `ClaudeCodeProxy/docs/System/contracts/USAGE_EVENT_SCHEMA.md`
- CCP: `ClaudeCodeProxy/docs/LEGAL/PUBKEYS.json`
- CCP: `ClaudeCodeProxy/fixtures/usage/ccc_usage_r35_full.json`
- CCP: `ClaudeCodeProxy/docs/Tasks/CCC_R3.6_EXECUTION_PLAN.md`
- AgentOS: `docs/integration/CROSS_REPO_SYNC_PROTOCOL.md`, `docs/integration/CCC_BRIDGE.md`, `docs/integration/CCC_AGENT_CHAT.md`

## Objectives
1) D+1: Mirror R4 event fields and ingest decisions/model-health into adapter, backfill, and summary. Add ingest test using CCP fixture. Keep Behave parity green.
2) D+2: Packaging switch to `pyproject.toml` + extras `[ccc]` (cryptography), add E2E smoke script (offline-capable), update docs.

## Tasks (D+1)
- Schema: add `schemas/v1/decision.json`; extend validation to accept `decision` envelope on turn events (forward-compatible).
- Adapter/backfill: preserve `reroute_mode`, `reroute_decision`, `preferred_attempt`; copy-through model health: `warn_pct_auto`, `warn_pct_confidence`, `gap_seconds_p50`, `gap_seconds_p95`, `gap_samples` (from `/v1/usage` snapshots/backfill) into `metrics_summary.json` under `model_health`.
- Tests: new `tests/integration/test_ccp_usage_ingest.py` that loads CCP fixture and asserts these fields land in summary; Behave remains green (`features/ccc_adapter.feature`).
- Docs: update `docs/integration/CCC_BRIDGE.md` to reference the fixture and key bundle and call out the new summary fields.

## Tasks (D+2)
- Packaging: add root `pyproject.toml` with extras `[dev]`, `[ccc]` (installs `cryptography`). Update README/SOP quick start to use `uv pip install -e .[ccc]`.
- E2E smoke: add `scripts/tools/ccc_e2e_smoke.sh` to curl `/v1/usage` and `/metrics` from a local shim, then run adapter ingest (no content upload). Log outputs to `artifacts/test_runs/`.
- Docs: README/SOP updates for packaging change and smoke script.

## Deferred (next slices)
- R3.6 BDD additions: fallback_429, tokens_only_enforcement, calibration_cooldown — add feature file with `@offline` tags and enable when shim is available.
- Typed usage client (`get_usage()`, `get_metrics()`, `ready()`) and counters parser.
- Speeds arrays (ELR/TPS hourly) passthrough or summarization (align with R3.6 acceptance).

## Validation Matrix
- `pytest tests/integration/test_ccc_adapter.py`
- `pytest tests/integration/test_ccp_usage_ingest.py`
- `PYTHONPATH=tracker/src:. behave features/ccc_adapter.feature`
- When available: `scripts/tools/ccc_e2e_smoke.sh` (offline path acceptable for CI)

## Acceptance
- Ingesting `ccc_usage_r35_full.json` produces `metrics_summary.json` with `model_health[<model>]` keys listed above; decision fields preserved in events.
- Existing CCC adapter tests pass; Behave scenarios green.
- Docs reflect the fixture + key-bundle references and new install flow (D+2).

## Handoff
- Post summary in `docs/integration/CCC_AGENT_CHAT.md` and request the 10‑minute joint smoke.
- Zip touched files to `~/Downloads/agentos_r4_d1_bundle.zip`.
