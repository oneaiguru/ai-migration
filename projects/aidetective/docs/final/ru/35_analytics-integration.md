# Интеграция аналитики

## 1. Обзор

Система аналитики в Sherlock AI позволяет **отслеживать взаимодействие игроков, ход сюжета и производительность бота**. Это даёт возможность:

* **Анализировать вовлечённость** (какие выборы делают пользователи)
* **Оптимизировать сюжет** на основе поведения
* **Видеть узкие места** (где пользователи бросают игру)
* **Контролировать производительность** (время ответа, ошибки, затраты на ИИ)

* * *

## 2. Ключевые события

### 2.1 Метрики вовлечённости

| Событие | Описание |
| --- | --- |
| `story_started` | Начало новой истории |
| `story_completed` | Завершение дела |
| `story_abandoned` | Дело брошено |
| `choice_made` | Выбор варианта в сюжете |
| `clue_collected` | Собрана важная улика |
| `suspect_questioned` | Допрошен подозреваемый |
| `wrong_accusation` | Неверное обвинение |
| `correct_solution` | Успешное раскрытие |

### 2.2 Метрики производительности

| Показатель | Целевое значение |
| --- | --- |
| Время ответа (текст) | < 1 сек |
| Время ответа (ИИ) | < 3 сек |
| Время загрузки медиа | < 5 сек |
| Время обработки платежа | < 3 сек |
| Аптайм | 99% |

### 2.3 Ошибки

| Тип ошибки | Описание |
| --- | --- |
| `api_failure` | Сбой в OpenAI или YooMoney |
| `timeout_error` | Истечение времени запроса |
| `payment_error` | Ошибка при оплате |
| `bot_crash` | Критический сбой бота |

* * *

## 3. Хранение и логирование

### 3.1 Структура в БД

| Таблица | Назначение |
| --- | --- |
| `user_events` | Все пользовательские события |
| `story_stats` | Завершённость и статистика по историям |
| `error_logs` | Все критические ошибки |

```sql
CREATE TABLE user_events (
    id SERIAL PRIMARY KEY,
    user_id BIGINT,
    event_type VARCHAR(50),
    event_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    details JSONB
);

CREATE TABLE error_logs (
    id SERIAL PRIMARY KEY,
    error_type VARCHAR(50),
    error_message TEXT,
    occurred_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 Система логов

* **JSON-логирование** для удобного анализа
* **Оповещения** при критических ошибках
* **Пакетная обработка** для производительности

* * *

## 4. Визуализация и отчётность

### 4.1 Админ-панель

* **Онлайн поток** (активные игроки, завершение дел)
* **Топ-истории** (популярные кейсы)
* **Возвращаемость** (retention)
* **Переходы из free в premium**

### 4.2 Инструменты отчётов

| Тип отчёта | Метрики |
| --- | --- |
| **Отчёт вовлечённости** | Начатые дела, выборы, время |
| **Отчёт производительности** | Время ответа, API-запросы, ошибки |
| **Отчёт по доходам** | Подписки, платёжные сбои |

### 4.3 Внешние интеграции

* **Google Analytics / Mixpanel**
* **Prometheus + Grafana**
* **Sentry** для ошибок

* * *

## 5. План внедрения

### 5.1 Шаги разработки

1. **События пользовательских действий**
2. **Отслеживание ошибок и оповещения**
3. **Дашборд для аналитики**
4. **Тестирование на пилотной группе**
5. **Интеграция сторонних сервисов (Prometheus, Sentry)**

### 5.2 Тестирование

* **Точность данных** (верификация логов)
* **Нагрузка** (проверка, что логирование не замедляет бота)
* **Безопасность** (ограничение доступа к аналитическим данным)

* * *

## 6. Приоритет и дальнейшие шаги

### 6.1 Уровень важности: Высокий

Аналитика нужна **до выхода в продакшн** для контроля и улучшений.

### 6.2 Следующие действия

1. Построить таблицы БД для аналитики
2. Реализовать API для сбора данных
3. Внедрить фреймворк логирования
4. Создать дашборд
5. Оптимизировать производительность

* * *

## 7. Зависимости

* **Бэкенд**: сбор и хранение данных
* **DevOps**: настройка мониторинга и оповещений
* **Фронтенд-админ**: интерфейс для аналитики
* **QA**: проверка правильности данных