# Документация по системе автоматизации переписывания описаний товаров

## Содержание

1. [Общее описание](#общее-описание)
2. [Установка и настройка](#установка-и-настройка)
3. [Использование системы](#использование-системы)
4. [Командный интерфейс](#командный-интерфейс)
5. [Веб-интерфейс](#веб-интерфейс)
6. [Структура системы](#структура-системы)
7. [Часто задаваемые вопросы](#часто-задаваемые-вопросы)
8. [Устранение неполадок](#устранение-неполадок)
9. [Техническая поддержка](#техническая-поддержка)

## Общее описание

Система автоматизации переписывания описаний товаров для сайта Souz-Pribor предназначена для генерации уникальных текстов для товаров с использованием искусственного интеллекта (Claude API). Система обеспечивает:

- Автоматическую выгрузку данных о товарах из CMS Битрикс
- Генерацию уникальных описаний с сохранением технических характеристик
- Проверку уникальности текстов (не менее 70%)
- Загрузку обновленных описаний обратно в CMS
- Мониторинг и аналитику процесса
- Ручное редактирование текстов при необходимости

Система может обрабатывать как отдельные товары, так и массовые выгрузки, и предоставляет как командный интерфейс, так и удобную веб-панель управления.

## Установка и настройка

### Требования к системе

- PHP 8.0 или выше
- Доступ к API Битрикс
- Доступ к Claude API (Anthropic)
- Опционально: доступ к API сервиса проверки уникальности (Text.ru)
- Composer для установки зависимостей

### Установка

1. Клонируйте репозиторий или распакуйте архив с системой:
   ```bash
   git clone https://github.com/granin/text-rewriter.git
   cd text-rewriter
   ```

2. Установите зависимости с помощью Composer:
   ```bash
   composer install
   ```

3. Создайте необходимые директории:
   ```bash
   mkdir -p logs output
   chmod 755 logs output
   ```

4. Скопируйте пример конфигурационного файла и отредактируйте его:
   ```bash
   cp config.example.json config.json
   nano config.json
   ```

### Настройка конфигурации

Файл конфигурации `config.json` содержит следующие основные разделы:

#### Настройки Битрикс API:
```json
"bitrix": {
    "endpoint": "https://www.souz-pribor.ru/rest",
    "login": "admin",
    "password": "password",
    "timeout": 30
}
```

#### Настройки Claude API:
```json
"claude": {
    "api_key": "sk-ant-api...",
    "model": "claude-3-sonnet-20240229",
    "temperature": 0.7,
    "max_tokens": 1000,
    "top_p": 0.9
}
```

#### Настройки проверки уникальности:
```json
"uniqueness": {
    "threshold": 70,
    "use_external_api": true,
    "text_database": "output/text_database.txt",
    "retry_attempts": 3
}
```

#### Общие настройки:
```json
"batch_size": 10,
"log_file": "logs/rewrite.log",
"save_history": true,
"output_dir": "output",
"debug": false
```

## Использование системы

### Процесс работы с системой

1. **Подготовка данных**:
   - Настройте параметры интеграции с Битрикс
   - Настройте параметры генерации текстов и проверки уникальности

2. **Тестирование на одном товаре**:
   - Запустите тестовую генерацию для проверки качества текстов
   - При необходимости скорректируйте параметры

3. **Массовая обработка**:
   - Запустите полный процесс обработки для всех товаров
   - Отслеживайте прогресс и статистику

4. **Проверка и корректировка**:
   - Просмотрите результаты в веб-интерфейсе
   - При необходимости выполните ручную корректировку текстов
   - Примените изменения на сайт

### Пример полного рабочего цикла

1. Экспорт товаров:
   ```bash
   php cli.php --action=export --filter='{"SECTION_ID": 10}'
   ```

2. Тестирование на одном товаре:
   ```bash
   php cli.php --action=test --product-id=12345
   ```

3. Массовая обработка:
   ```bash
   php cli.php --action=process --limit=1000
   ```

4. Проверка результатов:
   - Откройте веб-интерфейс по адресу: http://localhost/text-rewriter/admin/
   - Просмотрите статистику и результаты обработки
   - Внесите необходимые корректировки

## Командный интерфейс

Система предоставляет командный интерфейс для управления процессом обработки текстов.

### Основные команды

#### Обработка товаров:
```bash
php cli.php --action=process [--filter=<json>] [--limit=<number>] [--verbose]
```

Опции:
- `--filter=<json>` - Фильтр товаров в формате JSON
- `--limit=<number>` - Ограничение количества товаров (по умолчанию 100)
- `--verbose` - Подробный вывод

#### Экспорт товаров:
```bash
php cli.php --action=export [--filter=<json>] [--verbose]
```

#### Импорт товаров:
```bash
php cli.php --action=import --file=<path> [--verbose]
```

#### Тестирование генерации:
```bash
php cli.php --action=test --product-id=<id> [--verbose]
```

#### Просмотр статистики:
```bash
php cli.php --action=stats
```

#### Справка:
```bash
php cli.php --help
```

### Примеры использования

#### Обработка товаров определенной категории:
```bash
php cli.php --action=process --filter='{"SECTION_ID": 15}' --limit=50
```

#### Экспорт товаров с определенными параметрами:
```bash
php cli.php --action=export --filter='{"PROPERTY_BRAND": "АКТАКОМ"}'
```

#### Тестирование с подробным выводом:
```bash
php cli.php --action=test --product-id=12345 --verbose
```

#### Использование пользовательской конфигурации:
```bash
php cli.php --action=process --config=custom_config.json
```

## Веб-интерфейс

Система предоставляет веб-интерфейс для удобного управления процессом обработки текстов, мониторинга прогресса и редактирования результатов.

### Доступ к веб-интерфейсу

Веб-интерфейс доступен по адресу:
```
http://your-server/path-to-system/admin/
```

### Основные разделы веб-интерфейса

#### Панель управления
- Отображение общей статистики обработки
- Мониторинг текущих задач
- Графики и диаграммы прогресса
- Список последних обработанных товаров

#### Управление текстами
- Просмотр всех обработанных товаров
- Фильтрация и поиск товаров
- Сравнение оригинальных и сгенерированных текстов
- Ручное редактирование текстов
- Перегенерация текстов при необходимости

#### Настройки
- Конфигурация параметров генерации
- Настройка интеграции с Битрикс
- Параметры проверки уникальности
- Системные настройки

#### Логи и отчеты
- Просмотр системных логов
- Доступ к отчетам о выполненных задачах
- Диагностика ошибок

### Работа с текстами в веб-интерфейсе

1. **Просмотр текста**:
   - Нажмите кнопку с иконкой глаза для товара, который хотите просмотреть
   - В открывшемся модальном окне вы увидите сравнение оригинального и сгенерированного текста
   - Перейдите по вкладкам для просмотра только оригинала или только сгенерированного текста

2. **Редактирование текста**:
   - Перейдите на вкладку "Редактирование" в окне просмотра текста
   - Внесите необходимые изменения в текст
   - Нажмите "Сохранить изменения"

3. **Перегенерация текста**:
   - Нажмите кнопку "Перегенерировать" для создания нового варианта текста
   - Система запустит процесс генерации и проверки уникальности
   - После завершения вы увидите новый вариант текста

4. **Применение текста**:
   - После проверки и редактирования нажмите кнопку "Применить текст"
   - Система обновит описание товара на сайте

## Структура системы

Система состоит из следующих основных модулей:

### Модуль экспорта/импорта данных
- Класс `BitrixApiClient` - Отвечает за взаимодействие с API Битрикс
- Функции выгрузки и загрузки данных о товарах

### Модуль генерации текстов
- Класс `ClaudeAPIClient` - Отвечает за взаимодействие с Claude API
- Класс `PromptGenerator` - Формирует оптимальные промпты для генерации

### Модуль проверки уникальности
- Класс `UniquenessChecker` - Проверяет уникальность сгенерированных текстов
- Локальное сравнение и интеграция с внешними API

### Главный контроллер
- Класс `TextRewriteController` - Координирует работу всех модулей
- Управляет полным циклом обработки данных

### Веб-интерфейс
- Панель управления и мониторинга
- Инструменты для работы с текстами

### Командный интерфейс
- Скрипт `cli.php` - Предоставляет командный интерфейс для управления системой

## Часто задаваемые вопросы

### Как долго длится процесс обработки товаров?

Время обработки зависит от нескольких факторов:
- Количество товаров для обработки
- Объем текстов и их сложность
- Настройки системы (размер пакета, ограничения API)
- Доступность и скорость ответа API сервисов

В среднем система обрабатывает около 500-700 товаров в день при стандартных настройках.

### Почему некоторые тексты имеют низкую уникальность?

Уникальность может быть низкой по нескольким причинам:
- Слишком короткий исходный текст
- Много технических характеристик, которые нельзя изменить
- Ограничения модели ИИ при работе с узкоспециализированными текстами

Для таких текстов рекомендуется ручная корректировка через веб-интерфейс.

### Как работает проверка уникальности?

Система использует два метода проверки:
1. **Локальное сравнение** - сравнение с ранее сгенерированными текстами
2. **Внешний API** - проверка через сервис Text.ru (если настроен)

При недостаточной уникальности система пытается перегенерировать текст несколько раз (количество попыток настраивается).

### Можно ли временно приостановить обработку?

Да, вы можете приостановить процесс обработки несколькими способами:
- Через веб-интерфейс - кнопка "Пауза" на панели управления
- Прерывание выполнения скрипта командой Ctrl+C (процесс можно будет возобновить позже)

Система завершит текущий пакет и приостановит обработку до возобновления.

### Как обновить промпты для генерации текстов?

Промпты настраиваются в классе `PromptGenerator`. Вы можете отредактировать файл `PromptGenerator.php` и изменить базовый шаблон промпта или логику его формирования.

Для тестирования новых промптов используйте команду:
```bash
php cli.php --action=test --product-id=<id>
```

## Устранение неполадок

### Ошибки при подключении к Битрикс API

**Проблема**: Система не может подключиться к API Битрикс или получает ошибки авторизации.

**Решение**:
1. Проверьте правильность URL, логина и пароля в `config.json`
2. Убедитесь, что у пользователя есть необходимые права доступа в Битрикс
3. Проверьте, доступен ли REST API на сайте
4. Увеличьте значение `timeout` в настройках Битрикс

### Ошибки при работе с Claude API

**Проблема**: Система не может получить ответ от Claude API или получает ошибки.

**Решение**:
1. Проверьте правильность API-ключа в `config.json`
2. Убедитесь, что указана корректная модель Claude
3. Проверьте, не превышен ли лимит запросов к API
4. Уменьшите `max_tokens` для уменьшения объема генерируемого текста

### Проблемы с уникальностью текстов

**Проблема**: Система генерирует тексты с низкой уникальностью.

**Решение**:
1. Увеличьте значение `temperature` в настройках Claude (0.7-0.8 оптимально)
2. Модифицируйте промпты для более креативной генерации
3. Уменьшите порог уникальности временно, если необходимо
4. Для проблемных товаров используйте ручное редактирование

### Медленная обработка товаров

**Проблема**: Система обрабатывает товары слишком медленно.

**Решение**:
1. Увеличьте значение `batch_size` в конфигурации
2. Уменьшите количество попыток перегенерации (`retry_attempts`)
3. Отключите проверку через внешний API, если она не критична
4. Оптимизируйте промпты для более быстрой генерации

### Ошибки при записи логов или сохранении файлов

**Проблема**: Система не может записать логи или сохранить результаты.

**Решение**:
1. Проверьте права доступа к директориям `logs` и `output`
2. Убедитесь, что на диске достаточно свободного места
3. Проверьте, указаны ли корректные пути в конфигурации

## Техническая поддержка

Если у вас возникли проблемы при использовании системы, пожалуйста, обратитесь в техническую поддержку:

- **Email**: support@granin.com
- **Telegram**: @granin

При обращении в поддержку, пожалуйста, предоставьте следующую информацию:
- Полное описание проблемы
- Файлы логов (из директории `logs`)
- Версию PHP и используемую ОС
- Скриншоты ошибок (если применимо)

Мы постараемся ответить на ваш запрос в течение 24 часов в рабочие дни.
