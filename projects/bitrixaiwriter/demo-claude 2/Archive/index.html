<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo: Автоматизация переписывания текстов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-header { background-color: #2c3e50; color: white; font-weight: 600; }
        .file-upload-area { border: 2px dashed #3498db; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .file-upload-area:hover { background-color: #ecf0f1; }
        .file-upload-area.dragover { background-color: #3498db; color: white; }
        .progress { height: 25px; margin-bottom: 15px; }
        .progress-bar { transition: width 0.3s ease; }
        .stats-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        #testTextArea { height: 200px; }
        .description-box { height: 300px; overflow-y: auto; white-space: pre-wrap; background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center">Демо: Переписывание текстов с Claude</h1>
                <p class="lead text-center">Загрузите CSV с описаниями товаров для переписывания с помощью ИИ</p>
            </div>
        </div>

        <div class="row">
            <!-- CSV Upload Section -->
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Загрузка CSV файла</h5>
                    </div>
                    <div class="card-body">
                        <div id="uploadSection">
                            <div class="file-upload-area" id="fileUploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                <h4>Перетащите CSV файл сюда или нажмите для выбора</h4>
                                <p class="text-muted">CSV должен содержать колонку "description" с текстами для обработки</p>
                                <input type="file" id="fileInput" accept=".csv" style="display: none;">
                            </div>
                            <div id="uploadStatus" class="mt-3" style="display: none;"></div>
                        </div>

                        <div id="previewSection" style="display: none;">
                            <h5>Предпросмотр файла: <span id="fileName"></span></h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead id="previewHead"></thead>
                                    <tbody id="previewBody"></tbody>
                                </table>
                            </div>
                            <button id="startProcessing" class="btn btn-primary">
                                <i class="fas fa-play"></i> Запустить обработку
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Progress Section -->
            <div class="col-md-12 mb-4">
                <div class="card" id="processingSection" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">Прогресс обработки</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%">0%</div>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="stats-number" id="totalItems">0</div>
                                <div>Всего товаров</div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-number text-success" id="processedItems">0</div>
                                <div>Обработано</div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-number" id="remainingItems">0</div>
                                <div>Осталось</div>
                            </div>
                        </div>
                        
                        <p class="mt-3">Обрабатывается: <strong id="currentItem">-</strong></p>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="col-md-12 mb-4">
                <div class="card" id="resultsSection" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">Результаты обработки</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <h4 class="alert-heading">Обработка завершена!</h4>
                            <p>Обработано товаров: <span id="completedItems">0</span> из <span id="totalCompletedItems">0</span></p>
                            <hr>
                            <p class="mb-0">Результаты сохранены в файл CSV. Используйте кнопку ниже для скачивания.</p>
                        </div>
                        
                        <a id="downloadBtn" href="#" class="btn btn-primary mb-4">
                            <i class="fas fa-download"></i> Скачать результаты (CSV)
                        </a>
                        
                        <h5>Просмотр результатов</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light text-dark">
                                        <h6 class="mb-0">Исходное описание</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="originalText" class="description-box"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light text-dark">
                                        <h6 class="mb-0">Новое описание</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="newText" class="description-box"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Section -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Тестирование на одном тексте</h5>
                    </div>
                    <div class="card-body">
                        <form id="testForm">
                            <div class="mb-3">
                                <label for="testTextArea" class="form-label">Введите описание товара для теста</label>
                                <textarea class="form-control" id="testTextArea" placeholder="Введите описание товара здесь..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-bolt"></i> Протестировать
                            </button>
                        </form>
                        
                        <div id="testResult" class="mt-4" style="display: none;">
                            <h5>Результат тестирования</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light text-dark">
                                            <h6 class="mb-0">Исходное описание</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="testOriginal" class="description-box"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light text-dark">
                                            <h6 class="mb-0">Новое описание</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="testNew" class="description-box"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadStatus = document.getElementById('uploadStatus');
            const previewSection = document.getElementById('previewSection');
            const fileName = document.getElementById('fileName');
            const previewHead = document.getElementById('previewHead');
            const previewBody = document.getElementById('previewBody');
            const startProcessing = document.getElementById('startProcessing');
            const processingSection = document.getElementById('processingSection');
            const progressBar = document.getElementById('progressBar');
            const totalItems = document.getElementById('totalItems');
            const processedItems = document.getElementById('processedItems');
            const remainingItems = document.getElementById('remainingItems');
            const currentItem = document.getElementById('currentItem');
            const resultsSection = document.getElementById('resultsSection');
            const completedItems = document.getElementById('completedItems');
            const totalCompletedItems = document.getElementById('totalCompletedItems');
            const downloadBtn = document.getElementById('downloadBtn');
            const originalText = document.getElementById('originalText');
            const newText = document.getElementById('newText');
            const testForm = document.getElementById('testForm');
            const testTextArea = document.getElementById('testTextArea');
            const testResult = document.getElementById('testResult');
            const testOriginal = document.getElementById('testOriginal');
            const testNew = document.getElementById('testNew');
            
            // Variables
            let uploadedFile = '';
            let csvData = [];
            let firstItem = null;
            
            // File upload handling
            fileUploadArea.addEventListener('click', () => fileInput.click());
            
            fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            fileUploadArea.addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });
            
            fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleFileUpload(this.files[0]);
                }
            });
            
            function handleFileUpload(file) {
                // Check file type
                if (!file.name.endsWith('.csv')) {
                    showUploadStatus('error', 'Поддерживаются только CSV файлы');
                    return;
                }
                
                showUploadStatus('loading', 'Загрузка файла...');
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('action', 'upload');
                
                fetch('api.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        uploadedFile = data.file;
                        fileName.textContent = file.name;
                        
                        // Show preview
                        showPreview(data.preview);
                        
                        showUploadStatus('success', 'Файл успешно загружен');
                        previewSection.style.display = 'block';
                    } else {
                        showUploadStatus('error', 'Ошибка: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showUploadStatus('error', 'Ошибка загрузки файла');
                });
            }
            
            function showUploadStatus(type, message) {
                uploadStatus.style.display = 'block';
                uploadStatus.className = 'alert mt-3';
                
                switch (type) {
                    case 'loading':
                        uploadStatus.classList.add('alert-info');
                        message = '<div class="spinner-border spinner-border-sm text-info me-2"></div>' + message;
                        break;
                    case 'success':
                        uploadStatus.classList.add('alert-success');
                        break;
                    case 'error':
                        uploadStatus.classList.add('alert-danger');
                        break;
                }
                
                uploadStatus.innerHTML = message;
            }
            
            function showPreview(preview) {
                if (!preview || !preview.headers || !preview.rows) return;
                
                // Keep the first item for later display
                if (preview.rows.length > 0) {
                    firstItem = preview.rows[0];
                }
                
                // Headers
                let headerHtml = '<tr>';
                preview.headers.forEach(header => {
                    headerHtml += `<th>${header}</th>`;
                });
                headerHtml += '</tr>';
                previewHead.innerHTML = headerHtml;
                
                // Rows
                let rowsHtml = '';
                preview.rows.forEach(row => {
                    rowsHtml += '<tr>';
                    preview.headers.forEach(header => {
                        let cellText = row[header] || '';
                        // Truncate long text
                        if (cellText.length > 100) {
                            cellText = cellText.substring(0, 100) + '...';
                        }
                        rowsHtml += `<td>${cellText}</td>`;
                    });
                    rowsHtml += '</tr>';
                });
                
                // Add info about more rows if needed
                if (preview.totalRows > preview.rows.length) {
                    const moreRows = preview.totalRows - preview.rows.length;
                    rowsHtml += `<tr><td colspan="${preview.headers.length}" class="text-center text-muted">...и еще ${moreRows} строк</td></tr>`;
                }
                
                previewBody.innerHTML = rowsHtml;
                csvData = preview.rows;
            }
            
            // Start processing
            startProcessing.addEventListener('click', function() {
                if (!uploadedFile) {
                    showUploadStatus('error', 'Сначала загрузите файл');
                    return;
                }
                
                previewSection.style.display = 'none';
                processingSection.style.display = 'block';
                
                // Set up event source for progress updates
                const eventSource = new EventSource(`api.php?action=process&file=${encodeURIComponent(uploadedFile)}`);
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.error) {
                        eventSource.close();
                        alert('Ошибка: ' + data.error);
                        return;
                    }
                    
                    if (data.status === 'complete') {
                        // Processing complete
                        eventSource.close();
                        
                        // Show results
                        processingSection.style.display = 'none';
                        resultsSection.style.display = 'block';
                        
                        completedItems.textContent = data.processed;
                        totalCompletedItems.textContent = data.total;
                        
                        // Set download link
                        downloadBtn.href = data.outputFile;
                        downloadBtn.download = data.outputFile.split('/').pop();
                        
                        // Try to load the first item result
                        if (firstItem && firstItem.description) {
                            originalText.textContent = firstItem.description;
                            
                            // We don't have the new description yet, so we'll use a placeholder
                            // In a real app, you would fetch this from the result file
                            newText.innerHTML = '<div class="text-center text-muted">Откройте скачанный файл для просмотра результатов</div>';
                        }
                        
                        return;
                    }
                    
                    // Update progress
                    progressBar.style.width = data.percent + '%';
                    progressBar.textContent = data.percent + '%';
                    
                    totalItems.textContent = data.total;
                    processedItems.textContent = data.processed;
                    remainingItems.textContent = data.total - data.processed;
                    
                    currentItem.textContent = data.currentItem;
                };
                
                eventSource.onerror = function() {
                    eventSource.close();
                    alert('Ошибка при обработке файла');
                };
                
                // Start the process
                const formData = new FormData();
                formData.append('action', 'process');
                formData.append('file', uploadedFile);
                
                fetch('api.php', {
                    method: 'POST',
                    body: formData
                });
            });
            
            // Test form
            testForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const description = testTextArea.value.trim();
                
                if (!description) {
                    alert('Введите описание товара для теста');
                    return;
                }
                
                // Set button to loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Обработка...';
                
                // Send test request
                const formData = new FormData();
                formData.append('action', 'test');
                formData.append('description', description);
                
                fetch('api.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    if (data.success) {
                        // Show results
                        testOriginal.textContent = data.originalDescription;
                        testNew.textContent = data.newDescription;
                        testResult.style.display = 'block';
                        
                        // Scroll to result
                        testResult.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        alert('Ошибка: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    alert('Ошибка при тестировании');
                });
            });
        });
    </script>
</body>
</html>