<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo: Автоматизация переписывания текстов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-header { background-color: #2c3e50; color: white; font-weight: 600; }
        .csv-paste-area { border: 2px dashed #3498db; border-radius: 10px; padding: 20px; transition: all 0.3s; }
        .progress { height: 25px; margin-bottom: 15px; }
        .progress-bar { transition: width 0.3s ease; }
        .stats-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        #csvTextArea { height: 200px; width: 100%; font-family: monospace; font-size: 0.9rem; }
        .description-box { height: 300px; overflow-y: auto; white-space: pre-wrap; background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center">Демо: Переписывание текстов с Claude</h1>
                <p class="lead text-center">Вставьте содержимое CSV с описаниями товаров для переписывания с помощью ИИ</p>
            </div>
        </div>

        <div class="row">
            <!-- CSV Paste Section -->
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Шаг 1: Вставьте данные CSV</h5>
                    </div>
                    <div class="card-body">
                        <div id="pasteSection">
                            <div class="csv-paste-area">
                                <label for="csvTextArea" class="form-label">Вставьте содержимое CSV файла (до 30 строк)</label>
                                <textarea id="csvTextArea" class="form-control" placeholder="ID;Название;URL;Тип;Бренд;Гарантия;Возможна скидка;Описание;..."></textarea>
                                <div class="form-text mt-2">
                                    Формат должен соответствовать CSV с разделителем ";" (точка с запятой)
                                </div>
                            </div>
                            <div class="mt-3">
                                <button id="parseButton" class="btn btn-primary">
                                    <i class="fas fa-check"></i> Распознать данные
                                </button>
                            </div>
                        </div>

                        <div id="previewSection" style="display: none;">
                            <h5>Найдено товаров: <span id="itemCount">0</span></h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Название</th>
                                            <th>Описание (фрагмент)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="previewBody"></tbody>
                                </table>
                            </div>
                            <button id="startProcessing" class="btn btn-primary mt-3">
                                <i class="fas fa-play"></i> Запустить обработку
                            </button>
                            <button id="resetParse" class="btn btn-outline-secondary mt-3 ms-2">
                                <i class="fas fa-undo"></i> Сбросить
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Progress Section -->
            <div class="col-md-12 mb-4">
                <div class="card" id="processingSection" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">Шаг 2: Прогресс обработки</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%">0%</div>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="stats-number" id="totalItems">0</div>
                                <div>Всего товаров</div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-number text-success" id="processedItems">0</div>
                                <div>Обработано</div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-number" id="remainingItems">0</div>
                                <div>Осталось</div>
                            </div>
                        </div>
                        
                        <p class="mt-3">Обрабатывается: <strong id="currentItem">-</strong></p>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="col-md-12 mb-4">
                <div class="card" id="resultsSection" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">Шаг 3: Результаты обработки</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <h4 class="alert-heading">Обработка завершена!</h4>
                            <p>Обработано товаров: <span id="completedItems">0</span> из <span id="totalCompletedItems">0</span></p>
                        </div>
                        
                        <div id="resultsTable" class="table-responsive mt-4">
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Название</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Section -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Тестирование на одном тексте</h5>
                    </div>
                    <div class="card-body">
                        <form id="testForm">
                            <div class="mb-3">
                                <label for="testTextArea" class="form-label">Введите описание товара для теста</label>
                                <textarea class="form-control" id="testTextArea" style="height: 200px" placeholder="Введите описание товара здесь..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-bolt"></i> Протестировать
                            </button>
                        </form>
                        
                        <div id="testResult" class="mt-4" style="display: none;">
                            <h5>Результат тестирования</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light text-dark">
                                            <h6 class="mb-0">Исходное описание</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="testOriginal" class="description-box"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light text-dark">
                                            <h6 class="mb-0">Новое описание</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="testNew" class="description-box"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item Details Modal -->
        <div class="modal fade" id="itemDetailsModal" tabindex="-1" aria-labelledby="itemDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="itemDetailsModalLabel">Детали товара</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light text-dark">
                                        <h6 class="mb-0">Исходное описание</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="modalOriginal" class="description-box"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light text-dark">
                                        <h6 class="mb-0">Новое описание</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="modalNew" class="description-box"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const csvTextArea = document.getElementById('csvTextArea');
            const parseButton = document.getElementById('parseButton');
            const previewSection = document.getElementById('previewSection');
            const itemCount = document.getElementById('itemCount');
            const previewBody = document.getElementById('previewBody');
            const startProcessing = document.getElementById('startProcessing');
            const resetParse = document.getElementById('resetParse');
            const processingSection = document.getElementById('processingSection');
            const progressBar = document.getElementById('progressBar');
            const totalItems = document.getElementById('totalItems');
            const processedItems = document.getElementById('processedItems');
            const remainingItems = document.getElementById('remainingItems');
            const currentItem = document.getElementById('currentItem');
            const resultsSection = document.getElementById('resultsSection');
            const completedItems = document.getElementById('completedItems');
            const totalCompletedItems = document.getElementById('totalCompletedItems');
            const resultsBody = document.getElementById('resultsBody');
            const testForm = document.getElementById('testForm');
            const testTextArea = document.getElementById('testTextArea');
            const testResult = document.getElementById('testResult');
            const testOriginal = document.getElementById('testOriginal');
            const testNew = document.getElementById('testNew');
            const itemDetailsModal = new bootstrap.Modal(document.getElementById('itemDetailsModal'));
            const modalOriginal = document.getElementById('modalOriginal');
            const modalNew = document.getElementById('modalNew');
            
            // Global data storage
            let parsedItems = [];
            let processedResults = [];
            
            // Parse CSV data
            parseButton.addEventListener('click', function() {
                const csvContent = csvTextArea.value.trim();
                
                if (!csvContent) {
                    alert('Пожалуйста, вставьте содержимое CSV');
                    return;
                }
                
                try {
                    // Parse CSV content
                    const lines = csvContent.split('\n');
                    
                    // Get header line and assume it's the first line
                    const headerLine = lines[0];
                    const headers = headerLine.split(';');
                    
                    // Find indexes for ID, Название and Описание columns
                    const idIndex = headers.indexOf('ID');
                    const nameIndex = headers.indexOf('Название');
                    const descIndex = headers.indexOf('Описание');
                    
                    if (idIndex === -1 || nameIndex === -1 || descIndex === -1) {
                        alert('CSV должен содержать колонки "ID", "Название" и "Описание"');
                        return;
                    }
                    
                    // Parse items (limit to 30 for browser performance)
                    parsedItems = [];
                    const maxLines = Math.min(lines.length, 31); // Header + 30 data lines
                    
                    for (let i = 1; i < maxLines; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Use regular expression to handle quoted fields with semicolons
                        const values = line.match(/(?:\"([^\"]*(?:\"\"[^\"]*)*)\")|([^\";]+)/g);
                        
                        if (values && values.length >= Math.max(idIndex, nameIndex, descIndex) + 1) {
                            // Clean values (remove quotes)
                            const cleanValues = values.map(val => val.replace(/^"|"$/g, '').replace(/""/g, '"'));
                            
                            // Get description and strip HTML tags
                            let description = cleanValues[descIndex] || '';
                            description = description.replace(/<\/?[^>]+(>|$)/g, '');
                            
                            parsedItems.push({
                                id: cleanValues[idIndex],
                                name: cleanValues[nameIndex],
                                description: description,
                                originalHtml: cleanValues[descIndex]
                            });
                        }
                    }
                    
                    // Show preview
                    itemCount.textContent = parsedItems.length;
                    
                    // Generate preview rows
                    let previewHtml = '';
                    parsedItems.forEach(item => {
                        const shortDesc = item.description.length > 100 ? 
                            item.description.substring(0, 100) + '...' : 
                            item.description;
                            
                        previewHtml += `
                            <tr>
                                <td>${item.id}</td>
                                <td>${item.name}</td>
                                <td>${shortDesc}</td>
                            </tr>
                        `;
                    });
                    
                    previewBody.innerHTML = previewHtml;
                    previewSection.style.display = 'block';
                    
                } catch (error) {
                    console.error('Parsing error:', error);
                    alert('Ошибка при разборе CSV данных');
                }
            });
            
            // Reset parsing
            resetParse.addEventListener('click', function() {
                previewSection.style.display = 'none';
                parsedItems = [];
                csvTextArea.value = '';
            });
            
            // Start processing
            startProcessing.addEventListener('click', function() {
                if (parsedItems.length === 0) {
                    alert('Нет данных для обработки');
                    return;
                }
                
                // Show processing section
                previewSection.style.display = 'none';
                processingSection.style.display = 'block';
                
                // Reset progress
                processedResults = [];
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                totalItems.textContent = parsedItems.length;
                processedItems.textContent = '0';
                remainingItems.textContent = parsedItems.length;
                currentItem.textContent = '-';
                
                // Process items sequentially
                processItems();
            });
            
            // Process items sequentially
            async function processItems() {
                const total = parsedItems.length;
                
                for (let i = 0; i < parsedItems.length; i++) {
                    const item = parsedItems[i];
                    
                    // Update progress
                    const progress = Math.round(((i + 1) / total) * 100);
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    processedItems.textContent = i + 1;
                    remainingItems.textContent = total - (i + 1);
                    currentItem.textContent = item.name;
                    
                    try {
                        // Process the item
                        const result = await processItem(item);
                        processedResults.push({
                            ...item,
                            newDescription: result.newDescription
                        });
                    } catch (error) {
                        console.error('Error processing item:', error);
                        processedResults.push({
                            ...item,
                            newDescription: 'Ошибка: ' + error.message,
                            error: true
                        });
                    }
                }
                
                // Show results
                showResults();
            }
            
            // Process a single item
            async function processItem(item) {
                const formData = new FormData();
                formData.append('action', 'test');
                formData.append('description', item.originalHtml || item.description);
                
                const response = await fetch('api.php', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }
                
                return {
                    newDescription: data.newDescription
                };
            }
            
            // Show results
            function showResults() {
                processingSection.style.display = 'none';
                resultsSection.style.display = 'block';
                
                completedItems.textContent = processedResults.length;
                totalCompletedItems.textContent = parsedItems.length;
                
                // Generate results table
                let resultsHtml = '';
                processedResults.forEach((result, index) => {
                    const statusClass = result.error ? 'text-danger' : 'text-success';
                    const statusText = result.error ? 'Ошибка' : 'Готово';
                    
                    resultsHtml += `
                        <tr>
                            <td>${result.id}</td>
                            <td>${result.name}</td>
                            <td>
                                <span class="${statusClass}">${statusText}</span>
                                <button class="btn btn-sm btn-primary ms-2 view-details" data-index="${index}">
                                    <i class="fas fa-eye"></i> Просмотр
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                resultsBody.innerHTML = resultsHtml;
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-details').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        const item = processedResults[index];
                        
                        // Set modal content
                        document.getElementById('itemDetailsModalLabel').textContent = 
                            `Товар: ${item.name} (ID: ${item.id})`;
                        modalOriginal.innerHTML = item.originalHtml || item.description;
                        modalNew.textContent = item.newDescription;
                        
                        // Show modal
                        itemDetailsModal.show();
                    });
                });
            }
            
            // Test form
            testForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const description = testTextArea.value.trim();
                
                if (!description) {
                    alert('Введите описание товара для теста');
                    return;
                }
                
                // Set button to loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Обработка...';
                
                // Send test request
                const formData = new FormData();
                formData.append('action', 'test');
                formData.append('description', description);
                
                fetch('api.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    if (data.success) {
                        // Show results
                        testOriginal.textContent = data.originalDescription;
                        testNew.textContent = data.newDescription;
                        testResult.style.display = 'block';
                        
                        // Scroll to result
                        testResult.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        alert('Ошибка: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    alert('Ошибка при тестировании');
                });
            });
        });
    </script>
</body>
</html>
