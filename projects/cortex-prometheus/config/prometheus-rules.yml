groups:
- name: node_alerts
  rules:
  - alert: InstanceDown
    expr: up == 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Instance {{ $labels.instance }} down"
      description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes."

  - alert: HighCpuLoad
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High CPU load on {{ $labels.instance }}"
      description: "CPU load is > 80% on {{ $labels.instance }} for the last 10 minutes."

  - alert: HighMemoryUsage
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage on {{ $labels.instance }}"
      description: "Memory usage is > 85% on {{ $labels.instance }} for the last 10 minutes."

  - alert: LowDiskSpace
    expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 < 10
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Low disk space on {{ $labels.instance }} ({{ $labels.mountpoint }})"
      description: "Disk space is less than 10% on {{ $labels.instance }} at {{ $labels.mountpoint }}."

- name: prometheus_alerts
  rules:
  - alert: PrometheusTargetMissing
    expr: up == 0
    for: 15m
    labels:
      severity: critical
    annotations:
      summary: "Prometheus target missing (instance {{ $labels.instance }})"
      description: "A Prometheus target has been missing for more than 15 minutes."

  - alert: PrometheusTooManyRestarts
    expr: changes(process_start_time_seconds{job=~"prometheus|cortex.*"}[15m]) > 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Prometheus too many restarts (instance {{ $labels.instance }})"
      description: "Prometheus has restarted more than twice in the last 15 minutes."

- name: cortex_alerts
  rules:
  - alert: CortexIngesterUnhealthy
    expr: cortex_ring_members{state="Unhealthy", name="ingester"} > 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Cortex ingester unhealthy"
      description: "Cortex ingester is marked as unhealthy for more than 5 minutes."

  - alert: CortexDistributorHighErrorRate
    expr: sum(rate(cortex_distributor_errors_total[5m])) / sum(rate(cortex_distributor_received_samples_total[5m])) > 0.05
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Cortex distributor high error rate"
      description: "Cortex distributor error rate is higher than 5% for more than 5 minutes."