# Матрица отслеживания требований

## 1. Таблица отслеживания

| ID требования | Описание требования | BDD сценарий | Компоненты для реализации | Файлы конфигурации | Статус реализации | Статус тестирования |
|---------------|---------------------|--------------|---------------------------|-------------------|-------------------|---------------------|
| REQ-01 | Сбор метрик с большого количества хостов | BDD-01 | Prometheus, Node Exporter | prometheus.yml, install_node_exporter.sh | Реализовано | Протестировано |
| REQ-02 | Горизонтальное масштабирование | BDD-02 | Cortex Distributor, Cortex Ingester | cortex.yml, kubernetes/cortex-deployment.yaml | Реализовано | Протестировано |
| REQ-03 | Долгосрочное хранение метрик | BDD-03 | Cortex, MinIO | cortex.yml | Реализовано | Протестировано |
| REQ-04 | Высокая доступность компонентов | BDD-04 | Репликация компонентов | kubernetes manifests | Реализовано | Протестировано |
| REQ-05 | Визуализация метрик | BDD-05 | Grafana | config/grafana/provisioning/datasources/datasources.yml, kubernetes/grafana-deployment.yaml | Реализовано | Протестировано |
| REQ-06 | Алертинг при нарушениях | BDD-06 | AlertManager, Cortex Ruler | alertmanager.yml, prometheus-rules.yml | Реализовано | Протестировано |
| REQ-07 | Настройка политик хранения | BDD-07 | Cortex Compactor | cortex.yml | Реализовано | Протестировано |
| REQ-08 | Оптимизация запросов | BDD-08 | Cortex Query Frontend | cortex.yml | Реализовано | Протестировано |
| REQ-09 | Удобное добавление новых хостов | BDD-09 | add_hosts.sh | setup_monitoring.sh | Реализовано | Протестировано |
| REQ-10 | Мониторинг самой системы мониторинга | BDD-10 | Prometheus, дашборды Grafana | prometheus.yml, grafana-dashboards | Реализовано | Протестировано |

## 2. Соответствие требований и файлов решения

### REQ-01: Сбор метрик с большого количества хостов
- **Файлы реализации**: 
  - `prometheus.yml` - конфигурация сборщика метрик
  - `install_node_exporter.sh` - скрипт установки экспортера на хосты
- **Механизм реализации**: Настройка динамического обнаружения хостов через file_sd_configs в Prometheus

### REQ-02: Горизонтальное масштабирование
- **Файлы реализации**: 
  - `cortex.yml` - настройка шардирования и репликации
  - `kubernetes/cortex-deployment.yaml` - манифесты Kubernetes для масштабирования
- **Механизм реализации**: Настройка Cortex со stateful компонентами и возможностью репликации в Kubernetes

### REQ-03: Долгосрочное хранение метрик
- **Файлы реализации**: 
  - `cortex.yml` - конфигурация хранения
  - `k8s-storage.yaml` - настройка хранилища в Kubernetes
- **Механизм реализации**: Настройка blocks_storage с S3-совместимым хранилищем и политиками хранения

### REQ-04: Высокая доступность компонентов
- **Файлы реализации**: 
  - `kubernetes/cortex-deployment.yaml`, `kubernetes/prometheus-deployment.yaml`, `kubernetes/storage-deployment.yaml` - репликация и кластеризация компонентов
- **Механизм реализации**: Мультиреплика для критических компонентов в Kubernetes, кластерная конфигурация Consul/MinIO/Prometheus/Cortex

### REQ-05: Визуализация метрик
- **Файлы реализации**: 
  - `config/grafana/provisioning/datasources/datasources.yml` - настройка источников данных для Docker Compose
  - `kubernetes/grafana-deployment.yaml` - дашборды и конфигурация Grafana для Kubernetes
- **Механизм реализации**: Настройка Grafana с предустановленными дашбордами и источниками данных

### REQ-06: Алертинг при нарушениях
- **Файлы реализации**: 
  - `alertmanager.yml` - конфигурация AlertManager
  - `prometheus-rules.yml` - правила алертинга
- **Механизм реализации**: Настройка правил алертинга и каналов уведомлений

### REQ-07: Настройка политик хранения
- **Файлы реализации**: 
  - `cortex.yml` - настройка Compactor и политик хранения
- **Механизм реализации**: Конфигурация периодов хранения и сжатия данных

### REQ-08: Оптимизация запросов
- **Файлы реализации**: 
  - `cortex.yml` - настройка Query Frontend
- **Механизм реализации**: Настройка кэширования, разделения запросов и параллельного выполнения

### REQ-09: Удобное добавление новых хостов
- **Файлы реализации**: 
  - `setup_monitoring.sh` - основной скрипт настройки
  - Генерация скрипта `add_hosts.sh` для управления таргетами
- **Механизм реализации**: Упрощенный интерфейс для добавления хостов через скрипт

### REQ-10: Мониторинг самой системы мониторинга
- **Файлы реализации**: 
  - `prometheus.yml` - настройка сбора метрик с компонентов
  - Дашборды Grafana для мониторинга компонентов
- **Механизм реализации**: Настройка скрейпинга компонентов Prometheus и Cortex

## 3. Покрытие требований тестами

| ID требования | BDD сценарий | Метод проверки | Тестовый скрипт |
|---------------|--------------|----------------|-----------------|
| REQ-01 | BDD-01 | Проверка наличия метрик со всех хостов | verify_deployment.sh |
| REQ-02 | BDD-02 | Тест нагрузки с масштабированием | Ручное тестирование |
| REQ-03 | BDD-03 | Проверка сохранения метрик в MinIO | verify_deployment.sh |
| REQ-04 | BDD-04 | Тест отказоустойчивости | Ручное тестирование |
| REQ-05 | BDD-05 | Проверка загрузки дашбордов | verify_deployment.sh |
| REQ-06 | BDD-06 | Тест срабатывания алертов | Ручное тестирование |
| REQ-07 | BDD-07 | Проверка политик хранения | Ручное тестирование |
| REQ-08 | BDD-08 | Тест производительности запросов | Ручное тестирование |
| REQ-09 | BDD-09 | Проверка добавления хостов | verify_deployment.sh |
| REQ-10 | BDD-10 | Проверка сбора метрик о компонентах | verify_deployment.sh |
