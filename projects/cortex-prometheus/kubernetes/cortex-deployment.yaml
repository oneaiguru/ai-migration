apiVersion: v1
kind: ConfigMap
metadata:
  name: cortex-config
data:
  cortex.yml: |
    auth_enabled: true

    server:
      http_listen_port: 9009

    distributor:
      shard_by_all_labels: true
      pool:
        health_check_ingesters: true

    ingester:
      lifecycler:
        ring:
          kvstore:
            store: consul
            prefix: collectors/
          replication_factor: 3
        final_sleep: 0s
      chunk_idle_period: 30m
      chunk_retention_period: 1m
      max_transfer_retries: 0

    storage:
      engine: blocks

    blocks_storage:
      backend: s3
      s3:
        endpoint: minio:9000
        bucket_name: cortex-blocks
        access_key_id: ${MINIO_ACCESS_KEY}
        secret_access_key: ${MINIO_SECRET_KEY}
        insecure: true
      tsdb:
        dir: /data/tsdb
        retention_period: 30d
        block_ranges_period: [2h, 12h, 24h]
        ship_interval: 1m
        block_sync_concurrency: 20
        consistency_delay: 30s

    compactor:
      data_dir: /data/compactor
      sharding_enabled: true
      sharding_ring:
        kvstore:
          store: consul
          prefix: compactor/

    frontend:
      log_queries_longer_than: 10s
      compress_responses: true
      cache_results: true
      max_outstanding_per_tenant: 2048
      
    store_gateway:
      sharding_enabled: true
      sharding_ring:
        kvstore:
          store: consul
          prefix: store-gateway/

    ruler:
      enable_api: true
      enable_sharding: true
      ring:
        kvstore:
          store: consul
          prefix: ruler/
      storage:
        type: s3
        s3:
          endpoint: minio:9000
          bucket_name: cortex-rules
          access_key_id: ${MINIO_ACCESS_KEY}
          secret_access_key: ${MINIO_SECRET_KEY}
          insecure: true

    limits:
      max_label_name_length: 1024
      max_label_value_length: 2048
      max_label_names_per_series: 64
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      ingestion_rate: 25000
      ingestion_burst_size: 50000

---
# Cortex Distributor
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cortex-distributor
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cortex-distributor
  template:
    metadata:
      labels:
        app: cortex-distributor
    spec:
      containers:
      - name: cortex-distributor
        image: cortexproject/cortex:v1.18.1
        args:
        - "-target=distributor"
        - "-config.file=/etc/cortex/cortex.yml"
        - "-config.expand-env=true"
        ports:
        - containerPort: 9009
        volumeMounts:
        - name: cortex-config
          mountPath: /etc/cortex
        readinessProbe:
          httpGet:
            path: /ready
            port: 9009
          initialDelaySeconds: 15
          timeoutSeconds: 1
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accessKey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretKey
      volumes:
      - name: cortex-config
        configMap:
          name: cortex-config
---
apiVersion: v1
kind: Service
metadata:
  name: cortex-distributor
spec:
  selector:
    app: cortex-distributor
  ports:
  - port: 9009
    targetPort: 9009
  type: ClusterIP
---
# Cortex Ingester
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cortex-ingester
spec:
  serviceName: "cortex-ingester"
  replicas: 3
  selector:
    matchLabels:
      app: cortex-ingester
  template:
    metadata:
      labels:
        app: cortex-ingester
    spec:
      containers:
      - name: cortex-ingester
        image: cortexproject/cortex:v1.18.1
        args:
        - "-target=ingester"
        - "-config.file=/etc/cortex/cortex.yml"
        - "-config.expand-env=true"
        ports:
        - containerPort: 9009
        volumeMounts:
        - name: cortex-config
          mountPath: /etc/cortex
        - name: ingester-data
          mountPath: /data
        readinessProbe:
          httpGet:
            path: /ready
            port: 9009
          initialDelaySeconds: 15
          timeoutSeconds: 1
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accessKey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretKey
      volumes:
      - name: cortex-config
        configMap:
          name: cortex-config
  volumeClaimTemplates:
  - metadata:
      name: ingester-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 50Gi
---
apiVersion: v1
kind: Service
metadata:
  name: cortex-ingester
spec:
  selector:
    app: cortex-ingester
  ports:
  - port: 9009
    targetPort: 9009
  type: ClusterIP
---
# Cortex Query Frontend
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cortex-query-frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cortex-query-frontend
  template:
    metadata:
      labels:
        app: cortex-query-frontend
    spec:
      containers:
      - name: cortex-query-frontend
        image: cortexproject/cortex:v1.18.1
        args:
        - "-target=query-frontend"
        - "-config.file=/etc/cortex/cortex.yml"
        - "-config.expand-env=true"
        - "-server.http_listen_port=9010"
        ports:
        - containerPort: 9010
        volumeMounts:
        - name: cortex-config
          mountPath: /etc/cortex
        readinessProbe:
          httpGet:
            path: /ready
            port: 9010
          initialDelaySeconds: 15
          timeoutSeconds: 1
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accessKey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretKey
      volumes:
      - name: cortex-config
        configMap:
          name: cortex-config
---
apiVersion: v1
kind: Service
metadata:
  name: cortex-query-frontend
spec:
  selector:
    app: cortex-query-frontend
  ports:
  - port: 9010
    targetPort: 9010
  type: ClusterIP
---
# Cortex Store Gateway
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cortex-store-gateway
spec:
  serviceName: "cortex-store-gateway"
  replicas: 2
  selector:
    matchLabels:
      app: cortex-store-gateway
  template:
    metadata:
      labels:
        app: cortex-store-gateway
    spec:
      containers:
      - name: cortex-store-gateway
        image: cortexproject/cortex:v1.18.1
        args:
        - "-target=store-gateway"
        - "-config.file=/etc/cortex/cortex.yml"
        - "-config.expand-env=true"
        ports:
        - containerPort: 9009
        volumeMounts:
        - name: cortex-config
          mountPath: /etc/cortex
        - name: store-gateway-data
          mountPath: /data
        readinessProbe:
          httpGet:
            path: /ready
            port: 9009
          initialDelaySeconds: 15
          timeoutSeconds: 1
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accessKey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretKey
      volumes:
      - name: cortex-config
        configMap:
          name: cortex-config
  volumeClaimTemplates:
  - metadata:
      name: store-gateway-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 20Gi
---
apiVersion: v1
kind: Service
metadata:
  name: cortex-store-gateway
spec:
  selector:
    app: cortex-store-gateway
  ports:
  - port: 9009
    targetPort: 9009
  type: ClusterIP
---
# Cortex Compactor
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cortex-compactor
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cortex-compactor
  template:
    metadata:
      labels:
        app: cortex-compactor
    spec:
      containers:
      - name: cortex-compactor
        image: cortexproject/cortex:v1.18.1
        args:
        - "-target=compactor"
        - "-config.file=/etc/cortex/cortex.yml"
        - "-config.expand-env=true"
        ports:
        - containerPort: 9009
        volumeMounts:
        - name: cortex-config
          mountPath: /etc/cortex
        - name: compactor-data
          mountPath: /data
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accessKey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretKey
      volumes:
      - name: cortex-config
        configMap:
          name: cortex-config
      - name: compactor-data
        emptyDir: {}
---
# Cortex Ruler
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cortex-ruler
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cortex-ruler
  template:
    metadata:
      labels:
        app: cortex-ruler
    spec:
      containers:
      - name: cortex-ruler
        image: cortexproject/cortex:v1.18.1
        args:
        - "-target=ruler"
        - "-config.file=/etc/cortex/cortex.yml"
        - "-config.expand-env=true"
        ports:
        - containerPort: 9009
        volumeMounts:
        - name: cortex-config
          mountPath: /etc/cortex
        - name: ruler-data
          mountPath: /data
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accessKey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretKey
      volumes:
      - name: cortex-config
        configMap:
          name: cortex-config
      - name: ruler-data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: cortex-ruler
spec:
  selector:
    app: cortex-ruler
  ports:
  - port: 9009
    targetPort: 9009
  type: ClusterIP
