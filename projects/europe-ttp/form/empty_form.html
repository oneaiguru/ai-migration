<script type="text/javascript" src="javascript/typeahead.bundle.js"></script>
<link rel="stylesheet" type="text/css" href="styles/an-typeahead.css">

<script type="text/javascript">

  // [START global_variables] ---------------------------------------------------------------------------
  var form_agreement = JSON.parse('{{form_agreement|safe}}');
  var repeat_question_list = JSON.parse('{{repeat_question_list|safe}}');
  var form_instance_list = JSON.parse('{{form_instance_list|safe}}');
  var form_is_multi_instance = {{form_is_multi_instance}};
  var dep_list = JSON.parse('{{questions_dep_list|safe}}');
  var no_of_pages = {{no_of_pages}};
  var curr_page_no = {{page_no}};
  var is_form_uneditable = false;
  var is_new_form = true;

  var is_user_whitelisted = '{{is_user_whitelisted}}';

  // This is not defined as a constant since if empty_form reloads it causes redefinition issue
  var REPEATER_DISPLAY_INPUT_CNT = 2;
  // [END global_variables] -----------------------------------------------------------------------------

  var tempYes = function () {};
  var tempNo = function () {};

  function disableInputs(is_recoverable, is_editable = true) {
    // console.log('[disableInputs] is_recoverable = ' + is_recoverable.toString());
    // console.log('[disableInputs] is_form_uneditable = ' + is_form_uneditable.toString());
    $("input[id^=i_],textarea[id^=i_],select[id^=i_]").prop("disabled", true);
    if (!is_recoverable) {
      is_form_uneditable = true;
      // $("[name='btns_save_submit']").remove();
      $("[name='btns_save_submit']").hide();
      if (is_editable) {
        $("[name='btns_edit']").show();
      } else {
        $("[name='btns_edit']").hide();
      }
      $("[name='btns_copy']").show();
      $("[name='btns_start_new']").show();
      $('#step_submit').show();
    } else {
      $('#step_submit').hide();
    }
    // console.log('[disableInputs] is_form_uneditable = ' + is_form_uneditable.toString());
  }

  function enableInputs(reenable_editing) {
    // console.log('[enableInputs] is_form_uneditable = ' + is_form_uneditable.toString());
    if (reenable_editing) {
      is_form_uneditable = false;
      $("[name='btns_start_new']").hide();
      $("[name='btns_edit']").hide();
      $("[name='btns_copy']").hide();
      $("[name='btns_save_submit']").show();
    }
    if (!is_form_uneditable) {
      // console.log('[enableInputs] Enabling inputs');
      $('.page:not(page1)').find("input[id^=i_],textarea[id^=i_],select[id^=i_]").prop("disabled", false);
      $('#step_submit').show();
    }
  }

  // [START country_drop_down]
  var countries_raw = {{countries|safe}};

  var countries_arr = [];
  var countries_map = {};
  var countries_iso_abbr_map = {};
  for (var i = 0; i < countries_raw.length; i++) {
    // countries_arr.push(countries_raw[i]['name'] + " [" + countries_raw[i]['iso_abbr'] + "]");
    countries_arr.push(countries_raw[i]['name']);
    countries_map[countries_raw[i]['name']] = countries_raw[i]['iso_abbr'];
    countries_iso_abbr_map[countries_raw[i]['iso_abbr']] = countries_raw[i]['name'];
  }

  $(document).data('countries_map', countries_map);

  var countries = new Bloodhound({
    datumTokenizer: Bloodhound.tokenizers.whitespace,
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: countries_arr
  });

  $('#i_country_dropdown .typeahead').typeahead(null, {
    name: 'countries',
    limit: 10,
    source: countries
  });

  if ('{{user_country}}' && '{{user_country}}'.trim() != '') {
    try {
      $('#i_country_dropdown .typeahead').typeahead('val',countries_iso_abbr_map['{{user_country}}']);
    } 
    catch(err) {
      console.log("unknown country");
    }
  }
  // [END country_drop_down]

  function new_repeat_entry(id) {
    console.log("[new_repeat_entry] New repeat entry for " + id);
    $('#'+id).append($('<option>', {
      value: "new_entry", 
      text: "New Entry"
    }));
    $('#'+id).val("new_entry");
    var input_list = repeat_question_list[id];
    for (var i = 0; i < input_list.length; i++) {
      console.log("[new_repeat_entry] Enabling " + input_list[i]);
      $('#'+input_list[i]).val("");

      $("label[for='"+input_list[i]+"']").show();
      $('#'+input_list[i]).show();
      $("label[for="+input_list[i]+"_hidden]").show();
      $('#'+input_list[i]+'_hidden').show();
      $('input[name='+input_list[i]+']').show();
      $('div[name='+input_list[i]+']').show();
      $('label[name='+input_list[i]+']').show();
    }
    $('#'+id+'_save').show();
  }

  function remove_repeat_entry(id) {
    var _val = $('#'+id).val();
    if (_val == 'new_entry') {
      $('#'+id).val("summary").change();
    } else {
      if (_val == "" || _val == 'summary' || _val == 'new_entry') {
        postErrorMessage("Please select an entry from the dropdown to delete");
        return false;
      } else {
        console.log("[remove_repeat_entry][" + id + "] Removing entry for: " + _val);
        $("#"+id+" option[value='"+_val+"']").remove();
        $('#'+id).val("summary").change();
      }
    }
  }

  function save_repeat_entry(id) {
    var _val = $('#'+id).val();
    if (_val == 'new_entry') {
      var input_list = repeat_question_list[id];
      if(!checkFieldsNonEmpty(input_list)) {
        postErrorMessage("Please enter all details to save");
        return false;
      }
      if (true) {//checkEmailField('i_eval_teacher_email')) {

        // [START setting_display_name_for_repeat_entry]
        var _name = "";
        for (let i = 0; i < Math.min(input_list.length, REPEATER_DISPLAY_INPUT_CNT); i++) {
          let _n = "";
          const _ip_id = input_list[i];
          var _ip = $('#' + _ip_id);
          if (_ip.val()) {
            _n = _ip.val().trim();
            var _input_type = _ip.attr('type');
            if (_input_type && _input_type != 'hidden') {
              if (_input_type == 'checkbox' || _input_type == 'radio') {
                _n = $("label[for='" + _ip_id + "']");
              } else {
                _n = _ip.val();
              }
            } else if (_ip.is("select")) {
              _n = $('#' + _ip_id + ' option:selected').text();
            }
          }
          if (_n != "") {
            if (_name != "") {
              _name += " • ";
            }
            _name += _n;
          }
        }
        if (_name == "") {
          _name = "Entry";
        }
        // [END setting_display_name_for_repeat_entry]

        var _obj = {};
        for (var i = 0; i < input_list.length; i++) {
          // if hidden elements, then check if radio or checkbox
          var _i_hidden = $('#'+input_list[i]+'_hidden');
          if(_i_hidden.length > 0) {
            if (_i_hidden.val() == 'checkbox_group') {
              $('input[id^='+input_list[i]+'][type=checkbox]').each(function(i, obj) {
                if ($(this).is(':visible')) {
                  console.log("[save_repeat_entry] Saving " + input_list[i]);
                  var _i_val = document.getElementById($(this).attr('id')).checked;
                  _obj[$(this).attr('id')] = _i_val;
                }
              });
            } else if (_i_hidden.val() == 'radio') {
              var _checked_radio = $('input[name='+input_list[i]+']:checked');
              if (_checked_radio && _checked_radio.is(':visible')) {
                console.log("[save_repeat_entry] Saving " + input_list[i]);
                var _i_val = _checked_radio.val();
                _obj[input_list[i]] = _i_val;
              }
            }
          } else {
            if ($('#'+input_list[i]).is(':visible')) {
              console.log("[save_repeat_entry] Saving " + input_list[i]);
              var _i_val = $('#'+input_list[i]).val();
              if (_i_val) {
                _obj[input_list[i]] = _i_val.trim();
              }
            }
          }
        }
        var _val = JSON.stringify(_obj);
        $('#'+id).append($('<option>', {
          value: _val, 
          text: _name
        }));
        console.log("[save_repeat_entry] Saving to dropdown");
        // $("#"+id+" option[value='new_entry']").remove();
        $('#'+id).val("summary").change();
        postDoneMessage("Entry Added");
      }
    }
  }

  function hideDependentInputsOnLoad() {
        // Hiding dependent elements
    var _dep_list = JSON.parse('{{questions_dep_list|safe}}');
    for (_id in _dep_list) {
      var _ip = $('#' + _id);
      console.log('[hideDependentInputsOnLoad] Checking dependent inputs for ' + _id);
      var _val;
      if (!_ip) {
        _ip = $('input[name=' + _id + ']');
      }
      var _input_type = _ip.attr('type');
      if (_input_type && _input_type != 'hidden') {
        if (_input_type == 'checkbox') {
          _val = document.getElementById(_id).checked;
        } else if (_input_type == 'radio') {
          _val = $('input[name=' + _name + ']:checked').val();
        } else {
          _val = _ip.val();
        }
      } else if ($('#' + _id).is("select")) {
        _val = _ip.val();
      }
      if (!_val) {
        console.log('[hideDependentInputsOnLoad] Did not find val for ' + _id);
        
        let _l_ids = _dep_list[_id]["all"];
        for (let i = 0; i < _l_ids.length; i++) {
          const _d_id = _l_ids[i];
          console.log('[hideDependentInputsOnLoad] Hiding ' + _d_id);
          $('#' + _d_id).hide();
          $("label[for='" + _d_id + "']").hide();
          $('div[name=' + _d_id + ']').hide();
          $('input[name=' + _d_id + ']').hide();
        }
      } else {
        console.log('[hideDependentInputsOnLoad] Found val ' + _val + ' for  ' + _id);
      }
    }
  }

  function hideDependentInputs(id) {
    console.log('[hideDependentInputs] id = ' + id);
    if (id in dep_list) {
      var dep_id_list = dep_list[id]["all"];
      for (var i = 0; i < dep_id_list.length; i++) {
        $('#'+dep_id_list[i]).hide();
        $("label[for='"+dep_id_list[i]+"']").hide();
        $('div[name='+dep_id_list[i]+']').hide();
        // recursively hide inputs
        hideDependentInputs(dep_id_list[i]);
      }
    }
  }

  function showDependentInputs(id) {    
    if (id in dep_list) {
      hideDependentInputs(id);

      var val = $('#'+id).val();
      if (!val) {
        val = $("input[name='"+id+"']:checked").val();
      }
      if (val in dep_list[id]) {
        var dep_id_list = dep_list[id][val];
        for (var i = 0; i < dep_id_list.length; i++) {
          $('#'+dep_id_list[i]).show();
          $("label[for='" + dep_id_list[i] + "']").show();
          $('div[name=' + dep_id_list[i] + ']').show();
          $('input[name=' + dep_id_list[i] + ']').show();
          showDependentInputs(dep_id_list[i]);
        }
      }
    }
  }

  function nextPage() {
    if (curr_page_no == 1) {
      if (!checkAndDisableFormInstanceIdentifierPage(false)) {
        postErrorMessage("You need to complete this page before you can move forward. Please ensure you enter valid email addresses as well.");
        return false;
      }
    }
    if (curr_page_no < no_of_pages) {
      $('#page'+(curr_page_no).toString()).hide();
      $('#page'+(curr_page_no+1).toString()).show();
      curr_page_no += 1;
      updateQueryStringParameter(window.location.href, "page_no", curr_page_no);
      $('#curr_page_no').html(curr_page_no);
      // if previous page was 0, set to blank
      if (curr_page_no == 1) {
        $('page0').remove();
        if ($('#i_form_submitted').val() != "true") {
          enableInputs(false);
        }
      }
    }
  }

  function prevPage() {
    if (curr_page_no > 1) {
      $('#page'+(curr_page_no).toString()).hide();
      $('#page'+(curr_page_no-1).toString()).show();
      curr_page_no -= 1;
      updateQueryStringParameter(window.location.href, "page_no", curr_page_no);
      $('#curr_page_no').html(curr_page_no);
    }
  }

  function goToPage1() {
    if (curr_page_no > 1) {
      $('#page'+(curr_page_no).toString()).hide();
      $('#page1').show();
      curr_page_no = 1;
      updateQueryStringParameter(window.location.href, "page_no", curr_page_no);
      $('#curr_page_no').html(curr_page_no);
    }
  }

  function getPageData(pageNo) {
    var _form_data = {};
    var _parent;

    if (pageNo != -1) {
      _parent = $('#page'+(pageNo).toString())

      if (pageNo == 1) {
        var _is_form_instance_identifier = $('#page1').attr('is-form-instance-identifier');
        if (_is_form_instance_identifier == 'true') {
          _parent.find('div.display_only_textbox').each(function(i, obj) {
            var _id = $("label[for='"+$(this).attr('id')+"']").html().replace(/ /g,"_").toLowerCase();
            _form_data[_id] = $(this).html();
            console.log('[getPageData] ' + _id + ' = ' + $(this).html());
          });
        }
      }
    } else {
      // _parent = $(document);
      _parent = $('#step_form');
    }

    var _repeat_questions_arr = [];
    for(var id in repeat_question_list) {
      _repeat_questions_arr.push.apply(_repeat_questions_arr, repeat_question_list[id]);
    }
    _parent.find("input[id^=i_],textarea[id^=i_],select[id^=i_]").each(function(i, obj) {
      var _id = $(this).attr('id');
      var _name = $(this).attr('name');
      if (!_repeat_questions_arr.includes(_id)) {
        if ($(this).attr('form-entry-type') && $(this).attr('form-entry-type') == 'repeater') {
          _form_data[_id] = []
          $(this).find('option').each(function(i, obj){
            var _val = this.getValue();
            if (_val != 'summary' && _val != 'new_entry') {
              try {
                var _form_entry = JSON.parse(_val);
                _form_data[_id].push(_form_entry);
              } catch(e) {
                console.log("[ERROR] [getPageData] unable to parse " + _val);
              }
            }
          });
        } else {
          var _input_type = $(this).attr('type');
          if (_input_type && _input_type.toLowerCase() == 'radio') {
            _form_data[_name] = document.getElementById(_id).getValue();
          } else {
            if (_input_type && _input_type.toLowerCase() == 'checkbox') {
              if (!_form_data.hasOwnProperty(_name)) {
                _form_data[_name] = [];
              }
              if (document.getElementById(_id).checked) {
                _form_data[_name].push(document.getElementById(_id).text_label.textContent);
              }
            }

            _form_data[_id] = document.getElementById(_id).getValue();
          }
        }
      }
    });
    return _form_data;
  }

  function savePage(is_submit) {
    if (is_submit) {
      $('#i_form_submitted').val("true");
    }

    // Disable form identifier page if its complete
    if(curr_page_no == 1 && !checkAndDisableFormInstanceIdentifierPage(false)) {
      postStatusBarErrorMessage("You need complete this page before you can save",0,true);
      return false;
    }

    var _form_data = getPageData(-1);

    {% if IS_DEV == 'Y' %}
    console.log("[savePage] data = \n" + JSON.stringify(_form_data));
    {% endif %}

    var _instance_data = getFormInstanceData();
    var _instance_identifier = _instance_data['instance_identifier'];
    var _instance_display = _instance_data['instance_display'];
    var _instance_identifier_page_data = _instance_data['instance_identifier_page_data'];
    var _instance_disabled_flg = _instance_data['instance_disabled_flg'];
    if (is_user_whitelisted !== 'Y' && _instance_disabled_flg) {
      postStatusBarErrorMessage("Looks like you are past the deadline for saving this {{form_name}}", 0, true);
      return false;
    }

    console.log('[savePage] form_instance = ' + _instance_identifier);

    var jqxhr = $.post( "/users/upload-form-data", 
    {
      form_type: '{{form_type}}',
      form_data: JSON.stringify(_form_data),
      form_instance: _instance_identifier,
      form_instance_page_data: JSON.stringify(_instance_identifier_page_data),
      form_instance_display: _instance_display,
      user_home_country_iso: $('#user_home_country_iso').val(),
      user_home_country: $('#user_home_country').html()
    })
    .done(function(data) {
      // alert(data);
      try {
        var params = JSON.parse(data);
        var _msg = params.message;
        if (_msg) {
          $('#step_post_submit_message').html(_msg);
        }
      } catch(err) {
        console.log("[savePage] could not parse return data");
      }
      if (is_submit) {
        postDoneMessage("Your form has been submitted");
        disableInputs(false, true);
      } else {
        postDoneMessage("Your data has been saved");
      }
    })
    .fail(function() {
      // alert("failed1");
      postErrorMessage("There was an error saving your data");
      $('#step_post_submit_message').html("There was an error saving your data. Sorry for the inconvenience.");
    })
    .always(function() {
      hideLoadingIndicator("btn_submit");
    });
  }

  function submitForm() {
    var _missingFieldsInfo = checkRequiredFields();
    if(_missingFieldsInfo['missing_fields_arr'].length > 0) {
      savePage(false);
      postFSErrorMessage("Some required fields are empty. Please fill out all the required fields highlighted in red background color before submitting.<br><br>Some missing fields are:" + _missingFieldsInfo['missing_fields_msg']);
      return;
    } else {
      tempYes = function () {
        savePage(true);
        // postDoneMessage("SUBMITTED!");
      }
      tempNo = function () {
        closeStatusBarMessage();
        return true;
      }
      postYesNoMessage(
        '<i class="fa fa-question-circle fa-5x status_bar_info_sign" aria-hidden="true"></i><br><br>' +
        'Are you sure you want to submit the {{form_name}}?',
        tempYes,
        tempNo
      );
    }
  }

  function getFormInstanceData() {
    var _instance_identifier = "";
    var _instance_display = "";
    var _instance_identifier_page_data = {};
    var _instance_disabled_flg = false;
    var _is_form_instance_identifier = $('#page1').attr('is-form-instance-identifier');
    console.log('[getFormInstanceData] is_form_instance_identifier = ' + _is_form_instance_identifier);
    if (_is_form_instance_identifier == 'true') {
      _instance_identifier_page_data = getPageData(1);

      $("input[is-form-instance-identifier=true],select[is-form-instance-identifier=true]").each(function(i, obj) {
        if (_instance_identifier != "") {
          _instance_identifier += "-";
          _instance_display += " | ";
        }
        _instance_identifier += this.getValue().trim();
        if ($(this).is("select")) {
          _instance_display += this.options[this.selectedIndex].text.trim();
          if (this.options[this.selectedIndex].disabled === true) {
            _instance_disabled_flg = true;
          }
        } else {
          _instance_display += this.getValue().trim();
        }
      });
    }
    console.log('[getFormInstanceData] is_user_whitelisted = ' + is_user_whitelisted);
    console.log('[getFormInstanceData] instance_disabled_flg = ' + _instance_disabled_flg.toString());
    if (is_user_whitelisted === 'Y') {
      postInfoMessage("You have been given an exception by TTC Desk to edit / submit an application / evaluation after the TTC deadline.", 5, false);
    } else if (_instance_disabled_flg === true) {
      // Disable form if any of the select form instance inputs is disabled
      // Example if a TTC is beyond the deadline for submission
      disableInputs(false, false);
      postWarningMessage("Looks like you are past the deadline for saving this {{form_name}}. Please contact the TTC Desk if you feel this message is incorrect.", 0, true);
    }
    return {
      'instance_identifier': _instance_identifier,
      'instance_display': _instance_display,
      'instance_identifier_page_data': _instance_identifier_page_data,
      'instance_disabled_flg': _instance_disabled_flg
    };
  }

  function clearFormInstanceIdentifierPage() {
    // Disable form identifier page if its complete
    var _is_form_instance_identifier = $('#page1').attr('is-form-instance-identifier');
    console.log('[clearFormInstanceIdentifierPage] is_form_instance_identifier = ' + _is_form_instance_identifier);
    if (_is_form_instance_identifier == 'true') {
      var _list_of_inputs = [];
      $('#page1').find("input[id^=i_],textarea[id^=i_],select[id^=i_]").filter('[required]').each(function(i, obj) {
        _list_of_inputs.push($(this).attr('id'));
      });
      console.log('[clearFormInstanceIdentifierPage] list_of_inputs = ' + JSON.stringify(_list_of_inputs));
      
      clearFields(_list_of_inputs);
    }
  }

  function checkAndDisableFormInstanceIdentifierPage(disableOnly) {
    // Disable form identifier page if its complete
    var _is_form_instance_identifier = $('#page1').attr('is-form-instance-identifier');
    console.log('[checkAndDisableFormInstanceIdentifierPage] is_form_instance_identifier = ' + _is_form_instance_identifier);
    if (_is_form_instance_identifier == 'true') {
      var _list_of_inputs = [];
      $('#page1').find("input[id^=i_],textarea[id^=i_],select[id^=i_]").filter('[required]').each(function(i, obj) {
        _list_of_inputs.push($(this).attr('id'));
      });
      console.log('[checkAndDisableFormInstanceIdentifierPage] list_of_inputs = ' + JSON.stringify(_list_of_inputs));
      
      // Check if fields are non-empty
      if(checkFieldsNonEmpty(_list_of_inputs) && checkEmailFields(_list_of_inputs)) {

        // Check if there is an existing form
        var _instance_data = getFormInstanceData();
        var _instance_identifier = _instance_data['instance_identifier'];
        if (is_new_form && !disableOnly && form_instance_list.includes(_instance_identifier)) {
          tempYes = function () {
            closeStatusBarMessage();
            loadPage(_instance_identifier);
          }
          tempNo = function () {
            closeStatusBarMessage();
            return true;
          }
          postYesNoMessage(
            '<i class="fa fa-exclamation-circle fa-5x status_bar_info_sign" aria-hidden="true"></i><br><br>' +
            'You already have a saved application for the selected inputs. Do you want load that application?',
            tempYes,
            tempNo
          );
          return false;
        }

        // Disable the inputs
        for (var i = 0; i < _list_of_inputs.length; i++) {
          // console.log('[checkAndDisableFormInstanceIdentifierPage] disabling ' + _list_of_inputs[i]);
          $('#'+_list_of_inputs[i]).prop('disabled', true);
        }
        return true;
      } else {
        return false;
      }
    } else {
      return true;
    }
  }

  function startNew() {
    loadPage("{{BLANK}}");
    goToPage1();
    enableInputs(true);
  }

  function editForm() {
    tempYes = function () {
      $('#i_form_submitted').val("false");
      enableInputs(true);
    }
    tempNo = function () {
      closeStatusBarMessage();
      return true;
    }
    postYesNoMessage(
      '<i class="fa fa-question-circle fa-5x status_bar_info_sign" aria-hidden="true"></i><br><br>' +
      'The {{form_name}} has already been submitted. Are you sure you want to edit it?',
      tempYes,
      tempNo
    );
  }

  function copyForm() {
    tempYes = function () {
      $('#i_form_submitted').val("false");
      clearFormInstanceIdentifierPage();
      goToPage1();
      enableInputs(true);
    }
    tempNo = function () {
      closeStatusBarMessage();
      return true;
    }
    postYesNoMessage(
      '<i class="fa fa-question-circle fa-5x status_bar_info_sign" aria-hidden="true"></i><br><br>' +
      'Are you sure you want to copy this {{form_name}} into a new {{form_name}}?',
      tempYes,
      tempNo
    );
  }
  
  function loadPage(form_instance) {
    disableInputs(true);

    var _form_instance = form_instance;

    if (!form_instance || form_instance == '') {
      _form_instance = $('#form_instance').val();
    }

    console.log('[loadPage] form_instance = ' + form_instance);

    var jqxhr = $.get( "users/get-form-data", 
    {
      form_type: '{{form_type}}',
      form_instance: _form_instance
    })
    .done(function(data) {
      // alert(data);
      var _form_data = JSON.parse(data);


      {% if IS_DEV == 'Y' %}
      console.log('[loadPage] data = \n' + data);
      {% endif %}

      var _repeat_questions_arr = [];
      for(var id in repeat_question_list) {
        _repeat_questions_arr.push.apply(_repeat_questions_arr, repeat_question_list[id]);
      }

      $("input[id^=i_],textarea[id^=i_],select[id^=i_]").each(function(i, obj) {
        var _id = $(this).attr('id');
        var _name = $(this).attr('name');
        if (!_repeat_questions_arr.includes(_id)) {
          if (_id in _form_data) {
            console.log('[loadPage] ' + _id + ' = ' + JSON.stringify(_form_data[_id]));
          } else if (_name in _form_data) {
            console.log('[loadPage] ' + _name + ' = ' + JSON.stringify(_form_data[_name]));
          }
          if ($(this).attr('form-entry-type') && $(this).attr('form-entry-type') == 'repeater') {
            if (_id in _form_data) {
              var _repeat_questions = repeat_question_list[_id];
              var _repeat_data_arr = _form_data[_id];
              for (var i = 0; i < _repeat_data_arr.length; i++) {
                // [START] display name
                let _name = "";
                for (let j = 0; j < Math.min(_repeat_questions.length, REPEATER_DISPLAY_INPUT_CNT); j++) {
                  const _rqid = _repeat_questions[j];
                  if (_repeat_data_arr[i].hasOwnProperty(_rqid)) {
                    let _n = _repeat_data_arr[i][_rqid];
                    if (_n && _n != "") {
                      if (_name != "") {
                        _name += " • ";
                      }
                      _name += _n;
                    }
                  }
                }
                if (_name == "") {
                  _name = "Entry";
                }
                // [END] display name
                $('#'+_id).append($('<option>', {
                  value: JSON.stringify(_repeat_data_arr[i]), 
                  text: _name
                }));
              }
              $('#'+_id).val('summary').change();
            } else {
              console.log('[loadPage] clearing ' + _id);
              $('#' + _id).find('option[value!="summary"]').remove();
              $('#'+_id).val('summary').change();
            }
          } else {
            var _input_type = $(this).attr('type');
            if (_input_type && _input_type != 'hidden') {
              if (_input_type == 'radio') {
                if (_name in _form_data) {
                  if ($('#'+_id).val() == _form_data[_name]) {
                    $('#'+_id).prop('checked', true);
                  }
                } else {
                  console.log('[loadPage] clearing ' + _name);
                  $('input[name="'+_name+'"]').prop('checked', false);
                }
              } else {
                if (_id in _form_data) {
                  if (_input_type == 'checkbox') {
                    $('#'+_id).prop('checked', _form_data[_id]);
                  } else {
                    // all other inputs
                    console.log('[loadPage] setting ' + _id + ' = ' + JSON.stringify(_form_data[_id]));
                    $('#'+_id).val(_form_data[_id]);
                  }
                } else {
                  console.log('[loadPage] clearing ' + _id);
                  if (_input_type == 'checkbox') {
                    $('#' + _id).prop('checked', false);
                  } else {
                    $('#' + _id).val("");
                  }
                }            
              }
            } else if($('#'+_id).is("select")) {
              if (_id in _form_data) {
                $('#'+_id).val(_form_data[_id]).change();
              } else {
                console.log('[loadPage] clearing ' + _id);
                $('#'+_id).val("").change();
              }
            }
          }
        }
      });
      {% if IS_DEV == 'Y' %}
      console.log(JSON.stringify(_form_data));
      {% endif %}

      if ('i_form_submitted' in _form_data && _form_data['i_form_submitted'] == 'true') {
        disableInputs(false, true);
        // console.log('[loadPage] Disabling inputs since form is submitted.');

        // Disable form identifier page if its complete
        checkAndDisableFormInstanceIdentifierPage(true);
      } else {
        enableInputs(false);
        // console.log('[loadPage] Enabling inputs since form is submitted.');

        // Disable form identifier page if its complete
        checkAndDisableFormInstanceIdentifierPage(true);
      }

      console.log('[loadPage] i_agreement_accepted = ' + $('#i_agreement_accepted').val());

      if (form_agreement.length > 0 && $('#i_agreement_accepted').val() != 'true') {
        show_form_agreement();
      }

      if (curr_page_no == 0) {
        nextPage();
      }

      is_new_form = false;

      postDoneMessage("Your data has been retrieved");
    })
    .fail(function() {
      // alert("failed1");
      postErrorMessage("There was an error retrieving your data");
      $('#step_post_submit_message').html("There was an error retrieving your data Sorry for the inconvenience.");
    })
    .always(function() {
      hideLoadingIndicator("btn_submit");
    });
  }

  function form_agreement_no(argument) {
    $('#step_submit').hide();
    $('#step_form').hide();
    $('#step_post_submit_message').html("You need to accept the agreement before you can proceed!");
  }

  function form_agreement_yes(argument) {
    $('#i_agreement_accepted').val("true");
    // savePage(false);
  }

  function show_form_agreement() {
    var _agreement_text = "";
    for (var i = 0; i < form_agreement.length; i++) {
      _agreement_text += '<div>' + form_agreement[i] + '</div><br>';
    }
    postAgreementMessage(_agreement_text, form_agreement_yes, form_agreement_no);
  }

  $(document).ready(function() {

    if (!form_is_multi_instance) {
      loadPage('default'); 
    }
    // loadPage();

    if (curr_page_no == 0) {
      disableInputs(true);
    }

    initializeRequiredFields();

    if (no_of_pages == 1) {
      $("#btn_prev").hide();
      $("#btn_next").hide();
    }

    for(var id in repeat_question_list) {

      $('#'+id).on('change', function() {
        // alert("test");
        var _id = $(this).attr('id');
        var _val = $(this).val();
        console.log("["+_id+" change]");
        if (_val != "new_entry") {
          console.log("["+_id+" change] Hiding inputs and clearing new_entry");
          $("#"+_id+" option[value='new_entry']").remove();
          var input_list = repeat_question_list[_id];
          for (var i = 0; i < input_list.length; i++) {
            $("label[for='"+input_list[i]+"']").hide();
            $('#'+input_list[i]).hide();
            $("label[for="+input_list[i]+"_hidden]").hide();
            $('#'+input_list[i]+'_hidden').hide();
            $('input[name='+input_list[i]+']').hide();
            $('div[name='+input_list[i]+']').hide();
            $('label[name='+input_list[i]+']').hide();
          }
          $('#'+_id+'_save').hide();
        }
        if (_val == "summary") {
          console.log("["+_id+" change] Updating summary");
          var _num_entries = $("#"+_id+" option[value!='summary']").length;
          $('#'+_id+'_count').html(_num_entries);
          $("#"+_id+" option[value='summary']").text(_num_entries.toString() + " added");
        }
      });
      $('#'+id).change();
      // $('#'+id).on('change', function() {
      //   // alert("test");
      //   var _val = $(this).val();
      //   if (_val) {
      //     var _val = JSON.parse($(this).val());
      //     $('#i_eval_teacher_name').val(_val["i_eval_teacher_name"]);
      //     $('#i_eval_teacher_email').val(_val["i_eval_teacher_email"]);
      //     $('#i_eval_teacher_category').val(_val["i_eval_teacher_category"]);
      //   } else {
      //     $('#i_eval_teacher_name').val("");
      //     $('#i_eval_teacher_email').val("");
      //     $('#i_eval_teacher_category').val("local_teacher");
      //   }
      // });
    }

    // $("input[id*='date']").each(function(i, obj) {
    //   var _date_format = $(this).attr('date-format');
    //   if (!_date_format) {
    //     _date_format = "d-M-yy";
    //   }
    //   $(this).datepicker({
    //     changeMonth: true,
    //     changeYear: true,
    //     dateFormat: _date_format,
    //     yearRange: "1900:yy"
    //   })
    // });

    $('input[type=checkbox][value=other]').on('change', function() {
      if ($(this).is(':checked')) {
        $('#'+$(this).attr('id')+'_text').prop('required',true);
      } else {
        $('#'+$(this).attr('id')+'_text').prop('required',false);
      }
    });

    $('select[has-display-only-inputs=true]').on('change', function() {
      let _id = $(this).attr('id');
      // hide all inputs
      $("[name='d_" + _id + "']").hide();
      // parse data if its not the default entry
      if ($(this).val() != '') {
        var _display_data = JSON.parse( $('option:selected', this).attr('display-data'));
        for(_d_id in _display_data) {
          console.log('[ ' + _id + ' change] Setting ' + _d_id + ' = ' + _display_data[_d_id]);
          $('#d_'+_d_id).html(_display_data[_d_id]);
          // re-display the inputs
          $('#d_'+_d_id).show();
          $("label[for=d_" + _d_id + "]").show();
        }
      }
    });

    // Masked inputs
    var inputs = document.getElementsByTagName('input');
    for (var i = 0; i < inputs.length; i++) {
      if (inputs[i].getAttribute('mask-pattern')) { 
        inputs[i].onkeypress = maskTextboxInput;
        inputs[i].onpaste = maskTextboxInput;
      }
    }

    hideDependentInputsOnLoad();  
  }); // When the page first loads




  // [START file_upload]

  /**
   * Posts some data to url after upload
   * @param key Datastore Entity key (urlsafe)
   */
  function postUploadHandler(e, key) {
      $.post('/upload/postdownload/',
          {
              key: key
          });
  }
  /**
   * Ajax request to Google Cloud Storage
   * @param url: signed url returned from server
   * @param file: file object which will be uploaded
   * @param key: database key
   */
  function upload(e, url, file, key) {
      $.ajax({
          url: url,
          type: 'PUT',
          data: file,
          contentType: file.type,
          success: function () {
              var _id = e.getAttribute("name");
              document.getElementById(_id + '-loading').style.visibility = 'hidden';
              document.getElementById(_id).value = file.name;
              postDoneMessage("Your photo was uploaded successfully");
              postUploadHandler(e, key);
          },
          error: function (result) {
              postErrorMessage("There was an error uploading your photo");
              console.log(result);
          },
          processData: false
      });
  }
  /**
   * Used as callback in Ajax request (to avoid closure keeping state)
   */
  var uploadCallback = function (e, uploadedFile) {
      return function (data) {
          var url = data['url'];
          var key = data['key'];
          upload(e, url, uploadedFile, key);
      }
  };
  /**
   * After selecting files and clicking Open button uploading process is initiated automatically
   * First request to get signed url is made and then actual upload is started
   * @param files: selected files
   */
  function handleFiles(e, files) {
      for (var i = 0; i < files.length; i++) {
          var file = files[i];
          var filename = file.name;
          try {
            $.getJSON("/upload/get_signed_url/", {
              filename: filename,
              content_type: file.type
            },
              uploadCallback(e, file)
            );
          } catch (error) {
            postErrorMessage("There was an error uploading your photo");
          }
      }
  }

  /**
   * After selecting files and clicking Open button uploading process is initiated automatically
   * First request to get signed url is made and then actual upload is started
   * @param files: selected files
   */
  function uploadPhotos(e, files) {
      var _id = e.getAttribute("name");
      document.getElementById(_id + '-loading').style.visibility = 'visible';
      var filename = '';
      for (var i = 0; i < files.length; i++) {
          var file = files[i];
          filename = file.name;
          $.getJSON("/upload/get_signed_url/", {
                  filename: '{{user_email_addr}}' + filename.substring(filename.lastIndexOf('.')),
                  filepath: '{{user_photo_folder}}',
                  content_type: file.type
              },
              uploadCallback(e, file)
          );
      }
  }
  // [END file_upload]


</script>
      <div style="margin: 0 auto;" class="site-container">
        <div class="site-inner-container" style="position: relative;">
          <div id="form_header" class="form-tab-content" style="display:table;text-align:center;margin:0 auto;">

              <div class="tablebody">
                  <div class="tablerow">
                      <div class="tablecell">
                          <div id="deepen" class="form-header-block" style="text-align: left;">
                              <table cellspacing="0" cellpadding="0" border="0">
                                  <tr>
                                      <td style="width: 1%;">
                                          <i class="fa fa-file-text" aria-hidden="true"></i>
                                      </td>
                                      <td style="padding-left: 13px;">
                                          {{form_name}}
                                          <span style="display: none;">
                                              [Page <span id="curr_page_no">{{page_no}}</span> of {{no_of_pages}}]
                                          </span>
                                      </td>
                                  </tr>
                                  <tr>
                                      <td colspan="2">
                                          <div class="smallertext" style="margin-top:13px;">
                                              {{form_description}}
                                          </div>
                                      </td>
                                  </tr>
                              </table>
                              <!-- <hr class="left-gradient-separator"> -->
                          </div>
                      </div>
                  </div>
              </div>
          </div>

          <div id="step_form" class="form-tab-content" style="display:table;text-align:center;margin:0 auto;">

              {{form_html|safe}}

              <br>
              <br>
              <br>

              <input id="i_agreement_accepted" type="text" style="display: none;">
              <input id="i_form_submitted" type="text" style="display: none;">
              <input id="i_new_form" type="text" style="display: none;">
              
          </div>

          <div id="step_submit" class="form-tab-content" style="display:table;text-align:center;margin:0 auto;position:fixed;bottom:0px;background-color:white;z-index:13;">
              <div class="tablebody">
                  <div class="tablerow">
                      <div class="tablecell" style="
                        padding-bottom: 5px; 
                        line-height: 40px; 
                        border-top: 1px solid #eee;
                      ">
                          <a id="btn_prev" class="an-simple-button" onclick="javascript:prevPage();">
                            <i class="fa fa-arrow-circle-left fa-lg" aria-hidden="true"></i>&nbsp;&nbsp;Prev
                          </a>
                          <a id="btn_next" class="an-simple-button" onclick="javascript:nextPage();">
                            <i class="fa fa-arrow-circle-right fa-lg" aria-hidden="true"></i>&nbsp;&nbsp;Next
                          </a>
                          <div class="an-button-vertical_separator">&nbsp;</div>
                          <a id="btn_save" name="btns_save_submit" class="an-simple-button" onclick="javascript:savePage(false);">
                            <i class="fa fa-floppy-o fa-lg" aria-hidden="true"></i>&nbsp;&nbsp;Save
                          </a>
                          <a id="btn_submit" name="btns_save_submit" class="an-c2a-button" onclick="javascript:submitForm();">
                            <i class="fa fa-check-circle fa-lg" aria-hidden="true"></i>&nbsp;&nbsp;Submit {{form_name}}
                          </a>
                          <a id="btn_copy" name="btns_copy" class="an-2nd-c2a-button" style="display: none;" onclick="javascript:copyForm();">
                            <i class="fa fa-clone fa-lg" aria-hidden="true"></i>&nbsp;&nbsp;Copy
                          </a>
                          <a id="btn_save" name="btns_edit" class="an-2nd-c2a-button" style="display: none;" onclick="javascript:editForm();">
                            <i class="fa fa-pencil-square-o fa-lg" aria-hidden="true"></i>&nbsp;&nbsp;Edit
                          </a>
                          <a id="btn_save" name="btns_start_new" class="an-c2a-button" style="display: none;" onclick="javascript:startNew();">
                            <i class="fa fa-plus-circle fa-lg" aria-hidden="true"></i>&nbsp;&nbsp;Start a new {{form_name}}
                          </a>
                      </div>
                  </div>
              </div>
          </div>

          <div id="step_post_submit" class="form-tab-content" style="display:table;text-align:center;margin:0 auto;">
              <div class="tablebody">
                  <div class="tablerow">
                      <div id="step_post_submit_message" class="tablecell"></div>
                  </div>
              </div>
          </div>

        </div>
      </div>

<script>
  // Note: This example requires that you consent to location sharing when
  // prompted by your browser. If you see the error "The Geolocation service
  // failed.", it means you probably did not give permission for the browser to
  // locate you.

  function initMap() {
    // [START Setting typeahead city field]
    var autocomplete;
    var countryRestrict = {'country': "{{ user_country or 'us' }}".toLowerCase()};
    var _cityField = document.getElementById('i_address_city');
    if (_cityField) {
      autocomplete = new google.maps.places.Autocomplete(
        /** @type {!HTMLInputElement} */(_cityField), 
        {
          types: ['(cities)'],
          componentRestrictions: countryRestrict
        }
      );

      google.maps.event.addListener(autocomplete, 'place_changed', function () {
        var city = _cityField.value;
        if (city) {
          var cityArr = city.split(',');
          _cityField.value = cityArr[0];
          document.getElementById('i_address_state').value = cityArr[1];
        }
      });      
    }

    $('#i_country_dropdown .typeahead').bind('typeahead:select', function(ev, suggestion) {
      console.log('Selection: ' + suggestion);

      var countries_map = $(document).data('countries_map');
      var countryRestrict = {'country': 'us'};
      if (document.getElementById('i_country').value) {
        var country_iso_abbr = countries_map[document.getElementById('i_country').value];
        document.getElementById('i_country_iso_abbr').value = country_iso_abbr;
        countryRestrict = {'country': country_iso_abbr.toLowerCase()};
      }

      autocomplete.setComponentRestrictions(countryRestrict);
    });
  }

  function handleLocationError() {
    // $('#img-ghcourses-search_in_progress').hide();
    // $('#img-ghercourses-search_in_progress').hide();
  }
</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap">
</script>
