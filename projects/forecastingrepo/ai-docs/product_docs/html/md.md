
# [Документ ТЗ](https://docs.google.com/document/d/e/2PACX-1vQfMsrwn6EfucbTW3EOxPCzXVhY_j1hxULuZce6QGanbmA5_7_iW5IJ3b6S7H0uFYSfkoN9wivapdgZ/pub)

1) Смотрит текущее исполнение плана мусоровозом
2) Прогнозирует успеет ли он в рабочее время собрать свой план
3)  Выделяем цветом как проблемные КП так и проблемный муоровозов: зеленым - выполняет план, желтым риск срыва около 10%, красным риск срыва более 10%
4) ЖЕЛТЫМ ВЫДЕЛЯЕМ КП КОТОРЫЕ МОГУТ БЫТЬ СОРВАНЫ
-------------------
1) Сколько из 24 часов находится в работе (рабочее время / 24)
2) Сколько из рабочего времени фактически находитяся в работе (рабочее время на линии движения, погрузка, разгрузка, убираем все остановки, обеды, заправки / рабочее время)
-----------------
1) Устанавливаются нормативы погрузки в зависимости от кодичества контенйеров. При нарушении каждый факт разбирается. Отдельная раздел в мониторинге отклонения по нормативов
---------------------

# Постановка задачи

### Цели

1. Прогноз затрат времени на выполнение ПЗ
2. Оценка КТУ водителя
3. Контроль работы водителя, управление вывозом в реальном времени (если видим что водитель не успевает - перекинуть часть вывоза на другую ТС)

### Задачи

1. Расчет прогнозируемого времени выполнения для ПЗ, длительности смены
2. Сверка реальной работы с прогнозом
3. Расчет прогнозируемого времени выполнения для маршрута и даты

## Пользовательский сценарий

### Мониторинг

![image](/uploads/9772c947e359a445d343c0b3dbbfcb02/image.png)

В заголовке у ТС показывается текущее рабочее время, начиная с момента выезда из гаража, и прогнозное время работы по план-заданию. Цвет текста и иконки определяется текущим отставанием реального графика работы от прогнозного. После вывоза каждой КП просчитывается оставшееся прогнозное время работы, и если оно превышает разницу между общим прогнозным временем и текущим реальным временем работы более чем на 20%:

1. Иконка и текст с текущим временем становятся красными
2. Прогресс-бар у номера ТС становится желтым
3. Индикаторы КП без отчета из серых перекрашиваются в желтые

Если рабочее время превысило прогнозное, прогресс-бар у номера ТС становится красным.

В столбце "Приб." показывается время прибытия ТС на КП. Оно считается как самое раннее из двух событий:
- остановка ТС в радиусе 50м от КП по данным GPS-датчика ТС
- время первой фотографии из отчета водителя по КП минус 10 сек

Время прибытия сравнивается с нормативным временем проезда от предыдущей до данной КП, и если оно превышает норматив на 20%, то выделяется красным цветом. При наведении на него мышкой показывается детализация - между какими КП считался пробег, его прогнозное время и реальное время.

![image](/uploads/2469ca8a1acffe97bef8b0623a4bc140/image.png)

Остановки на обед и т.п. также будут подсвечиваться красным. Возможно в будущих версиях мы научимся догадываться что это был обед.

В столбце "На КП" показывается время работы ТС на КП = разница между временем покидания и прибытия на КП. Время покидания КП считается как самое позднее из двух событий:
- ТС покинула радиус 50м от КП
- время последней фотографии из отчета водителя по КП плюс 10 сек

Время работы сравнивается с нормативным временем для данной КП, и если оно превышает норматив на 20%, то выделяется красным цветом. При наведении на него мышкой показывается детализация - прогнозное время и реальное время работы на этой КП.

![image](/uploads/de41384ba38ad7c366133957e63d8bea/image.png)

### Редактор маршрутов

В прогноз в редакторе маршрутов добавляется отметка о плановой длительности работы над ПЗ

Пример `10:21:39`

### Редактор ПЗ

![image](/uploads/b10f99ba0d9c60f2c90678cb2ee0d3ab/image.png)

# Техническая часть

## BACKEND

### Задачи

1. Расчет дорожного пробега между двумя координатами
2. Расчет времени работы на КП
3. Расчет времени поездки по заданному пробегу
4. Добавить в прогноз на дату маршрута планируемое время выполнения
5. Для каждого элемента ПЗ рассчитать пробег
6. Для каждого элемента ПЗ время выполнения



### Расчет дорожного пробега между двумя координатами

Проверить актуальность метода `GpsRouteServiceImp#getDistance`, возможно получится вычислить дорожный пробег через него

Требуется расчет пробега по всем точкам ПЗ: от гаража до первой КП, от N до N+1 КП, от последней КП первого рейса до полигона, от полигона до первой КП второго рейса, от полигона до гаража, итд

Могут возникнуть вопросы, в какой очередности должны идти точки, какую КП считать окончанием первого рейса

Пример расчета:
```
На ПЗ закреплено ТС с характеристиками
Объем бака: 18 м3
Коэффициент уплотнения: 4
Гараж: Гараж на Полярной

Если у ТС не указан объем бака, берем значение по умолчанию - 20 м3
Если у ТС не указан коэффициент уплотнения, берем значение по умолчанию - 4
Если у ТС не указан гараж, ищем первый попавшийся гараж, у которого организация-владелец совпадает с владельцем ТС. Если и таких гаражей нет - не считаем пробеги из/до гаража


На ПЗ закреплен маршрут
Выгрузка на: Полигон АМП

Если за ПЗ закреплено за несколькими маршрутами, то берем первое попавшееся место выгрузки и делаем расчет для него


Считаем что поездка всегда начинается из гаража
Поездка продолжается по деталям ПЗ в порядке возрастания до тех пор, пока не будет заполнен бак ТС (сумма забранного ТКО со всех КП не приблизится к объему бака * коэффициент уплотнения), пусть это будет деталь ПЗ с номером 14 - последняя забранная
Далее поездка по деталям ПЗ прекращается, ТС едет на определенный ранее полигон на разгрузку
После разгрузки поездка продолжается с последней не забранной КП до того момента пока бак опять не заполнится, или КП в ПЗ не закончатся
Затем поездка по КП снова прекращается - ТС едет разгружаться на полигон
Поездка продолжается с последней не забранной КП
И так до тех пор пока не закончатся все КП в плане
ПЗ заканчивается поездкой на полигон и возвратом в гараж

Примерный расчет:
Гараж Полярная -> КП-1 = 752 м
КП-1 -> КП-2 = 141 м
КП-2 -> КП-3 = 94 м
...
КП-13 -> КП-14 = 277 м
КП-14 -> Полигон АМП = 3791 м
Полигон АМП -> КП-15 = 4147 м
КП-15 -> КП-16 = 149 м
...
КП-36 -> Полигон АМП = 4222 м
Полигон АМП -> Гараж Полярная = 6147 м


(КУДА ЗАПИСЫВАТЬ?)
Создать TaskForecast?
```

### Расчет времени работы на КП

Требуется вычислить время работы водителя на КП

Учесть факторы:

* Количество контейнеров в плане
* Объем контейнеров в плане
* Дополнительные заявки (уборка КП)

Можно придумать формулу, где перемножить факторы

Например:

```
Вывозим 2 контейнера по 0.75 и 3 контейнера по 1.1, 
Пусть на забор одного контейнера в среднем требуется 1.5 минуты
Контейнер 1.1 объемнее и тяжелее обычного, его расчетное время вывоза умножаем на коэффициент 1.05
Итого получается время на вывоз двух КГ: 
2 * 1.5 мин + 3 * 1.05 * 1.5 мин = 7.725 минут


Также требуется уборка КП
Пусть среднее время на уборку КП будет 5 минут, добавляем их:
7.725 + 5 = 12.725 минут

Таким образом, расчетное время работы на указанной КП составляет 12.725 минут
```


### Расчет времени поездки по заданному пробегу

Зная расстояние между местами посещений, скорость движения и время работы на КП можно рассчитать отметку времени относительно начала работы над ПЗ для каждого место посещения

```
Также предлагаю заложить коэффициенты: сезонности, участка

Коэффициент сезонности - увеличивает плановое время поездки за счет времени года (в холодный снежный месяц движение по дорогам всегда медленнее, чем летом в ясную погоду)

Коэффициент участка - увеличивает плановое время поездки за счет особенностей участка вывоза (в крупном городе много светофоров, пешеходных переходов; в мелком городе скорость движения будет всегда выше)

Пока все коэффициенты приравнять к 1, чтобы они не оказывали влияния, со временем рассмотрим их использование на практике
```

```
Пусть средняя скорость движения между КП: 30 км/ч (от КП до КП | от гаража до КП | от КП до гаража)
Средняя скорость движения на полигон: 60 км/ч (от КП полигона | от гаража до полигона | от полигона до гаража | от полигона до КП)

Чтобы посчитать время поездки делим расстояние на скорость, умножаем на сезонный и на коэффициент участка
t = s[м]/v[м/с] * ks * kr

Пусть расстояние между КП мы определили как s = 500 метров
Т.к. путь проходит от КП до КП, считаем среднюю скорость за v = 30 км/ч
Сезонный ks коэффициент = 1
Коэффициент участка kr = 1

Расстояние переводим в метры: 500 [м]
Скорость переводим в метры в секунду: 30 [км/ч] / 3,6 = 8,33 [м/с]

Тогда время определяется так
t = 500 / 8.33 * 1 * 1 = 60 секунд


Для расчета движения между КП и полигоном берем другую скорость - 70км/ч 
Пусть расстояние между КП и полигоном 7,5 км

Расстояние переводим в метры: 7500 [м]
Скорость переводим в метры в секунду: 60 [км/ч] / 3,6 = 16,67 м/с [м/с]
t = 7500 / 16,67 * 1 * 1 = 450 секунд
```
_Куда это все писать?_

### Добавить в прогноз на дату маршрута планируемое время выполнения

В ЧЛ уже есть прогноз загрузки маршрутов `RouteCapacityForecast` - показывает плановый объем ТКО для маршрута по каждому дню

Есть смысл добавить плановый пробег и время выполнения в эту же сущность, переименовав в `RouteForecast`

```
RouteForecast
* route
* day
* occupancyByNominalVolume
* occupancyByAreaRate
* garbageDensity
* milleage 
* time 
```

### Расчет пробега маршрута на дату

1. Выбираются КГ, которые подлежат вывозу в этот день, их сортировка соответствует маршруту
2. Поиск ТС, вычисление доступного объема для одного рейса
3. Деление нацело списка КП на рейсы по объему: считаем что рейс заканчивается, когда бак ТС будет заполнен ТКО с КП
4. Расчет пробега и времени планируемого ПЗ

## FRONTEND

<details>
<summary>old desc</summary>

# Вводное:

Для каждой КП в ПЗ прогнозировать время прибытия на нее, для ПЗ в целом - рабочее время на него. В прогноз по ТС добавить это время, а в мониторинге отмечать желтым КП и ТС где есть отставание от графика

# Задача 1 (Если ПЗ новое)

При составлении новго ПЗ, посчитать его продолжительность, когда примерно закончит водитель и сколько он проедет.Добавить в маршрут:

1. Рабочее время
2. Пробег

## Предложения о решении:

Использовать Open Street Map (Он считает время до прибытия и дистаницю)

### Дополнительная информация по задаче:

Синии колонки - реальная работа, а зеленые прогноз.Каждый зеленый столбик - это рейс.Красный и желтый - это неполный рейс.Прогноз сортируется по оптимальному пути план задания.

# Задача 2 (в процессе выполнения ПЗ)

Придумать, как посчитать время до следующей КП, когда он к ней приедет и через сколько. И узнать, когда он закончит всё план задание и сколько проедет.Нужно учитывать время прибытия до КП, Объем до КП , с учетом того, что мы не знаем к какой КП он поедет. Указать погрешность и статистику.
</details>

## Макеты

### Редактор маршрутов - прогноз нагрузки на ТС

![image](/uploads/b10f99ba0d9c60f2c90678cb2ee0d3ab/image.png)