### Общая схема

Рядом со шлагбаумом устанавливается IP-камера, соединённая с компьютером в сторожке. На компьютере запущено ПО, непрерывно анализирующее видео с камеры на предмет QR-кода. К этому же компьютеру подключено реле, открывающее шлагбаум.

![image](/uploads/f4bca36f0cfd9e0aa3ad26af27a8e850/image.png)

Есть два метода открытия шлагбаума, через QR-код и WiFi-роутер.

QR-код:

1. QR-код отображается в приложении водителя или в бумажном акте
2. Водитель сканирует его, показывая IP-камере
4. Приложение на компьютере обнаруживает в видео-потоке QR-код, анализирует его и выдает сигнал реле на открытие шлагбаума

WiFi-роутер:

1. Кнопка открытия шлагбаума показывается при приближении к нему
2. Водитель нажимает кнопку и приложение передает код на компьютер
4. Приложение на компьютере анализирует его и выдает сигнал реле на открытие шлагбаума

### Приложение водителя

При старте приложение скачивает список мест разгрузки и проверяет у них атрибут "Способы открытия шлагбаума". Возможные значения -

1. "не установлен" или "нет"
2. "QR-код"
3. "WiFi-роутер"

Это массив, значения 2 и 3 могут выбираться вместе или по отдельности. Еще приходит атрибутом WiFi SSID, если указан в свойствах места разгрузки.

Если включен только способ "QR-код", то когда приложение показывает форму весового отчета, внизу слева показывается кнопка "Открыть QR-код". Кнопка открывает QR-код на весь экран.

![image](/uploads/6f11704aaf9707bddcaed5ed0b0c17ee/image.png)

Если включен только способ "WiFi-роутер", приложение каждые 15 секунд сканирует WiFi, пытаясь по очереди соединиться со всеми SSID из списка. Как только получилось соединиться с одним из них, показывается кнопка "Открыть шлагбаум". Действие этой кнопки см. ниже.

![image](/uploads/1b25dd14e89d4a521ba4e8103820cc4c/image.png)

Если включены оба способа, то показываются обе кнопки сразу:

![image](/uploads/ec7003be20134756b1c4f93b9ed7a6b0/image.png)

### Бумажный акт

В бумажном акте используется другая версия кода, чтобы отличать его от приложения и проверять по другим условиям (например, расслаблять проверку времени его создания).

### Приложение на компьютере

Требования к приложению -

- должно иметь доступ через Ethernet к видео с IP-камеры и реле шлагбаума
- должно уметь работать как в онлайне, так и в офлайне
- будет расширяться функциями АИС Объекта - сбор весовых отчетов и т.п.

Предложение по реализации: отдельный компьютер, на котором запущено только наше ПО. Он может не иметь клавиатуры и монитора, а его интерфейс доступен с рабочего компьютера оператора полигона в браузере (по IP адресу). ПО в этом случае можно реализовать на Java+React, нашем основном технологическом стеке.

В будущем его функции планируется нарастить АИС Объекта, в этом случае может потребоваться доступ к весам (обычно это COM или USB порт).

### Содержимое QR-кода

В код зашиваются данные, по которым можно проверить валидность ТС даже если нет соединения с сервером Чистой логистики.

`01 12 05 14 01 33 A 123 AA 1 012 99068CE8`

- 01 - номер версии кода. 01 используется для кодов в приложении, 02 для бумажных кодов, возможно добавление новых версий в будущем
- 12 05 = дата создания кода
- 14 01 33 = время создания кода
- A 123 AA = госномер ТС (без региона)
- 1 = 1е плечо
- 012 = 12 КП в план-задании
- 99068CE8 = контрольная сумма

В коде эта строка представлена без разделителей - `011205140133A123AA101299068CE8`. QR-код для этой строки:

![image](/uploads/43ea9253b967c9dcfcbd790ee020aa24/image.png)

Номер версии позволяет в дальнейшем зашивать в код другие данные. Контрольная сумма гарантирует, что QR-код был создан в нашем приложении. Он рассчитывается как последние 8 символов MD5 хэша от остальной части кода и секретной 32-значной строки.

### Проверка кода

В будущем мы можем добавлять разные условия такой проверки, на данный момент разрешение выдается:

- ТС 1-го плеча: если у него есть активное план-задание
- ТС 2-го плеча: если оно зарегистрировано в системе

1. Проверка на длину строки. Может быть разной в зависимости от версии кода, но всегда известна заранее.
1. Пересчитывается контрольная сумма и сравнивается с суммой из кода.
2. Проверяется, что время совпадает с текущим с точностью до 15 минут. Если нет, код считается устаревшим.
2. Проверяется, что такой же код не был отсканирован ранее сегодня.
2. Проверяется, что последний раз код этой ТС был отсканирован и одобрен либо в последние 15 сек, либо более 30 минут назад. Интервал от 15 сек до 30 мин - запрет, чтобы по одному телефону не проехало две машины.
3. Если ТС первого плеча, проверяется, что число КП в план-задании больше нуля.
4. Для первой версии кода на этом проверки заканчиваются.

Если хотя бы одно из этих условий не выполнено, на считыватель идет сигнал "отказ". Если выполнены все - идет сигнал "ок" и открывается шлагбаум.

### Сохранение событий

Все события сканирования кода и результаты их проверки сохраняются локально. Если есть Интернет, они сразу же передаются на сервер. Если нет, ждем пока появится и передаем. 

Есть возможность скачать лог событий из самого приложения в CSV-формате.

# Использование WiFi вместо QR-кода

Рядом со шлагбаумом можно разместить WiFi-роутер с открытой регистрацией (без пароля). Роутер предоставляет доступ в локальную сеть, и через него можно обратиться по адресу вида `192.168.1.100:8000`, который слушает наше приложение на локальном сервере.

При запуске приложение водителя скачивает список мест разгрузки и SSID роутеров, которые на них установлены.

При приближении к полигону приложение водителя определяет, какой это полигон, и начинает попытки законнектиться к роутеру по его SSID. 

Если коннект состоялся, приложение пингует адрес `192.168.1.100:8000`, ожидая ответа. Если ответ получен, приложение делает кнопку "Открыть шлагбаум" доступной. При нажатии на кнопку приложение отправляет на этот же адрес запрос на открытие шлагбаума, передавая с ним все описанные выше данные в текстовом или JSON формате. Ответ "да/нет" приложение показывает на экране, пока открывается шлагбаум.

WiFi-роутер может быть любым, в защищенном корпусе либо находиться в помещении, если сигнал оттуда будет доставать до шлагбаума. Компьютер соединен с ним Ethernet-кабелем.