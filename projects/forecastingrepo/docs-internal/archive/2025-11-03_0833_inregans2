Got it. Below is a **copy‑pasteable work order** you can hand to your **coding agent**. It assumes the CDS API token is already stored locally in `~/.cdsapirc` on the agent’s machine (from your zipped file), and **no secrets are shared in chat or pushed to Git**. It uses the full repo (recommended).

---

# Work Order — Data Ingest & Weather A/B Prep (macOS/Linux)

**Branch name:** `agent/data-ingest-irkutsk`
**Repo:** your private forecasting repo (full access)
**Secrets:** already present locally as `~/.cdsapirc` (do **not** paste tokens in chat/PRs)

## 0) Preconditions (do once)

1. **Verify `~/.cdsapirc` exists and is readable** (don’t echo the key):

```bash
test -f "$HOME/.cdsapirc" && echo "cdsapirc OK" || echo "Missing ~/.cdsapirc"
grep -E '^url:' "$HOME/.cdsapirc" || echo "URL not found in cdsapirc"
```

2. **Accept dataset Terms** in the CDS UI once for ERA5‑Land (open dataset page, scroll to bottom, accept).
   If Terms aren’t accepted, any API request will fail with a Terms error.

3. **Create branch and venv; install deps**:

```bash
git checkout -b agent/data-ingest-irkutsk
python3 -m venv .venv && source .venv/bin/activate
pip install -r requirements-dev.txt
pip install cdsapi meteostat geopandas shapely pyproj rtree xarray netCDF4 pandas requests
```

> If `geopandas` fails on macOS, install via Homebrew first:
>
> ```
> brew install gdal geos proj spatialindex
> ```

---

## 1) Downloads (Irkutsk oblast, 2022–2024)

> All outputs are local files under `data/raw/` + `provenance/`. **Never commit raw data or `.env`**.

### 1.1 ERA5‑Land (preferred: hourly → aggregate to daily later)

Run:

```bash
python scripts/agentmode/cds_era5_land_pull.py
```

Expected outputs:

* `data/raw/weather/era5land_irkutsk_2022_2024.nc`
* `provenance/era5land_irkutsk_2022_2024.json`

**If the script fails due to dataset/variable naming:**

* Open the ERA5‑Land dataset page, build a small test request in the web form (1 month), click **“Show API request code”**, and copy the **dataset id** and **variable keys** into `cds_era5_land_pull.py`.
* If daily stats prove finicky, switch to **hourly** retrieval only (dataset `reanalysis-era5-land`) and keep daily aggregation for the plugin stage.

**If timeouts occur:** split by year (edit the script to loop `YEARS = ["2022"]`, then `["2023"]`, then `["2024"]`) and concatenate NetCDF later.

### 1.2 Meteostat stations (Irkutsk + 100 km)

```bash
python scripts/agentmode/meteostat_pull.py
```

Outputs:

* `data/raw/weather/stations_meteostat.csv`
* `data/raw/weather/meteostat_daily_irkutsk_2022_2024.csv`
* `provenance/meteostat_irkutsk_2022_2024.json`

> **License note:** CC‑BY‑NC for raw; fine for modeling; do **not** ship raw to clients.

### 1.3 (Optional) NOAA GHCN‑Daily subset

```bash
bash scripts/agentmode/noaa_ghcn_pull.sh
```

Output: `data/raw/weather/ghcnd-stations_irkutsk_bbox.csv` (subset list).
*Full daily pulls are large—skip unless needed.*

### 1.4 RU ADM2 boundaries (Irkutsk extraction)

```bash
bash scripts/agentmode/geoboundaries_pull.sh
```

Outputs:

* `data/boundaries/geoBoundaries-RUS-ADM2-all.zip`
* `data/boundaries/irkutsk_districts.geojson`
* (and any provenance the script writes)

### 1.5 RU holidays (for features)

```bash
python scripts/agentmode/holidays_generate.py
```

Outputs:

* `data/calendars/holidays_ru_2022_2025.csv`
* `provenance/holidays_ru_2022_2025.json`

---

## 2) Weather Mapping A/B (no model change)

Use **`docs/Tasks/PR-Weather-AB-Study.md`**.
Goal: prepare evaluation‑only joins and simple correlation tables; do **not** change forecast outputs.

1. Choose **two districts** (confirm names/IDs exist in client aggregates):

   * **FLAT** (e.g., Irkutsk urban okrug)
   * **MOUNTAINOUS** (e.g., East Sayan foothills district)

2. Use the **three mapping variants** in read‑only mode (no model change):

   * **A:** IDW (power = 2, radius = 75 km, min = 3)
   * **B:** Thiessen polygons
   * **C:** ERA5‑Land polygon mean

3. Produce:

   * `reports/weather_ab/mapping_summary.md` — method params, station counts, distance histograms, grid stats
   * `reports/weather_ab/corr_tables_flat.csv` — corr(waste, HDD), corr(waste, CDD), corr(waste, precip_7d) at lags 0..7
   * `reports/weather_ab/corr_tables_mountainous.csv` — same for mountainous district

> Respect determinism: `TZ=UTC`, `LC_ALL=C.UTF-8`, `PYTHONHASHSEED=0`.

---

## 3) QA & quick sanity checks

```bash
# Files exist and non-empty
ls -lh data/raw/weather/era5land_irkutsk_2022_2024.nc
ls -lh data/raw/weather/meteostat_daily_irkutsk_2022_2024.csv
ls -lh data/boundaries/irkutsk_districts.geojson
ls -lh data/calendars/holidays_ru_2022_2025.csv

# Optional: inspect ERA5-Land
python - <<'PY'
import xarray as xr
ds = xr.open_dataset("data/raw/weather/era5land_irkutsk_2022_2024.nc")
print(ds)
PY
```

**Provenance:** ensure JSON files include dataset name, params, time range, area/bbox, and SHA256 of artifacts.

---

## 4) What to commit / what NOT to commit

**Commit (safe):**

* `reports/weather_ab/` (only Markdown/CSV results)
* Any doc updates (if you link the report in docs index)
* Non‑secret code changes (tiny fixes if a script path requires adjustment)

**Do NOT commit:**

* `data/raw/**` (NetCDF, CSV from providers)
* `.env`, `~/.cdsapirc`, or any secrets
* Provider ZIPs or credential files

Git ignores for these are already present; keep it that way.

---

## 5) PR checklist (title: *data: ERA5‑Land + stations + A/B mapping report*)

* ✅ Branch `agent/data-ingest-irkutsk`
* ✅ No secrets in PR; no raw data committed
* ✅ `reports/weather_ab/mapping_summary.md`
* ✅ `reports/weather_ab/corr_tables_flat.csv`
* ✅ `reports/weather_ab/corr_tables_mountainous.csv`
* ✅ (Optional) link from `docs/System/documentation-index.md` → your report

**Acceptance:** PR contains only reports/docs (and tiny script tweaks if needed); CI (docs/spec gates) remains green; no forecast outputs changed.

---

## 6) If anything blocks you (try in order)

1. **CDS request fails** → Open dataset page, accept Terms, click **Show API request code**, copy dataset id/variables into `cds_era5_land_pull.py`, re‑run.
2. **Timeouts** → Split by year; reduce variables; smaller bbox.
3. **Meteostat empty** → Increase radius to 150 km in `meteostat_pull.py`.
4. **GeoBoundaries parsing fails** → Use `ogr2ogr` or read via `geopandas` another file from the unzipped set.
5. **Still stuck?** Post the *exact* error and the dataset id/params you used; proceed with any part that works while waiting for guidance.

---

## 7) Notes you don’t need to worry about

* Security is handled locally: you already have `~/.cdsapirc`. **Never paste tokens in chat or PR.**
* We are **not** changing forecasting behavior in this task; weather remains behind a scenario flag and this work is **evaluation‑only**.

---

When you open the PR with the A/B report, we’ll review the correlations and decide whether to proceed to a small, **flagged** feature‑injection PR (still off by default) for backtesting.

