# Excel‑инструкция (Код КП + объемы по дням)

Эта инструкция для проверки прогноза по формату:
`Код КП;1;2;...` (дни внутри каждого месяца, разделитель `;`, десятичная запятая).
Рекомендуем имя файла с периодом: `*_YYYY-MM-DD_YYYY-MM-DD.csv`.
Для автоматической проверки используйте `python scripts/validate_forecast.py forecast.csv actuals.csv metrics.csv --start YYYY-MM-DD --end YYYY-MM-DD`.

## Важно: прогноз может быть накопительным

Иногда прогнозный файл содержит **накопительные** значения (каждый день — сумма с начала периода).
В этом случае нельзя просто суммировать все ячейки по дням — получится сильно завышенная сумма.

Как сравнивать с фактом «за день»:
- Самый простой вариант: используйте `scripts/validate_forecast.py` (по умолчанию он считает дельты для накопительного прогноза).
- Если прогноз уже «за день», запустите скрипт с `--forecast-series daily`.
- В Excel для перевода накопительного прогноза в дневной: для первого дня `=Forecast!B2`, дальше `=Forecast!C2-Forecast!B2` (и протянуть вправо).

## 0) Шаблон (пример файла)

Готовый пример с формулами:  
`forecast_vs_actuals_sample.xlsx`

Листы в шаблоне:
- `Forecast` — прогноз (значения)
- `Fact` — факт (в шаблоне строится формулами из `Assumptions`)
- `WAPE` — общий WAPE
- `Assumptions` — коэффициенты для генерации факта (только для примера)
- `Charts` — пример графика
- `Guide` — короткая инструкция внутри файла

Если используете реальный факт — вставьте значения на лист `Fact` поверх формул (вставка **Значений**).

## 1) Импорт файлов в Excel (Windows, Excel 365/2021)

Повторить для каждого файла (прогноз и факт):

1. **Данные → Из текста/CSV**.
2. Выберите CSV.
3. В окне импорта:
   - **Разделитель**: `;`
   - **Кодировка**: `65001: Unicode (UTF‑8)`
   - **Доп. параметры** (если есть): десятичный разделитель `,`.
4. Нажмите **Загрузить**.

Переименуйте листы:
- `Forecast` — прогноз
- `Fact` — факт

## 2) Проверка соответствия строк (Код КП)

Важно, чтобы строки совпадали по `Код КП` в обоих листах.

**Шаги:**
1. Отсортируйте оба листа по колонке **A (Код КП)** по возрастанию.
2. На листе `Forecast` в колонке рядом (например, `B` или справа от таблицы) проверьте совпадение:

Формула (в строке 2):
```
=IF(COUNTIF(Fact!$A:$A, A2)=1, "OK", "MISSING")
```
Русский Excel (если нужны локализованные функции):
```
=ЕСЛИ(СЧЁТЕСЛИ(Fact!$A:$A; A2)=1; "OK"; "MISSING")
```
Протяните вниз — все строки должны быть `OK`.
В шаблоне уже есть колонка `Match_Check` с этой формулой.

## 3) Найти последнюю колонку и строку

1. Перейдите на лист `Forecast`.
2. Нажмите **Ctrl+Shift+End** — курсор в последней заполненной ячейке.
3. Запомните:
   - Букву последней колонки (например, `HN`)
   - Номер последней строки (например, `23414`)

Ниже используйте это как `LAST_COL` и `LAST_ROW`.

## 4) Общий WAPE по всем данным

На новом листе `WAPE` вставьте формулы (замените `LAST_COL` и `LAST_ROW`).
Рекомендуемые ячейки: `B2` (сумма факта), `C2` (сумма |ошибок|), `D2` (WAPE).

**B2 — сумма факта:**
```
=SUM(Fact!B2:LAST_COLLAST_ROW)
```
Русский Excel:
```
=СУММ(Fact!B2:LAST_COLLAST_ROW)
```

**C2 — сумма |ошибок|:**
```
=SUMPRODUCT(ABS(Forecast!B2:LAST_COLLAST_ROW - Fact!B2:LAST_COLLAST_ROW))
```
Русский Excel:
```
=СУММПРОИЗВ(АБС(Forecast!B2:LAST_COLLAST_ROW - Fact!B2:LAST_COLLAST_ROW))
```

**D2 — WAPE:**
```
=IF(B2=0, "", C2/B2)
```
Русский Excel:
```
=ЕСЛИ(B2=0; ""; C2/B2)
```
где `B2` — сумма факта, `C2` — сумма |ошибок|.

## 5) WAPE по каждой КП (по строкам)

На листе `Forecast` справа от последней колонки добавьте три колонки:
- `Fact_Sum`
- `Abs_Error`
- `WAPE`

Для строки 2 (замените `LAST_COL`):

**Fact_Sum:**
```
=SUM(Fact!B2:LAST_COL2)
```

**Abs_Error:**
```
=SUMPRODUCT(ABS(Forecast!B2:LAST_COL2 - Fact!B2:LAST_COL2))
```

**WAPE (в той же строке):**
```
=IF(FACT_SUM_CELL=0, "", ABS_ERROR_CELL/FACT_SUM_CELL)
```
Русский Excel:
```
=ЕСЛИ(FACT_SUM_CELL=0; ""; ABS_ERROR_CELL/FACT_SUM_CELL)
```

Где `FACT_SUM_CELL` — ячейка с `Fact_Sum`, `ABS_ERROR_CELL` — ячейка с `Abs_Error`
в той же строке. Протяните формулы вниз.

## 6) Быстрый график (простая проверка)

Простой график «Прогноз vs Факт» для одной строки:

1. На листе `Forecast` выделите заголовок дней `B1:LAST_COL1`.
2. Удерживая Cmd, выделите строку значений прогноза `B2:LAST_COL2`.
3. **Вставка → Диаграммы → Линейная**.
4. Добавьте вторую серию: **Конструктор диаграмм → Выбрать данные → Добавить**  
   Диапазон значений: `Fact!B2:LAST_COL2`.

В шаблоне есть лист `Charts` с готовым примером для строки 2.

## 7) Частые проблемы

- **Факт вставлен поверх формул**: используйте вставку **Значений**, чтобы заменить формулы на числа.
- **Числа как текст**: выделите диапазон, **Данные → Текст по столбцам → Далее → Далее → Дополнительно**,
  разделитель дробной части `,`, тысячи ` ` (пробел), затем **Готово**.
- **Разные КП между листами**: пересортируйте и проверьте формулу из шага 2.
- **Большой файл**: лучше закрыть лишние книги и отключить автопересчет
  (Формулы → Параметры вычислений → Вручную), затем пересчитать по кнопке.
- **Если формулы не принимаются**: попробуйте английские названия функций или наоборот,
  и убедитесь, что разделитель аргументов — `;` для русской локали.

---
