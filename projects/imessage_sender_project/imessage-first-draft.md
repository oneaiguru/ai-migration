# Первый Драфт: Скрипт для рассылки iMessage на 5 номеров

## Что нужно, чтобы начать

Для запуска первой версии скрипта вам потребуется:

1. **Компьютер Mac** с установленной macOS 12 или новее
2. **Python 3.7+** установленный на вашем Mac
3. **Активированный iMessage** с вашим Apple ID
4. **Активное интернет-соединение** для отправки iMessage
5. **Список из 5 номеров телефонов** в формате, совместимом с iMessage (+7XXXXXXXXXX)

## Базовый скрипт для отправки iMessage

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Скрипт для рассылки iMessage на 5 номеров
Версия: 0.1
"""

import os
import csv
import time
import random
import subprocess
from datetime import datetime

class IMessageSender:
    """Класс для отправки iMessage сообщений через Messages.app на macOS"""
    
    def __init__(self, log_file="imessage_log.txt"):
        """Инициализация класса"""
        self.log_file = log_file
        self.setup_logging()
    
    def setup_logging(self):
        """Настройка логирования"""
        with open(self.log_file, "a", encoding="utf-8") as f:
            f.write(f"\n{'='*50}\n")
            f.write(f"Сессия начата: {datetime.now()}\n")
            f.write(f"{'='*50}\n")
    
    def log_message(self, phone, message, status):
        """Запись информации о сообщении в лог"""
        with open(self.log_file, "a", encoding="utf-8") as f:
            f.write(f"{datetime.now()} | {phone} | {status} | {message[:30]}...\n")
    
    def send_message(self, phone_number, message):
        """Отправка iMessage через AppleScript"""
        # Создаем временный AppleScript
        apple_script = f'''
        tell application "Messages"
            set targetService to 1st service whose service type = iMessage
            set targetBuddy to buddy "{phone_number}" of targetService
            send "{message}" to targetBuddy
        end tell
        '''
        
        # Выполняем AppleScript
        try:
            subprocess.run(["osascript", "-e", apple_script], check=True, capture_output=True)
            self.log_message(phone_number, message, "ОТПРАВЛЕНО")
            return True
        except subprocess.CalledProcessError as e:
            self.log_message(phone_number, message, f"ОШИБКА: {e}")
            return False
    
    def load_numbers_from_csv(self, csv_file):
        """Загрузка номеров телефонов из CSV файла"""
        phone_numbers = []
        try:
            with open(csv_file, 'r', encoding='utf-8') as f:
                reader = csv.reader(f)
                for row in reader:
                    if row and row[0].strip():
                        phone_numbers.append(row[0].strip())
            return phone_numbers
        except Exception as e:
            print(f"Ошибка при загрузке номеров из файла: {e}")
            return []
    
    def send_bulk_messages(self, phone_numbers, message, delay_min=3, delay_max=7):
        """Отправка сообщений на несколько номеров с задержкой"""
        successful = 0
        failed = 0
        
        for i, phone in enumerate(phone_numbers, 1):
            print(f"Отправка сообщения на номер {phone} ({i}/{len(phone_numbers)})...")
            if self.send_message(phone, message):
                successful += 1
            else:
                failed += 1
            
            # Пауза между отправками (кроме последнего сообщения)
            if i < len(phone_numbers):
                delay = random.uniform(delay_min, delay_max)
                print(f"Пауза {delay:.2f} секунд...")
                time.sleep(delay)
        
        return successful, failed

def main():
    """Основная функция скрипта"""
    sender = IMessageSender()
    
    # Демонстрационные номера (нужно заменить на реальные)
    phone_numbers = [
        "+79161234567",
        "+79162345678",
        "+79163456789",
        "+79164567890",
        "+79165678901"
    ]
    
    # Пример загрузки номеров из CSV (закомментировано)
    # phone_numbers = sender.load_numbers_from_csv("contacts.csv")
    
    message = "Это тестовое сообщение от сервиса рассылки iMessage."
    
    print(f"Начинаем отправку сообщений на {len(phone_numbers)} номеров...")
    successful, failed = sender.send_bulk_messages(phone_numbers, message)
    
    print("\nРезультаты отправки:")
    print(f"Успешно отправлено: {successful}")
    print(f"Не удалось отправить: {failed}")
    print(f"Подробную информацию смотрите в файле логов: {sender.log_file}")

if __name__ == "__main__":
    main()
```

## Инструкция по запуску

1. Создайте файл `imessage_sender.py` и скопируйте в него приведенный выше код
2. Откройте Terminal и перейдите в папку с файлом
3. Установите требуемые права на исполнение: `chmod +x imessage_sender.py`
4. Запустите скрипт: `python3 imessage_sender.py`

## BDD Спецификация (Behavior-Driven Development)

### Функциональные возможности: Отправка iMessage

```gherkin
Функционал: Отправка iMessage на заданные номера
  Как пользователь скрипта
  Я хочу отправлять iMessage на несколько номеров
  Чтобы автоматизировать рассылку сообщений

  Сценарий: Успешная отправка сообщения на 5 номеров
    Дано список из 5 телефонных номеров
    И текст сообщения для отправки
    Когда я запускаю скрипт для отправки сообщений
    Тогда скрипт должен успешно отправить сообщение на каждый номер
    И записать информацию об отправке в лог-файл
    И вывести статистику отправки после завершения

  Сценарий: Обработка ошибки отправки
    Дано список из 5 телефонных номеров, включая один недействительный
    И текст сообщения для отправки
    Когда я запускаю скрипт для отправки сообщений
    Тогда скрипт должен попытаться отправить сообщение на каждый номер
    И записать информацию об ошибке в лог-файл для недействительного номера
    И вывести корректную статистику отправки после завершения

  Сценарий: Задержка между отправками сообщений
    Дано список из 5 телефонных номеров
    И текст сообщения для отправки
    Когда я запускаю скрипт для отправки сообщений
    Тогда скрипт должен делать паузу между отправками сообщений
    И пауза должна быть случайной длительности в заданном диапазоне
```

### Функциональные возможности: Логирование

```gherkin
Функционал: Логирование отправки сообщений
  Как пользователь скрипта
  Я хочу видеть подробную информацию о процессе отправки
  Чтобы контролировать статус рассылки

  Сценарий: Создание лог-файла при первом запуске
    Когда я запускаю скрипт в первый раз
    Тогда скрипт должен создать лог-файл
    И записать в лог информацию о начале сессии

  Сценарий: Добавление записей в существующий лог-файл
    Дано существующий лог-файл с предыдущими записями
    Когда я запускаю скрипт повторно
    Тогда скрипт должен добавить новые записи в существующий лог-файл
    И не должен перезаписывать старые записи
```

## Матрица отслеживания требований

| ID | Требование | Приоритет | Сценарий BDD | Статус |
|----|------------|-----------|--------------|--------|
| R1 | Отправка SMS через iMessage | Высокий | Отправка iMessage на заданные номера | Реализовано |
| R2 | Обработка списка номеров | Высокий | Успешная отправка сообщения на 5 номеров | Реализовано |
| R3 | Логирование процесса отправки | Средний | Логирование отправки сообщений | Реализовано |
| R4 | Настраиваемые интервалы между отправками | Средний | Задержка между отправками сообщений | Реализовано |
| R5 | Обработка ошибок | Средний | Обработка ошибки отправки | Реализовано |

## Стоимость первого этапа

### Стоимость и объем работ первого этапа:

**Цена: 15 000 рублей**

Включает в себя:
1. Установка и настройка базового скрипта на Mac-сервере
2. Тестирование отправки на 5 номеров
3. Настройка логирования
4. Базовая документация
5. 2 часа консультаций по использованию скрипта

### Требования для оплаты (Definition of Done):

1. Скрипт успешно отправляет сообщения на 5 указанных номеров
2. Логирование корректно записывает информацию об отправке
3. Скрипт обрабатывает основные ошибки
4. Предоставлена базовая документация по использованию

### График платежей:
- 50% (7 500 рублей) - предоплата для начала работ
- 50% (7 500 рублей) - после демонстрации работающего решения и подписания акта приема-передачи

## Дальнейшие шаги разработки

После успешной реализации первого этапа будут выполнены следующие задачи:

1. Расширение функциональности скрипта:
   - Поддержка медиафайлов
   - Импорт контактов из Excel/CSV/TXT
   - Шаблонизация сообщений
   - Поддержка мультиаккаунта
   
2. Разработка графического интерфейса:
   - Простой интерфейс для управления рассылками
   - Визуализация статистики
   - Настройка параметров через GUI

3. Интеграционные возможности:
   - API для взаимодействия с внешними системами
   - Webhook-уведомления о статусе отправки

## Заключение

Данный первый драфт демонстрирует базовую функциональность рассылки iMessage, которая будет расширена в полной версии решения. После успешного тестирования этого скрипта мы сможем перейти к реализации всех требуемых функций, описанных в техническом задании.
