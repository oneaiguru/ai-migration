<!-- ARCHIVED FILE -->
# 01 - Phase 1 Bulk Edit PRD (archived)


# Phase 1 – Bulk Edit & Tag Parity PRD

## Context
- Scope driven by `docs/Tasks/parity-backlog-and-plan.md` Phase 1 and follow-up audit (`/Users/m/Desktop/bb.markdown`).
- Evidence sources reviewed:
  - CH3 Employees manual (`/Users/m/Documents/replica/estimation/processing_manual/process/chapters/CH3_Employees.md`).
  - Schedule manuals (CH5 Advanced/Shift/Build) for scheme & skill semantics.
  - Appendices (`CH7_Appendices.md`) for import/tag templates.
  - Screenshots from the production system: `60e7fb65-7584-483c-94d2-dc039c0c2a2d.png` (edit drawer), `69fb8e9b-d741-440c-8827-c6ea22e84cd6.png` (tag catalogue).
  - Parity backlog (`docs/Tasks/parity-backlog-and-plan.md`) and parity plan (`docs/EMPLOYEE_MANAGEMENT_PARITY_PLAN.md`).

## Goals
1. Deliver matrix-style bulk edit actions matching WFM behaviour.
2. Align tag manager UX with production: accessible from toolbar, supports add/replace/remove semantics, and tag catalogue management without relying on row selection.
3. Surface bulk edit comments as timestamped timeline entries inside the employee drawer.
4. Remove parity gaps called out in `/Users/m/Desktop/bb.markdown` for Phase 1 items.

## Non-Goals
- Reworking row-click behaviour or ESC-focus handling (tracked separately in audit).
- Implementing manager pickers (real system has no manager field; retain parity by omitting additional UX until requirements confirmed).
- Persisting changes to a backend (mock data only).

## User Stories
1. **Bulk Update Operator:** “As a workforce planner I can mass update status, team, hour norm, scheme attachment, skills, reserve skills, tags, and leave a note so I don’t open each employee individually.”
2. **Tag Librarian:** “As an admin I can open the tag modal even with zero selections to create, merge, or remove tag definitions, then assign/remove tags for selected rows.”
3. **Auditor:** “When a bulk edit applies a comment, it appears chronologically inside each employee’s task timeline with metadata so I can audit who triggered mass actions.”

## Functional Requirements
### 1. Matrix Actions
- **Fields & Actions**
  - Status: replace only.
  - Team: replace only (updates `workInfo.team` + department).
  - Hour Norm: replace numeric value.
  - Work Scheme: add/replace/remove (similar semantics to CH3 work scheme management).
  - Skills (primary) & Reserve Skills: add/replace/remove via multi-value chips; new labels create placeholder skills with autogenerated IDs (category defaults `technical` for skills, `product` for reserve).
  - Tags: add/replace/remove, deduplicated and trimmed.
  - Comment: optional text, recorded as task timeline entry with source `bulk-edit`.
- **UX**
  - Introduce action toggles per field (`Добавить всем`, `Заменить всем`, `Удалить у всех`) mirroring WFM matrix.
  - Disable value inputs until an action is active; auto-enable single-action fields on value entry.
  - Validation: at least one action or comment required, numeric normalization for hour norm, scheme/skill selection mandatory when corresponding action chosen.
  - Result toast `Изменения применены...` and close drawer on success.
- **Data handling**
  - Apply transformations in `src/components/EmployeeListContainer.tsx` with helper(s) for add/replace/remove semantics.
  - Update employees immutably using `onEmployeesChange` callback.
  - Record metadata updates (`updatedAt`, `lastModifiedBy`).

### 2. Tag Manager Parity
- Toolbar “Теги” remains enabled; when no employees selected, assignment controls are disabled but catalogue management allowed.
- Modal displays palette as per screenshot, with ability to:
  - Create tag (name, palette) with validation (unique name, max columns).
  - Delete tag definition globally.
  - When rows selected: apply add/replace/remove actions similar to bulk matrix with 4-tag limit per WFM (enforce cap).
- Provide inline guidance and error states per CH3 Appendix 6 notes.

### 3. Task Timeline Integration
- Extend `Employee.tasks` to structured entries (`{id, message, createdAt, createdBy, source}`) – already applied in types.
- In bulk edit submit, append `source: 'bulk-edit'` tasks for each selected employee when comment present.
- Update `EmployeeEditDrawer` to render tasks chronologically (newest first) with timestamp + source badge; ensure manual edits still possible.
- When saving drawer (manual edit), merge timeline updates with typed structure.

## Technical Tasks
1. **Type updates**
   - Convert `Employee.tasks` to typed timeline entries (`EmployeeTask`). Done in types; propagate to App seed data & components.
2. **EmployeeListContainer**
   - Replace legacy bulk edit state with matrix state machine (actions + values).
   - Implement UI per requirements (action buttons, toggled disabled inputs, textareas to support multi-line entry, tag chips).
   - Integrate helper functions `applyCollectionOperation`, `createTaskEntry`, `resolveSkills` to manipulate data safely.
   - Update submit logic with validation, short-circuit error states, metadata updates, task timeline entries.
3. **Tag Manager**
   - Refactor modal state: always accessible, separate “catalogue” mode vs “assignment” mode.
   - Introduce add/replace/remove toggles with max 4 tags constraint when assigning.
   - Ensure removal of tag definition cascades to employees.
4. **Task timeline UI** (`EmployeeEditDrawer.tsx`)
   - Convert textarea binding to match typed tasks array (editing should split lines into timeline entries on save).
   - Render tasks with timestamp, display comment source (bulk/manual).
5. **Seeds & fixtures**
   - Update `src/App.tsx` mock data using helper `createSeedTasks` (done): ensure timeline items sorted.
6. **Playwright tests**
   - Extend `tests/employee-list.spec.ts` to cover matrix actions (e.g., add skill + comment, verify comment surfaces in drawer).
   - Add scenario for tag manager parity (create tag, assign/remove) if time permits.

## Acceptance Criteria
- Bulk edit drawer shows matrix of actions mirroring WFM; submitting with valid combination mutates state accordingly and closes drawer.
- Hour norm, work scheme, skill, reserve skill, tag updates reflect on table/drawer state.
- Tag manager accessible regardless of selection; new tag definition persist in modal session; applying add/replace/remove updates selected rows.
- Bulk edit comments appear in employee drawer timeline with timestamp and “Массовое редактирование” label.
- Playwright suite updated to cover at least one matrix action and comment timeline assertion.

## Open Questions / Follow-ups
- Confirm 4-tag limit from screenshot Appendix – enforce now? (default yes per WFM doc).
- Do skill/reserve skill actions persist across sessions? (out of scope for now – mock state only).
- ESC/focus trap parity to be tracked separately (new backlog item).

## Timeline (This Session)
1. Finalize type + seed updates (completed).
2. Build matrix state + UI (in progress) → integrate validation & operations.
3. Refactor tag manager (next).
4. Implement timeline rendering in edit drawer.
5. Update tests + run `npm run build`.
6. Document changes in parity plan/backlog + screenshot index as needed.

