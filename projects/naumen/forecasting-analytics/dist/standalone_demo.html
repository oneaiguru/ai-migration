<!DOCTYPE html>
<!-- /Users/m/Documents/wfm/competitor/naumen/forecasting-analytics/demo/index.html -->
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naumen WFM - Forecasting & Analytics Demo</title>
    
    <!-- Chart.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-date-fns/3.0.0/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .metric-card {
            background: linear-gradient(135deg, var(--bg-from), var(--bg-to));
            border: 1px solid var(--border-color);
        }
        
        .metric-card.blue {
            --bg-from: #dbeafe;
            --bg-to: #bfdbfe;
            --border-color: #93c5fd;
        }
        
        .metric-card.green {
            --bg-from: #d1fae5;
            --bg-to: #a7f3d0;
            --border-color: #6ee7b7;
        }
        
        .metric-card.orange {
            --bg-from: #fed7aa;
            --bg-to: #fdba74;
            --border-color: #fb923c;
        }
        
        .metric-card.purple {
            --bg-from: #e9d5ff;
            --bg-to: #d8b4fe;
            --border-color: #c084fc;
        }
        
        .loading-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .forecast-button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            transition: all 0.3s ease;
        }
        
        .forecast-button:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .forecast-button:disabled {
            background: #9ca3af;
            transform: none;
            box-shadow: none;
        }
        
        .parameter-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
        }
        
        .algorithm-option {
            transition: all 0.2s ease;
        }
        
        .algorithm-option:hover {
            background: #f8fafc;
            transform: translateX(2px);
        }
        
        .algorithm-option.selected {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑</h1>
                        <p class="text-sm text-gray-600 mt-1">
                            –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è-2 ‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å: <span id="accuracy-display">84.2</span>%
                        </p>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <select id="algorithm-select" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="basic_extrapolation">–ë–∞–∑–æ–≤–∞—è —ç–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è</option>
                            <option value="arima">ARIMA –º–æ–¥–µ–ª—å</option>
                            <option value="linear_regression">–õ–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è</option>
                            <option value="seasonal_naive">–°–µ–∑–æ–Ω–Ω–∞—è –Ω–∞–∏–≤–Ω–∞—è</option>
                        </select>
                        
                        <select class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="day">–î–µ–Ω—å</option>
                            <option value="week" selected>–ù–µ–¥–µ–ª—è</option>
                            <option value="month">–ú–µ—Å—è—Ü</option>
                        </select>
                        
                        <button 
                            id="generate-forecast-btn"
                            class="forecast-button px-4 py-2 text-white rounded-md text-sm flex items-center gap-2"
                        >
                            <span>üìä</span>
                            <span id="btn-text">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex gap-6">
                <!-- Left Sidebar -->
                <aside class="w-80 space-y-6">
                    <!-- Algorithm Selection -->
                    <div class="parameter-card rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                        
                        <div class="space-y-3" id="algorithm-options">
                            <!-- Algorithm options will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Parameters -->
                    <div class="parameter-card rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                        <div id="parameters-container">
                            <!-- Parameters will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Date Range -->
                    <div class="parameter-card rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">–ü–µ—Ä–∏–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∞</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞
                                </label>
                                <input
                                    type="date"
                                    id="start-date"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞
                                </label>
                                <input
                                    type="date"
                                    id="end-date"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                />
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="flex-1 space-y-6">
                    <!-- Error Message -->
                    <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-red-800 text-sm" id="error-text"></div>
                        </div>
                    </div>

                    <!-- Metrics Cards -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="metric-card blue rounded-lg p-4">
                            <div class="text-2xl font-bold text-blue-600" id="total-calls">
                                0
                            </div>
                            <div class="text-sm text-blue-800">–ü—Ä–æ–≥–Ω–æ–∑ –∑–≤–æ–Ω–∫–æ–≤</div>
                            <div class="text-xs text-blue-600 mt-1">–Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ 4 –¥–Ω—è</div>
                        </div>
                        
                        <div class="metric-card green rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-600" id="accuracy">84.2%</div>
                            <div class="text-sm text-green-800">–¢–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏</div>
                            <div class="text-xs text-green-600 mt-1">MAPE: <span id="mape">0.0</span>%</div>
                        </div>
                        
                        <div class="metric-card orange rounded-lg p-4">
                            <div class="text-2xl font-bold text-orange-600" id="confidence">85%</div>
                            <div class="text-sm text-orange-800">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                            <div class="text-xs text-orange-600 mt-1">—Å—Ä–µ–¥–Ω—è—è –ø–æ –ø–µ—Ä–∏–æ–¥—É</div>
                        </div>
                        
                        <div class="metric-card purple rounded-lg p-4">
                            <div class="text-2xl font-bold text-purple-600" id="peak-hour">14:00</div>
                            <div class="text-sm text-purple-800">–ü–∏–∫–æ–≤—ã–π —á–∞—Å</div>
                            <div class="text-xs text-purple-600 mt-1">
                                <span id="peak-calls">0</span> –∑–≤–æ–Ω–∫–æ–≤
                            </div>
                        </div>
                    </div>

                    <!-- Chart Area -->
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="flex items-center justify-between p-4 border-b border-gray-200">
                            <div class="flex items-center gap-2">
                                <h3 class="text-lg font-medium text-gray-900">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏</h3>
                                <span class="text-sm text-gray-500" id="chart-intervals">
                                    (0 –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤)
                                </span>
                            </div>
                            
                            <div class="flex items-center gap-4 text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-blue-500 rounded"></div>
                                    <span>–§–∞–∫—Ç</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-green-500 rounded"></div>
                                    <span>–ü—Ä–æ–≥–Ω–æ–∑</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-green-200 rounded"></div>
                                    <span>–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-orange-500 rounded"></div>
                                    <span>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≥–µ–Ω—Ç–æ–≤</span>
                                </div>
                            </div>
                        </div>

                        <!-- Chart Container -->
                        <div class="p-4">
                            <div class="chart-container">
                                <canvas id="forecast-chart"></canvas>
                            </div>
                        </div>

                        <!-- Chart Controls -->
                        <div class="flex items-center justify-between p-4 border-t border-gray-200 bg-gray-50">
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <span>üîç</span>
                                <span>–ö–æ–ª–µ—Å–æ –º—ã—à–∏ - –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                                <span>‚Ä¢</span>
                                <span>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ - –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <button
                                    id="reset-zoom-btn"
                                    class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                                >
                                    üîÑ –°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±
                                </button>
                                
                                <button
                                    id="export-chart-btn"
                                    class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                                >
                                    üì∏ –≠–∫—Å–ø–æ—Ä—Ç
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Adjustments Table -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">–†—É—á–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</h3>
                        
                        <div id="adjustments-table-container">
                            <!-- Table will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update"></span>
                            </div>
                            
                            <div class="flex gap-3">
                                <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md text-sm hover:bg-gray-50 transition-colors">
                                    üì§ –≠–∫—Å–ø–æ—Ä—Ç
                                </button>
                                <button class="px-4 py-2 bg-green-600 text-white rounded-md text-sm hover:bg-green-700 transition-colors">
                                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑
                                </button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        // Global application state
        let appState = {
            selectedAlgorithm: 'basic_extrapolation',
            forecastData: [],
            chartInstance: null,
            loading: false,
            parameters: {}
        };

        // Algorithm configurations
        const algorithms = {
            'basic_extrapolation': {
                name: '–ë–∞–∑–æ–≤–∞—è —ç–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è',
                description: '–ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤',
                accuracy: 84.2,
                parameters: {
                    historical_weeks: { label: '–ù–µ–¥–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏', value: 4, min: 1, max: 12 },
                    seasonal_factor: { label: '–°–µ–∑–æ–Ω–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä', value: 1.0, min: 0.5, max: 2.0, step: 0.1 }
                }
            },
            'arima': {
                name: 'ARIMA –º–æ–¥–µ–ª—å',
                description: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ',
                accuracy: 91.5,
                parameters: {
                    p: { label: 'AR –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (p)', value: 1, min: 0, max: 5 },
                    d: { label: '–†–∞–∑–Ω–æ—Å—Ç–∏ (d)', value: 1, min: 0, max: 2 },
                    q: { label: 'MA –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (q)', value: 1, min: 0, max: 5 }
                }
            },
            'linear_regression': {
                name: '–õ–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è',
                description: '–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª–∏–Ω–µ–π–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤',
                accuracy: 78.8,
                parameters: {
                    trend_strength: { label: '–°–∏–ª–∞ —Ç—Ä–µ–Ω–¥–∞', value: 0.5, min: 0.1, max: 1.0, step: 0.1 }
                }
            },
            'seasonal_naive': {
                name: '–°–µ–∑–æ–Ω–Ω–∞—è –Ω–∞–∏–≤–Ω–∞—è',
                description: '–ü—Ä–æ—Å—Ç–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —Å–µ–∑–æ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤',
                accuracy: 76.3,
                parameters: {
                    season_length: { label: '–î–ª–∏–Ω–∞ —Å–µ–∑–æ–Ω–∞ (–¥–Ω–∏)', value: 7, min: 1, max: 30 }
                }
            }
        };

        // Initialize application
        function initApp() {
            setupDateDefaults();
            renderAlgorithmOptions();
            renderParameters();
            setupEventListeners();
            updateLastUpdate();
            
            // Generate initial forecast
            setTimeout(() => {
                generateForecast();
            }, 1000);
        }

        // Setup default dates
        function setupDateDefaults() {
            const today = new Date();
            const weekFromNow = new Date();
            weekFromNow.setDate(today.getDate() + 7);
            
            document.getElementById('start-date').value = today.toISOString().split('T')[0];
            document.getElementById('end-date').value = weekFromNow.toISOString().split('T')[0];
        }

        // Render algorithm options
        function renderAlgorithmOptions() {
            const container = document.getElementById('algorithm-options');
            container.innerHTML = '';
            
            Object.entries(algorithms).forEach(([id, config]) => {
                const isSelected = appState.selectedAlgorithm === id;
                
                const option = document.createElement('label');
                option.className = `algorithm-option flex items-start gap-3 cursor-pointer p-3 rounded-lg border ${
                    isSelected ? 'selected' : 'border-gray-200'
                }`;
                
                option.innerHTML = `
                    <input
                        type="radio"
                        name="algorithm"
                        value="${id}"
                        ${isSelected ? 'checked' : ''}
                        class="mt-1 text-blue-600 focus:ring-blue-500"
                    />
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">${config.name}</div>
                        <div class="text-sm text-gray-600">${config.description}</div>
                        <div class="text-xs text-blue-600 mt-1">–¢–æ—á–Ω–æ—Å—Ç—å: ${config.accuracy}%</div>
                    </div>
                `;
                
                option.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        appState.selectedAlgorithm = id;
                        renderAlgorithmOptions();
                        renderParameters();
                        updateAccuracy();
                    }
                });
                
                container.appendChild(option);
            });
        }

        // Render parameters
        function renderParameters() {
            const container = document.getElementById('parameters-container');
            const algorithm = algorithms[appState.selectedAlgorithm];
            
            if (!algorithm) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">–í—ã–±–µ—Ä–∏—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º</div>';
                return;
            }
            
            container.innerHTML = '';
            
            Object.entries(algorithm.parameters).forEach(([key, param]) => {
                const value = appState.parameters[key] || param.value;
                
                const paramDiv = document.createElement('div');
                paramDiv.className = 'space-y-2 mb-4';
                
                paramDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">
                        ${param.label}
                    </label>
                    <input
                        type="number"
                        min="${param.min || ''}"
                        max="${param.max || ''}"
                        step="${param.step || 1}"
                        value="${value}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        data-param="${key}"
                    />
                `;
                
                const input = paramDiv.querySelector('input');
                input.addEventListener('change', (e) => {
                    appState.parameters[key] = parseFloat(e.target.value);
                });
                
                container.appendChild(paramDiv);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('generate-forecast-btn').addEventListener('click', generateForecast);
            document.getElementById('algorithm-select').addEventListener('change', (e) => {
                appState.selectedAlgorithm = e.target.value;
                renderAlgorithmOptions();
                renderParameters();
                updateAccuracy();
            });
            
            document.getElementById('reset-zoom-btn').addEventListener('click', () => {
                if (appState.chartInstance) {
                    appState.chartInstance.resetZoom();
                }
            });
            
            document.getElementById('export-chart-btn').addEventListener('click', exportChart);
        }

        // Generate forecast data
        function generateForecast() {
            if (appState.loading) return;
            
            setLoading(true);
            
            // Simulate API call
            setTimeout(() => {
                const startDate = new Date(document.getElementById('start-date').value);
                const endDate = new Date(document.getElementById('end-date').value);
                
                appState.forecastData = generateMockData(startDate, endDate);
                
                updateMetrics();
                renderChart();
                renderAdjustmentsTable();
                setLoading(false);
            }, 2000);
        }

        // Generate mock forecast data
        function generateMockData(startDate, endDate) {
            const data = [];
            const current = new Date(startDate);
            
            while (current <= endDate) {
                for (let hour = 0; hour < 24; hour += 0.5) {
                    const timestamp = new Date(current);
                    timestamp.setHours(Math.floor(hour), (hour % 1) * 60);
                    
                    // Generate realistic patterns
                    let baseVolume = 20;
                    const hourOfDay = Math.floor(hour);
                    if (hourOfDay >= 9 && hourOfDay <= 17) baseVolume = 50;
                    if (hourOfDay >= 18 && hourOfDay <= 21) baseVolume = 35;
                    
                    const dayOfWeek = timestamp.getDay();
                    let dayMultiplier = 1;
                    if (dayOfWeek === 0 || dayOfWeek === 6) dayMultiplier = 0.6;
                    if (dayOfWeek >= 1 && dayOfWeek <= 3) dayMultiplier = 1.2;
                    
                    const algorithm = algorithms[appState.selectedAlgorithm];
                    const algorithmMultiplier = getAlgorithmMultiplier();
                    
                    const predicted = Math.round(baseVolume * dayMultiplier * algorithmMultiplier * (0.8 + Math.random() * 0.4));
                    const confidence = 0.7 + Math.random() * 0.25;
                    
                    // Generate actual data for past periods
                    const now = new Date();
                    const isPast = timestamp < now;
                    const actual = isPast ? Math.round(predicted * (0.9 + Math.random() * 0.2)) : undefined;
                    
                    data.push({
                        timestamp: timestamp.toISOString(),
                        predicted,
                        actual,
                        confidence,
                        adjustments: 0,
                        requiredAgents: Math.ceil(predicted * 0.15),
                        isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                        hour: hourOfDay,
                        dayOfWeek
                    });
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            return data;
        }

        // Get algorithm multiplier
        function getAlgorithmMultiplier() {
            switch (appState.selectedAlgorithm) {
                case 'arima': return 1.1;
                case 'linear_regression': return 0.95;
                case 'seasonal_naive': return 1.05;
                default: return 1.0;
            }
        }

        // Update metrics
        function updateMetrics() {
            const data = appState.forecastData;
            if (!data.length) return;
            
            const now = new Date();
            const futureData = data.filter(d => new Date(d.timestamp) >= now);
            const pastData = data.filter(d => d.actual !== undefined);
            
            // Total calls
            const totalCalls = futureData.reduce((sum, d) => sum + d.predicted, 0);
            document.getElementById('total-calls').textContent = totalCalls.toLocaleString();
            
            // Accuracy
            const algorithm = algorithms[appState.selectedAlgorithm];
            document.getElementById('accuracy').textContent = `${algorithm.accuracy}%`;
            document.getElementById('accuracy-display').textContent = algorithm.accuracy;
            
            // MAPE
            if (pastData.length > 0) {
                const totalPredicted = pastData.reduce((sum, d) => sum + d.predicted, 0);
                const totalActual = pastData.reduce((sum, d) => sum + d.actual, 0);
                const mape = Math.abs((totalPredicted - totalActual) / totalActual) * 100;
                document.getElementById('mape').textContent = mape.toFixed(1);
            }
            
            // Confidence
            const avgConfidence = futureData.reduce((sum, d) => sum + d.confidence, 0) / futureData.length;
            document.getElementById('confidence').textContent = `${Math.round(avgConfidence * 100)}%`;
            
            // Peak hour
            const peakItem = futureData.reduce((max, d) => d.predicted > (max?.predicted || 0) ? d : max, futureData[0]);
            if (peakItem) {
                document.getElementById('peak-hour').textContent = `${peakItem.hour}:00`;
                document.getElementById('peak-calls').textContent = peakItem.predicted;
            }
            
            // Chart intervals
            document.getElementById('chart-intervals').textContent = `(${data.length} –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤)`;
        }

        // Render chart
        function renderChart() {
            const canvas = document.getElementById('forecast-chart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (appState.chartInstance) {
                appState.chartInstance.destroy();
            }
            
            const data = appState.forecastData;
            const now = new Date();
            const currentTimeIndex = data.findIndex(point => new Date(point.timestamp) >= now);
            
            const labels = data.map(point => new Date(point.timestamp));
            
            const datasets = [];
            
            // Actual data
            const actualData = data.map(point => point.actual || null);
            if (actualData.some(val => val !== null)) {
                datasets.push({
                    label: '–§–∞–∫—Ç',
                    data: actualData,
                    borderColor: '#3B82F6',
                    backgroundColor: '#3B82F6',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 2,
                    pointHoverRadius: 4
                });
            }
            
            // Forecast data
            const forecastData = data.map((point, index) => 
                index >= currentTimeIndex ? point.predicted : null
            );
            datasets.push({
                label: '–ü—Ä–æ–≥–Ω–æ–∑',
                data: forecastData,
                borderColor: '#10B981',
                backgroundColor: '#10B981',
                fill: false,
                tension: 0.1,
                borderDash: [5, 5],
                pointRadius: 2,
                pointHoverRadius: 4
            });
            
            // Confidence intervals
            const upperBound = data.map((point, index) => 
                index >= currentTimeIndex ? point.predicted + (point.confidence * point.predicted * 0.3) : null
            );
            const lowerBound = data.map((point, index) => 
                index >= currentTimeIndex ? Math.max(0, point.predicted - (point.confidence * point.predicted * 0.3)) : null
            );
            
            datasets.push({
                label: '–í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞',
                data: upperBound,
                borderColor: 'rgba(16, 185, 129, 0.3)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: '+1',
                tension: 0.1,
                pointRadius: 0
            });
            
            datasets.push({
                label: '–ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞',
                data: lowerBound,
                borderColor: 'rgba(16, 185, 129, 0.3)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: false,
                tension: 0.1,
                pointRadius: 0
            });
            
            // Required agents
            datasets.push({
                label: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≥–µ–Ω—Ç–æ–≤',
                data: data.map(point => point.requiredAgents),
                borderColor: '#F59E0B',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                fill: false,
                tension: 0.1,
                pointRadius: 1,
                pointHoverRadius: 3
            });
            
            const config = {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                filter: function(legendItem) {
                                    return !legendItem.text.includes('–≥—Ä–∞–Ω–∏—Ü–∞');
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const date = new Date(tooltipItems[0].parsed.x);
                                    return date.toLocaleString('ru', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                },
                                afterBody: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const point = data[index];
                                    if (!point) return [];

                                    const lines = [];
                                    lines.push(`–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(point.confidence * 100).toFixed(1)}%`);
                                    if (point.isWeekend) lines.push('üìÖ –í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å');
                                    return lines;
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                currentTime: {
                                    type: 'line',
                                    mode: 'vertical',
                                    scaleID: 'x',
                                    value: now,
                                    borderColor: '#EF4444',
                                    borderWidth: 2,
                                    borderDash: [3, 3],
                                    label: {
                                        enabled: true,
                                        content: '–°–µ–π—á–∞—Å',
                                        position: 'top',
                                        backgroundColor: '#EF4444',
                                        color: 'white',
                                        fontSize: 10,
                                        padding: 4
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'DD.MM HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: '–í—Ä–µ–º—è'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–æ–Ω–∫–æ–≤'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x'
                            },
                            pan: {
                                enabled: true,
                                mode: 'x'
                            }
                        }
                    }
                }
            };
            
            appState.chartInstance = new Chart(ctx, config);
        }

        // Render adjustments table
        function renderAdjustmentsTable() {
            const container = document.getElementById('adjustments-table-container');
            const data = appState.forecastData;
            
            if (!data.length) {
                container.innerHTML = '<div class="bg-gray-50 rounded-lg p-4 text-center text-gray-500">–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑</div>';
                return;
            }
            
            const now = new Date();
            const futureData = data.filter(d => new Date(d.timestamp) >= now).slice(0, 10);
            
            let tableHTML = `
                <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">–ò–Ω—Ç–µ—Ä–≤–∞–ª</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">–ü—Ä–æ–≥–Ω–æ–∑</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">–ò—Ç–æ–≥–æ</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">–ê–≥–µ–Ω—Ç–æ–≤</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            futureData.forEach((item, index) => {
                const date = new Date(item.timestamp);
                tableHTML += `
                    <tr class="border-t border-gray-200 hover:bg-gray-50">
                        <td class="px-4 py-2 text-sm">
                            ${date.toLocaleDateString('ru', { 
                                day: '2-digit', 
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </td>
                        <td class="px-4 py-2 text-sm">${item.predicted}</td>
                        <td class="px-4 py-2">
                            <input 
                                type="number" 
                                value="0"
                                class="w-16 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </td>
                        <td class="px-4 py-2 text-sm font-medium">${item.predicted}</td>
                        <td class="px-4 py-2 text-sm text-blue-600">${item.requiredAgents}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        // Update accuracy display
        function updateAccuracy() {
            const algorithm = algorithms[appState.selectedAlgorithm];
            document.getElementById('accuracy-display').textContent = algorithm.accuracy;
        }

        // Set loading state
        function setLoading(loading) {
            appState.loading = loading;
            const btn = document.getElementById('generate-forecast-btn');
            const btnText = document.getElementById('btn-text');
            
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = `
                    <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    <span>–†–∞—Å—á—ë—Ç...</span>
                `;
            } else {
                btn.disabled = false;
                btn.innerHTML = `
                    <span>üìä</span>
                    <span>–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑</span>
                `;
            }
        }

        // Export chart
        function exportChart() {
            if (appState.chartInstance) {
                const url = appState.chartInstance.toBase64Image();
                const link = document.createElement('a');
                link.download = `forecast-chart-${new Date().toISOString().split('T')[0]}.png`;
                link.href = url;
                link.click();
            }
        }

        // Update last update time
        function updateLastUpdate() {
            document.getElementById('last-update').textContent = new Date().toLocaleString('ru');
            
            // Update every minute
            setInterval(() => {
                document.getElementById('last-update').textContent = new Date().toLocaleString('ru');
            }, 60000);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>