# Deployment Blocker Analysis - December 7, 2025

## Summary

Deployment to production org `myorg` is blocked by **mismatches between repo metadata/tests and the live org configuration**.

## Validation Results

### Attempt 1: Full force-app/main/default
```bash
sf project deploy validate --source-dir force-app/main/default --target-org myorg --test-level RunLocalTests
```

**Result**: 2 component failures
1. `QB_Payment_Link__c`: "Can not specify 'length' for a CustomField of type Url"
2. `Supplier__c`: "Cannot update referenceTo" (field exists in org with different target)

### Attempt 2: Classes only
```bash
sf project deploy start --source-dir force-app/main/default/classes --target-org myorg --test-level RunLocalTests
```

**Result**: 35 test failures, 9 passing
- **Root cause**: Tests fail with `REQUIRED_FIELD_MISSING: [Supplier__c]`
- **Coverage**: 35% (need 75%), Trigger: 0%

## Root Cause Analysis

The production org has `Supplier__c` configured as a **required field** on Opportunity. The repo's test classes don't set this field when creating test Opportunities.

### Affected Test Classes
- `QBInvoiceIntegrationQueueableTest.setupTestData` (line 38)
- `QuickBooksInvoiceControllerTest.setup` (line 20)
- `OpportunityQuickBooksTriggerTest.testTriggerOnInsert` (line 71)
- `OpportunityQuickBooksTriggerTest.testTriggerOnUpdate` (line 42)
- `QuickBooksTestUtility.testOpportunityFields` (line 30)

## What Needs to Happen

### Option A: Fix test data to match org requirements
The test classes need to create a valid Supplier record and set `Supplier__c` on Opportunity inserts. This is a **legitimate fix** (not hacking to pass), as the tests genuinely don't match the org's data model.

### Option B: Temporary workaround
If the Apex fix is urgent, the org admin could:
1. Temporarily make `Supplier__c` not required
2. Deploy the classes
3. Re-enable the required constraint

### Option C: Sync org configuration to repo
Review whether `Supplier__c` should be required and align org and repo expectations.

## What NOT to Do
- Don't remove or modify field metadata (QB_Payment_Link__c, Supplier__c) to work around deployment
- Don't edit tests in ad-hoc ways to chase coverage
- Don't deploy without tests (`NoTestRun` not allowed on production)

## Files Involved
- `force-app/main/default/classes/QBInvoiceIntegrationQueueable.cls` - Contains the "preserve payment link" fix
- `force-app/main/default/objects/Opportunity/fields/QB_Payment_Link__c.field-meta.xml` - Has length attribute that org rejects
- `force-app/main/default/objects/Opportunity/fields/Supplier__c.field-meta.xml` - Has different referenceTo than org

## Recommendation

**Option A is the correct path**: Update test data setup methods to create and assign a Supplier__c value. This aligns the tests with the production org's actual data model. This is not "hacking to pass" - it's fixing a genuine test data gap.

---
*Generated by next-agent deployment analysis*
