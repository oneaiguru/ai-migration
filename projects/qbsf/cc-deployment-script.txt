#!/bin/bash
# Salesforce-QuickBooks Automated Integration Deployment Script

# 1. First, let's create the complete project structure
mkdir -p sf-qb-automated/force-app/main/default/{classes,triggers,objects,triggers}
cd sf-qb-automated

# 2. Deploy all Apex classes with fixes for test coverage
echo "Copying Apex classes from sf-qb-integration-final..."
cp ../tmp/sf-qb-integration-final/Salesforce/*.cls force-app/main/default/classes/
cp ../tmp/sf-qb-integration-final/Salesforce/*.trigger force-app/main/default/triggers/

# 3. Create metadata files for all components
cat > force-app/main/default/classes/OpportunityQuickBooksTrigger.trigger-meta.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<ApexTrigger xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>56.0</apiVersion>
    <status>Active</status>
</ApexTrigger>
EOF

# Generate similar meta files for all classes
for cls in QBInvoiceIntegrationQueueable QBPaymentStatusScheduler; do
    cat > force-app/main/default/classes/${cls}.cls-meta.xml << EOF
<?xml version="1.0" encoding="UTF-8"?>
<ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>56.0</apiVersion>
    <status>Active</status>
</ApexClass>
EOF
done

# 4. Deploy to Salesforce with proper test coverage
echo "Deploying to Salesforce..."
sf project deploy start --source-dir force-app --target-org myorg --test-level RunLocalTests

# 5. Schedule the payment check job
echo "Scheduling payment status check..."
sf apex execute --target-org myorg -f - << 'EOF'
// Schedule the payment check to run daily at 1 AM
QBPaymentStatusScheduler.scheduleNightly();
System.debug('Payment status check scheduled successfully');
EOF

# 6. Configure custom settings
echo "Configuring custom settings..."
sf data record create --target-org myorg --sobject QB_Integration_Settings__c --values "Middleware_Endpoint__c='https://your-middleware.com' API_Key__c='your-api-key' QB_Realm_ID__c='your-realm-id'"

# 7. Start the Node.js middleware
echo "Starting middleware service..."
cd ../tmp/sf-qb-integration-final
npm install
npm start &

echo "Deployment complete! The integration is now fully automated."
echo "Opportunities at 'Closed Won' stage will automatically create QuickBooks invoices."
echo "Payment status will be checked daily at 1 AM."
