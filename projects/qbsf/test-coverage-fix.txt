#!/bin/bash
# Correct test coverage fix script for QuickBooks-Salesforce integration
# Using proper sf commands syntax

echo "=== QuickBooks-Salesforce Integration Test Coverage Fix ==="
echo ""

# Set org alias - adjust if needed
ORG_ALIAS="myorg"

# Check if Salesforce CLI is installed
if ! command -v sf &> /dev/null; then
    echo "Error: Salesforce CLI (sf) is not installed"
    echo "Please install it from: https://developer.salesforce.com/tools/sfdxcli"
    exit 1
fi

# Check if authenticated to Salesforce
echo "Checking Salesforce authentication..."
if ! sf org display --target-org "$ORG_ALIAS" &> /dev/null; then
    echo "Not authenticated. Let's authenticate to Salesforce..."
    echo "This will open a browser window for authentication."
    sf org login web --alias "$ORG_ALIAS" --instance-url https://login.salesforce.com
fi

# Create test folder structure if it doesn't exist
mkdir -p force-app/main/default/classes

# Create comprehensive test for QuickBooksAPIService
echo "Creating comprehensive test for QuickBooksAPIService..."
cat > force-app/main/default/classes/QuickBooksComprehensiveTest.cls << 'EOF'
/**
 * Comprehensive test class for QuickBooks integration
 * Covers both the controller and API service
 */
@isTest
private class QuickBooksComprehensiveTest {

    @testSetup
    static void setup() {
        // Create test settings
        QuickBooks_Settings__c settings = new QuickBooks_Settings__c();
        settings.Middleware_URL__c = 'https://test.example.com';
        settings.API_Key__c = 'test_api_key';
        settings.QB_Realm_ID__c = 'test_realm';
        insert settings;
        
        // Create test account
        Account testAccount = new Account(
            Name = 'Test Account',
            BillingStreet = '123 Test St',
            BillingCity = 'Test City',
            BillingState = 'TS',
            BillingPostalCode = '12345'
        );
        insert testAccount;
        
        // Create test opportunity
        Opportunity testOpp = new Opportunity(
            Name = 'Test Opportunity',
            AccountId = testAccount.Id,
            StageName = 'Closed Won',
            CloseDate = Date.today().addDays(30),
            Amount = 1000
        );
        insert testOpp;
    }
    
    // --- QuickBooksInvoiceController Tests ---
    
    @isTest
    static void testCreateInvoiceSuccess() {
        Opportunity opp = [SELECT Id FROM Opportunity LIMIT 1];
        
        Test.startTest();
        Test.setMock(HttpCalloutMock.class, new QuickBooksMockHttpResponse());
        
        QuickBooksInvoiceController.InvoiceResult result = 
            QuickBooksInvoiceController.createInvoice(opp.Id);
        
        Test.stopTest();
        
        System.assertEquals(true, result.success);
        System.assertNotEquals(null, result.invoiceId);
        System.assertNotEquals(null, result.invoiceNumber);
    }
    
    @isTest
    static void testCreateInvoiceAlreadyExists() {
        Opportunity opp = [SELECT Id FROM Opportunity LIMIT 1];
        opp.QB_Invoice_ID__c = 'INV-123';
        update opp;
        
        Test.startTest();
        
        QuickBooksInvoiceController.InvoiceResult result =
            QuickBooksInvoiceController.createInvoice(opp.Id);
        
        Test.stopTest();
        
        System.assertEquals(false, result.success);
        System.assertEquals('Invoice already exists for this opportunity', result.message);
    }
    
    @isTest
    static void testCreateInvoiceMissingSettings() {
        Opportunity opp = [SELECT Id FROM Opportunity LIMIT 1];
        
        // Delete the settings to simulate missing configuration
        delete [SELECT Id FROM QuickBooks_Settings__c];
        
        Test.startTest();
        
        QuickBooksInvoiceController.InvoiceResult result = 
            QuickBooksInvoiceController.createInvoice(opp.Id);
        
        Test.stopTest();
        
        System.assertEquals(false, result.success);
        System.assertEquals('QuickBooks integration is not configured. Please contact your administrator.', result.message);
    }
    
    // --- QuickBooksAPIService Tests ---
    
    @isTest
    static void testAPIServiceCreateInvoiceSuccess() {
        Opportunity opp = [SELECT Id FROM Opportunity LIMIT 1];
        
        Test.startTest();
        Test.setMock(HttpCalloutMock.class, new QuickBooksMockHttpResponse());
        
        QuickBooksInvoiceController.InvoiceResult result = 
            QuickBooksAPIService.createInvoice(
                opp.Id, 
                'https://test.salesforce.com', 
                '1234567890'
            );
        
        Test.stopTest();
        
        System.assertEquals(true, result.success);
        System.assertEquals('Invoice created successfully', result.message);
        System.assertEquals('INV-456', result.invoiceId);
        System.assertEquals('INV-456', result.invoiceNumber);
    }
    
    @isTest
    static void testAPIServiceCreateInvoiceError() {
        Opportunity opp = [SELECT Id FROM Opportunity LIMIT 1];
        
        Test.startTest();
        Test.setMock(HttpCalloutMock.class, new QuickBooksMockErrorResponse());
        
        QuickBooksInvoiceController.InvoiceResult result = 
            QuickBooksAPIService.createInvoice(
                opp.Id, 
                'https://test.salesforce.com', 
                '1234567890'
            );
        
        Test.stopTest();
        
        System.assertEquals(false, result.success);
        System.assert(result.message.startsWith('API Error:'));
    }
    
    @isTest
    static void testAPIServiceCreateInvoiceException() {
        Opportunity opp = [SELECT Id FROM Opportunity LIMIT 1];
        
        // Delete the settings to cause an exception
        delete [SELECT Id FROM QuickBooks_Settings__c];
        
        Test.startTest();
        
        QuickBooksInvoiceController.InvoiceResult result = 
            QuickBooksAPIService.createInvoice(
                opp.Id, 
                'https://test.salesforce.com', 
                '1234567890'
            );
        
        Test.stopTest();
        
        System.assertEquals(false, result.success);
        System.assert(result.message.startsWith('Error calling API:'));
    }
    
    @isTest
    static void testAPIServiceTestConnectionSuccess() {
        Test.startTest();
        Test.setMock(HttpCalloutMock.class, new QuickBooksMockHttpResponse());
        
        Boolean result = QuickBooksAPIService.testConnection();
        
        Test.stopTest();
        
        System.assertEquals(true, result);
    }
    
    @isTest
    static void testAPIServiceTestConnectionFailure() {
        Test.startTest();
        Test.setMock(HttpCalloutMock.class, new QuickBooksMockErrorResponse());
        
        Boolean result = QuickBooksAPIService.testConnection();
        
        Test.stopTest();
        
        System.assertEquals(false, result);
    }
    
    @isTest
    static void testAPIServiceTestConnectionException() {
        // Delete the settings to cause an exception
        delete [SELECT Id FROM QuickBooks_Settings__c];
        
        Test.startTest();
        
        Boolean result = QuickBooksAPIService.testConnection();
        
        Test.stopTest();
        
        System.assertEquals(false, result);
    }
    
    // Mock HTTP responses for testing
    
    private class QuickBooksMockHttpResponse implements HttpCalloutMock {
        public HTTPResponse respond(HTTPRequest req) {
            HttpResponse res = new HttpResponse();
            res.setHeader('Content-Type', 'application/json');
            res.setStatusCode(200);
            res.setBody('{"success":true,"invoiceId":"INV-456","invoiceNumber":"INV-456","message":"Invoice created successfully"}');
            return res;
        }
    }
    
    private class QuickBooksMockErrorResponse implements HttpCalloutMock {
        public HTTPResponse respond(HTTPRequest req) {
            HttpResponse res = new HttpResponse();
            res.setHeader('Content-Type', 'application/json');
            res.setStatusCode(400);
            res.setBody('{"success":false,"message":"Invalid request"}');
            return res;
        }
    }
}
EOF

# Create meta XML file for the test class
cat > force-app/main/default/classes/QuickBooksComprehensiveTest.cls-meta.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>57.0</apiVersion>
    <status>Active</status>
</ApexClass>
EOF

echo ""
echo "=== Deployment and Test Commands ==="
echo ""
echo "The correct sf commands for test coverage are:"
echo ""
echo "1. Deploy the test class:"
echo "sf project deploy start --source-dir force-app --target-org $ORG_ALIAS"
echo ""
echo "2. Run specific test class with code coverage:"
echo "sf apex run test --class-names QuickBooksComprehensiveTest --code-coverage --wait 10 --target-org $ORG_ALIAS"
echo ""
echo "3. Run all local tests with code coverage:"
echo "sf apex run test --test-level RunLocalTests --code-coverage --wait 10 --target-org $ORG_ALIAS"
echo ""
echo "4. Run tests and output results in human-readable format:"
echo "sf apex run test --class-names QuickBooksComprehensiveTest --code-coverage --result-format human --wait 10 --target-org $ORG_ALIAS"
echo ""
echo "5. Query code coverage information:"
echo "sf data query --query \"SELECT ApexClassOrTrigger.Name, NumLinesCovered, NumLinesUncovered FROM ApexCodeCoverage\" --target-org $ORG_ALIAS --result-format csv"
echo ""
echo "6. Check specific org-wide code coverage:"
echo "sf data query --query \"SELECT PercentCovered FROM ApexOrgWideCoverage\" --target-org $ORG_ALIAS"
echo ""

# Offer to execute the deployment
echo -e "\nWould you like to deploy and run the tests now? (y/n)"
read DEPLOY_NOW

if [[ $DEPLOY_NOW == "y" || $DEPLOY_NOW == "Y" ]]; then
    echo "Deploying test class..."
    sf project deploy start --source-dir force-app --target-org $ORG_ALIAS
    
    echo ""
    echo "Running tests with code coverage..."
    sf apex run test --class-names QuickBooksComprehensiveTest --code-coverage --result-format human --wait 10 --target-org $ORG_ALIAS
    
    echo ""
    echo "Checking org-wide code coverage..."
    sf data query --query "SELECT PercentCovered FROM ApexOrgWideCoverage" --target-org $ORG_ALIAS
fi

echo ""
echo "=== Test Coverage Fix Complete ==="
echo "Use the commands above to verify your test coverage has improved."
