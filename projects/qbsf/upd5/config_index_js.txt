/**
 * Configuration settings for the Salesforce-QuickBooks integration
 */
require('dotenv').config();

const config = {
  server: {
    port: process.env.PORT || 3000,
    env: process.env.NODE_ENV || 'development',
    baseUrl: process.env.MIDDLEWARE_BASE_URL || `http://localhost:${process.env.PORT || 3000}`,
  },
  salesforce: {
    clientId: process.env.SF_CLIENT_ID,
    clientSecret: process.env.SF_CLIENT_SECRET,
    redirectUri: process.env.SF_REDIRECT_URI,
    loginUrl: process.env.SF_LOGIN_URL || 'https://login.salesforce.com',
  },
  quickbooks: {
    clientId: process.env.QB_CLIENT_ID,
    clientSecret: process.env.QB_CLIENT_SECRET,
    redirectUri: process.env.QB_REDIRECT_URI,
    environment: process.env.QB_ENVIRONMENT || 'sandbox',
    discoveryUrl: process.env.QB_ENVIRONMENT === 'production' 
      ? 'https://developer.api.intuit.com/.well-known/openid_configuration'
      : 'https://developer.api.intuit.com/.well-known/openid_sandbox_configuration'
  },
  security: {
    apiKey: process.env.API_KEY,
    tokenEncryptionKey: process.env.TOKEN_ENCRYPTION_KEY,
  },
  scheduler: {
    // Optional: Still supporting scheduled tasks if needed
    invoiceCreationCron: process.env.INVOICE_CREATION_CRON || '0 */2 * * *', // Every 2 hours
    paymentCheckCron: process.env.PAYMENT_CHECK_CRON || '0 1 * * *', // 1:00 AM daily
  },
  logging: {
    level: process.env.LOG_LEVEL || 'info',
    maxFileSize: '10m',
    maxFiles: 5
  }
};

// Validate required configurations
const requiredConfigs = [
  { path: 'salesforce.clientId', name: 'SF_CLIENT_ID' },
  { path: 'salesforce.clientSecret', name: 'SF_CLIENT_SECRET' },
  { path: 'quickbooks.clientId', name: 'QB_CLIENT_ID' },
  { path: 'quickbooks.clientSecret', name: 'QB_CLIENT_SECRET' },
  { path: 'security.apiKey', name: 'API_KEY' }
];

const missingConfigs = [];

requiredConfigs.forEach(({ path, name }) => {
  const value = path.split('.').reduce((obj, key) => obj?.[key], config);
  if (!value) {
    missingConfigs.push(name);
  }
});

if (missingConfigs.length > 0 && config.server.env !== 'test') {
  console.error(`Missing required environment variables: ${missingConfigs.join(', ')}`);
  console.error('Please check your .env file');
  process.exit(1);
}

module.exports = config;