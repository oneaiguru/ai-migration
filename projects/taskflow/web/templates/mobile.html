<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow Mobile</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        padding: 10px;
        margin: 0;
        background-color: #f5f5f5;
    }
    .container {
        max-width: 480px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label {
        display: block;
        margin-top: 10px;
    }
    input, select, button {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
        font-size: 1rem;
        box-sizing: border-box;
    }
    button {
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        margin-top: 15px;
    }
    .preview {
        white-space: pre-wrap;
        background: #f0f0f0;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
        font-size: 0.9em;
    }
    .hidden { display:none; }
    #message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
    }
    #message.success { background-color: #d4edda; color: #155724; }
    #message.error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
  <div class="container">
    <h1>Create Task</h1>
    <label for="templateSelect">Template:</label>
    <select id="templateSelect"></select>
    <form id="taskForm"></form>
    <div id="preview" class="hidden preview"></div>
    <button id="copyBtn">Copy Prompt</button>
    <button id="submitBtn">Save Task</button>
    <div id="message" class="hidden"></div>
  </div>
<script>
const templateSelect = document.getElementById('templateSelect');
const form = document.getElementById('taskForm');
const preview = document.getElementById('preview');
const message = document.getElementById('message');
const copyBtn = document.getElementById('copyBtn');
const submitBtn = document.getElementById('submitBtn');
let templates = {};
const STORAGE_KEY = 'mobile-tasks';

fetch('../../bot/templates.json')
  .then(r => r.ok ? r.json() : Promise.reject('template load failed'))
  .then(data => { templates = data; populateTemplates(); })
  .catch(() => { message.textContent = 'Failed to load templates'; message.className = 'error'; });

function populateTemplates(){
    templateSelect.innerHTML = '<option value="">Select a template</option>';
    Object.keys(templates).forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = templates[k].name;
        templateSelect.appendChild(opt);
    });
}

function createInput(name){
    const wrap = document.createElement('div');
    const label = document.createElement('label');
    label.textContent = name;
    const input = document.createElement('input');
    input.id = name;
    input.required = true;
    wrap.appendChild(label);
    wrap.appendChild(input);
    return wrap;
}

function renderPrompt(key, values){
    let text = templates[key].prompt;
    Object.entries(values).forEach(([k,v]) => {
        const re = new RegExp(`{{${k}}}`, 'g');
        text = text.replace(re, v);
    });
    return text;
}

function updateForm(){
    form.innerHTML = '';
    preview.classList.add('hidden');
    const key = templateSelect.value;
    if(!key) return;
    const prompt = templates[key].prompt;
    const vars = Array.from(new Set(prompt.match(/{{(.*?)}}/g))) || [];
    vars.forEach(v => {
        const name = v.replace(/{{|}}/g,'');
        form.appendChild(createInput(name));
    });
}

function showPreview(){
    const key = templateSelect.value;
    if(!key) return;
    const inputs = form.querySelectorAll('input');
    const values = {};
    inputs.forEach(i => values[i.id] = i.value.trim());
    preview.textContent = renderPrompt(key, values);
    preview.classList.remove('hidden');
}

templateSelect.addEventListener('change', () => { updateForm(); showPreview(); });
form.addEventListener('input', showPreview);

copyBtn.addEventListener('click', () => {
    if(preview.classList.contains('hidden')) return;
    navigator.clipboard.writeText(preview.textContent).then(() => {
        message.textContent = 'Copied!';
        message.className = 'success';
    });
});

function saveLocal(task){
    const tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    tasks.push(task);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
}

function syncTasks(){
    if(!navigator.onLine) return;
    const tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const unsynced = tasks.filter(t => !t.synced);
    if(unsynced.length === 0) return;
    Promise.all(unsynced.map(t =>
        fetch('/api/tasks', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({id: t.id, title: t.prompt})
        }).then(res => res.ok).catch(() => false)
    )).then(responses => {
        const updated = tasks.map((t,i) => {
            if(unsynced[i] && responses[i]) return {...unsynced[i], synced:true};
            return t;
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
    });
}

submitBtn.addEventListener('click', e => {
    e.preventDefault();
    if(!templateSelect.value){ message.textContent = 'Select template'; message.className='error'; return;}
    const inputs = form.querySelectorAll('input');
    for(const input of inputs){ if(!input.value.trim()){ message.textContent='All fields required'; message.className='error'; return; } }
    const values = {};
    inputs.forEach(i => values[i.id] = i.value.trim());
    const task = { id: Date.now().toString(), template: templateSelect.value, params: values, prompt: renderPrompt(templateSelect.value, values), synced:false};
    saveLocal(task);
    showPreview();
    message.textContent='Task saved locally';
    message.className='success';
    form.reset();
    syncTasks();
});

window.addEventListener('online', syncTasks);
document.addEventListener('DOMContentLoaded', syncTasks);
</script>
<script>
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('mobile-sw.js');
}
</script>
</body>
</html>
