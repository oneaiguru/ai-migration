# Preprocessor Improvement Plan (draft)

- Greeting/City: Anchor asks to the first agent turn(s) only; require a question cue so later “город показывают” lines do not flip `asked_city`. Include short “по какому городу/по какому региону ищем?” phrasings. Keep `asked_how_to_address` limited to explicit name requests (`как вас зовут/как к вам обращаться/имя?`), not generic help offers.
- Needs gating: Add an `is_question_like` guard and limit triggers to agent questions such as “сколько штук/сколько колес/комплект нужен/по одной или по паре?”, bare season prompts (“зима/лето/шипы/нешипы?/по сезону?/шипы без шипов?”), and size/radius/profile asks. Exclude customer statements and price/stock mentions (“сколько стоит”) from needs.
- Searches/Closing: Tighten search start/end to real holds (announce “посмотрю/проверю/минутку/секунду” → end on first substantive answer), skip tiny micro-pauses, skip end cues that are just another hold (“еще минутку”), and restrict closing thanks/goodbye detection to the final agent block so mid-call “спасибо за ожидание” is ignored; add a test to ensure mid-call “спасибо за ожидание” does not set `closing.thanks` and bias final-block detection to agent/customer goodbyes.
- Heuristic flags: Require agent speaker and stronger cues for advantages/objection/three_options/reservation (option enumerations, discount/warranty/free/fast, delivery/price handling) while excluding plain stock/price reads; add reservation-specific cues (“забронировать/держу резерв/оставить на ваше имя”), not generic “заказ оформлен”.
- Extraction: Expand size/bolt regexes to catch spaced/hyphenated `205 55 16`, `225/55 R19`, rim `R19` mentions with “диск/литой”, and bolt patterns with spacing/casing (`4 x 98`, `4х98`). Dedup to the first credible size per utterance. Filter quantities to tire/wheel units/asks with nearby unit cues (`штук/комплект/пара/колес`) to avoid phone/order IDs; handle negated seasons (“не зимняя/не летняя”) and all-season mentions (`всесезонка/все сезон`).
- Tests: Add positives for clipped questions and bolt-pattern extraction, negatives ensuring price/stock lines do not set needs/advantages, and keep existing search/greeting windows intact.
